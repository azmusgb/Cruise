<!-- Cruise Hub Itinerary WOW Ultimate v3.0 -->
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0" />
  <meta name="theme-color" content="#0a2e4a" />
  <title>Itinerary · Adventure of the Seas</title>

  <!-- Fonts + Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    /* =========================================================
       RCCL CRUISE HUB — ITINERARY “MARKETING TEAM” EDITION
       Single-file, offline-friendly (localStorage).
       ========================================================= */

    /* ---------- Reset ---------- */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body{
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: #071a2c;
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    a{ color: inherit; text-decoration: none; }
    button, input { font: inherit; }
    button { cursor: pointer; }
    :focus-visible { outline: 3px solid rgba(0,180,230,.55); outline-offset: 2px; border-radius: 12px; }

    /* ---------- Motion + Lighting System (global tokens) ---------- */
    :root{
      /* Brand */
      --navy:#0a2e4a;
      --navy2:#083452;
      --blue:#0f4f76;
      --accent:#00b4e6;
      --gold:#ffd740;
      --gold2:#c6a15b;

      /* Text */
      --text:#0d2236;
      --muted:#5a7a93;

      /* Glass */
      --glass: rgba(255,255,255,.085);
      --glass2: rgba(255,255,255,.12);
      --glass-brd: rgba(255,255,255,.18);

      /* Radii */
      --r12: 12px;
      --r16: 16px;
      --r22: 22px;
      --r28: 28px;

      /* Easing */
      --ease-out: cubic-bezier(.22,.61,.36,1);
      --ease-in: cubic-bezier(.4,0,.9,.4);
      --spring: cubic-bezier(.2,.9,.2,1.05);

      /* Durations */
      --t-fast: 140ms;
      --t-med: 220ms;
      --t-slow: 520ms;

      /* Elevation */
      --e0: 0 0 0 rgba(0,0,0,0);
      --e1: 0 10px 34px rgba(0,0,0,.22);
      --e2: 0 16px 50px rgba(0,0,0,.30);
      --e3: 0 28px 92px rgba(0,0,0,.50);

      /* Light */
      --ring: 0 0 0 3px rgba(0,180,230,.18);
      --edge: 0 0 0 1px rgba(255,255,255,.12) inset;
      --edge-strong: 0 0 0 1px rgba(255,255,255,.18) inset;
      --glow-a: 0 0 0 0 rgba(0,180,230,0);
      --glow-b: 0 0 46px rgba(0,180,230,.22);
      --glow-g: 0 0 46px rgba(255,215,64,.20);

      /* Active Day Theming (overridden by JS per day) */
      --sky1: rgba(0,180,230,.20);
      --sky2: rgba(0,255,210,.08);
      --sky3: rgba(0,0,0,.60);

      /* Safety */
      color-scheme: light dark;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

    /* ---------- Background: Ocean canvas + atmospheric lighting ---------- */
    #ocean {
      position: fixed;
      inset: 0;
      z-index: -3;
    }

    .atmo {
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
      background:
        radial-gradient(ellipse at 50% 18%, var(--sky1), transparent 62%),
        radial-gradient(ellipse at 18% 92%, var(--sky2), transparent 58%),
        radial-gradient(ellipse at 82% 92%, rgba(255,215,64,.10), transparent 58%),
        linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.40));
      transition: background var(--t-slow) var(--ease-out);
    }

    .sparklegrid{
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      opacity: .13;
      mix-blend-mode: screen;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,.55), transparent 35%),
        radial-gradient(circle at 70% 20%, rgba(255,255,255,.35), transparent 32%),
        radial-gradient(circle at 60% 75%, rgba(255,255,255,.28), transparent 35%),
        radial-gradient(circle at 25% 80%, rgba(255,255,255,.26), transparent 32%);
      filter: blur(.2px);
      animation: sparkleDrift 10s var(--ease-out) infinite alternate;
    }
    .no-anim .sparklegrid{ animation: none !important; opacity:.06; }
    .reduced-motion *{ animation: none !important; transition: none !important; }
    .no-anim .ship-sil{ opacity:.055; }
    .no-anim .atmo{ filter: saturate(.95); }

@keyframes sparkleDrift{
      0%{ transform: translate3d(0,0,0) scale(1); }
      100%{ transform: translate3d(0,-14px,0) scale(1.02); }
    }

    /* Parallax ship silhouette */
    .ship-sil{
      position:fixed;
      left:50%;
      bottom:6%;
      transform:translateX(-50%);
      opacity:.075;
      font-size:min(320px, 60vw);
      pointer-events:none;
      z-index:-1;
      filter: blur(.2px);
      will-change: transform;
    }

    /* Confetti canvas overlay */
    #confetti{
      position:fixed;
      inset:0;
      z-index:2000;
      pointer-events:none;
    }

    /* Live announcer (a11y) */
    .sr-live{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      border: 0;
      white-space: nowrap;
    }

    /* ---------- Sail-away overlay ---------- */
    .sailaway{
      position:fixed;
      inset:0;
      z-index:2100;
      pointer-events:none;
      opacity:0;
      transition: opacity var(--t-med) var(--ease-out);
    }
    .sailaway.on{opacity:1}
    .sailaway .layer{
      position:absolute; inset:0;
      background:
        radial-gradient(ellipse at 50% 20%, rgba(0,180,230,.24), transparent 60%),
        linear-gradient(180deg, rgba(7,26,44,.0), rgba(7,26,44,.65));
    }
    .sailaway .horn{
      position:absolute;
      top:18%;
      left:50%;
      transform:translateX(-50%);
      display:inline-flex;
      align-items:center;
      gap:.6rem;
      padding:.62rem 1.05rem;
      border-radius:999px;
      background:rgba(10,46,74,.90);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--e3);
      font-weight:900;
      font-size:.92rem;
      color:rgba(255,255,255,.94);
      letter-spacing: .01em;
    }
    .sailaway .horn i{color:var(--gold)}
    .sailaway .horn .pulse{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 0 rgba(0,180,230,.55);
      animation:pulse 1.1s ease-out infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(0,180,230,.55)}
      100%{box-shadow:0 0 0 18px rgba(0,180,230,0)}
    }
    .sailaway .ship-run{
      position:absolute;
      left:-35%;
      bottom:18%;
      font-size:min(170px, 36vw);
      opacity:.16;
      color:#fff;
      filter: drop-shadow(0 30px 70px rgba(0,0,0,.45));
      animation: sail 2.7s var(--ease-out) forwards;
    }
    @keyframes sail{
      0%{transform: translate3d(0,6px,0)}
      100%{transform: translate3d(160vw,-6px,0)}
    }

    /* ---------- Skip link ---------- */
    .skip{
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 9999;
      transform: translateY(-160%);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(8,89,136,.22);
      color: #0d2236;
      padding: .6rem .85rem;
      border-radius: 999px;
      box-shadow: var(--e2);
      transition: transform var(--t-med) var(--ease-out);
      font-weight: 900;
    }
    .skip:focus{ transform: translateY(0); }

    /* ---------- Header ---------- */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10,46,74,.62);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .header-inner{
      max-width: 1200px;
      margin: 0 auto;
      height: 66px;
      padding: 0 1.15rem;
      display: flex;
      align-items: center;
      gap: .9rem;
      color: rgba(255,255,255,.95);
    }
    .brand{
      display: flex;
      align-items: center;
      gap: .7rem;
      min-width: 0;
    }
    .brand i{ color: var(--gold); }
    .brand-text{ min-width: 0; line-height: 1.05; }
    .brand-title{
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 950;
      letter-spacing: .01em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand-sub{
      font-size: .75rem;
      color: rgba(255,255,255,.62);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .spacer{ flex: 1; }

    .hdr-pill{
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      background: rgba(255,215,64,.12);
      border: 1px solid rgba(255,215,64,.28);
      color: var(--gold);
      padding: .35rem .8rem;
      border-radius: 999px;
      font-weight: 900;
      font-size: .75rem;
      white-space: nowrap;
      box-shadow: 0 0 0 0 rgba(255,215,64,0);
      transition: box-shadow var(--t-med) var(--ease-out), transform var(--t-med) var(--ease-out);
    }
    .hdr-pill.is-live{
      box-shadow: 0 0 0 3px rgba(255,215,64,.14), 0 0 34px rgba(255,215,64,.16);
      transform: translateY(-1px);
    }

    .hdr-iconbtn{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.95);
      display: grid;
      place-items: center;
      transition: transform var(--t-fast) var(--ease-out), background var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out);
    }
    .hdr-iconbtn:hover{ background: rgba(255,255,255,.14); border-color: rgba(0,180,230,.24); }
    .hdr-iconbtn:active{ transform: scale(.98); }

    /* ---------- Drawer nav (focus-trapped modal) ---------- */
    .drawer-backdrop{
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--t-med) var(--ease-out);
    }
    .drawer-backdrop.open{
      opacity: 1;
      pointer-events: auto;
    }
    .drawer{
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: min(92vw, 360px);
      background: rgba(10,46,74,.86);
      border-left: 1px solid rgba(255,255,255,.12);
      box-shadow: -20px 0 80px rgba(0,0,0,.45);
      transform: translateX(20px);
      opacity: 0;
      transition: transform var(--t-med) var(--spring), opacity var(--t-med) var(--ease-out);
      display: flex;
      flex-direction: column;
      padding: 1rem 1rem 1.15rem;
    }
    .drawer-backdrop.open .drawer{
      transform: translateX(0);
      opacity: 1;
    }
    .drawer-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .75rem;
      padding-bottom: .9rem;
      border-bottom: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.95);
    }
    .drawer-head h3{
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 950;
      letter-spacing: .01em;
      font-size: 1.05rem;
    }
    .nav{
      padding: .95rem 0;
      display: grid;
      gap: .55rem;
      overflow: auto;
    }
    .nav a{
      display: flex;
      align-items: center;
      gap: .7rem;
      padding: .7rem .75rem;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      transition: background var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out), transform var(--t-fast) var(--ease-out);
    }
    .nav a:hover{ background: rgba(255,255,255,.10); border-color: rgba(0,180,230,.24); transform: translateY(-1px); }
    .nav a i{ color: var(--gold); width: 18px; text-align: center; }
    .nav a.active{ background: rgba(255,215,64,.12); border-color: var(--gold); }

    .drawer-foot{
      margin-top: auto;
      padding-top: .85rem;
      border-top: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.70);
      font-weight: 800;
      font-size: .78rem;
      display: grid;
      gap: .6rem;
    }
    .drawer-foot .minirow{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .6rem;
    }
    .drawer-foot .minirow strong{ color: rgba(255,255,255,.92); font-weight: 950; }
    .drawer-foot button{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      padding: .5rem .75rem;
      font-weight: 950;
      transition: background var(--t-fast) var(--ease-out), transform var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out);
    }
    .drawer-foot button:hover{ background: rgba(255,255,255,.12); border-color: rgba(0,180,230,.22); }
    .drawer-foot button:active{ transform: translateY(1px); }

    /* ---------- Hero ---------- */
    .hero{
      text-align: center;
      padding: 2.6rem 1.1rem 1.2rem;
      color: rgba(255,255,255,.96);
    }
    .hero h1{
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 950;
      font-size: clamp(2rem, 5vw, 3.15rem);
      letter-spacing: -.02em;
      text-shadow: 0 18px 70px rgba(0,0,0,.45);
    }
    .hero p{
      max-width: 820px;
      margin: .85rem auto 0;
      opacity: .74;
      line-height: 1.6;
      font-weight: 650;
    }
    .hero .hint{
      margin-top: 1.25rem;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: .6rem;
      color: rgba(255,255,255,.72);
      font-weight: 850;
      font-size: .78rem;
    }
    .hint span{
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      padding: .42rem .76rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--edge);
    }
    .hint i{ color: var(--gold); }

    /* Nav controls (A11y alternative to swipe) */
    .day-controls{
      margin-top: 1.1rem;
      display: flex;
      justify-content: center;
      gap: .65rem;
      flex-wrap: wrap;
    }
    .ctlbtn{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.95);
      padding: .55rem .9rem;
      font-weight: 950;
      font-size: .8rem;
      display: inline-flex;
      align-items: center;
      gap: .55rem;
      transition: background var(--t-fast) var(--ease-out), transform var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out), filter var(--t-fast) var(--ease-out);
      user-select: none;
    }
    .ctlbtn:hover{ background: rgba(255,255,255,.14); border-color: rgba(0,180,230,.26); }
    .ctlbtn:active{ transform: translateY(1px); }
    .ctlbtn.primary{
      background: linear-gradient(135deg, rgba(0,180,230,.95), rgba(255,215,64,.92));
      color: rgba(8,28,46,.96);
      border-color: rgba(255,255,255,.18);
    }
    .ctlbtn.primary:hover{ filter: brightness(1.03); }

    /* ---------- Layout ---------- */
    main{
      max-width: 980px;
      margin: 0 auto;
      padding: 1.2rem 1.1rem 6.4rem;
    }

    /* ---------- Timeline spine (gesture surface) ---------- */
    .timeline{
      position: relative;
      display: grid;
      gap: 1.15rem;
      padding-left: 18px;
      touch-action: pan-y; /* reduces horizontal swipe/scroll fights */
    }
    .timeline::before{
      content: '';
      position: absolute;
      left: 10px;
      top: 6px;
      bottom: 6px;
      width: 4px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(0,180,230,.72), rgba(255,215,64,.72));
      opacity: .35;
      filter: blur(.15px);
    }

    /* ---------- Cards ---------- */
    .card{
      position: relative;
      border-radius: var(--r28);
      background: var(--glass);
      border: 1px solid var(--glass-brd);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: var(--e2);
      padding: 1.15rem 1.2rem 1.05rem 1.2rem;
      transform: translateY(18px);
      opacity: 0;
      transition: transform .7s var(--ease-out), opacity .7s var(--ease-out), border-color var(--t-med) var(--ease-out), box-shadow var(--t-med) var(--ease-out), background var(--t-med) var(--ease-out);
      will-change: transform, opacity;
    }
    .card.visible{
      transform: translateY(0);
      opacity: 1;
    }
    .card:hover{
      transform: translateY(-3px) scale(1.01);
      border-color: rgba(0,180,230,.28);
      box-shadow: var(--e3);
    }
    .card::before{
      content: '';
      position: absolute;
      left: -10px;
      top: 18px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(0,180,230,.95);
      box-shadow: 0 0 0 5px rgba(0,180,230,.20), 0 0 36px rgba(0,180,230,.12);
    }

    /* Active Day lighting */
    .card.is-active{
      border-color: rgba(255,215,64,.55);
      box-shadow: var(--e3), 0 0 0 1px rgba(255,215,64,.20) inset, 0 0 40px rgba(255,215,64,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.07));
    }
    .card.is-active::before{
      background: rgba(255,215,64,.96);
      box-shadow: 0 0 0 5px rgba(255,215,64,.18), 0 0 38px rgba(255,215,64,.12);
    }

    /* Today indicator */
    .card.is-today::after{
      content: 'TODAY';
      position: absolute;
      top: 14px;
      right: 14px;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 950;
      font-size: .68rem;
      letter-spacing: .08em;
      padding: .24rem .55rem;
      border-radius: 999px;
      background: rgba(255,215,64,.16);
      border: 1px solid rgba(255,215,64,.40);
      color: rgba(255,215,64,.95);
      box-shadow: 0 0 26px rgba(255,215,64,.10);
    }

    .card-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .9rem;
    }
    .left{
      display: flex;
      align-items: center;
      gap: .75rem;
      min-width: 0;
    }
    .icon{
      width: 44px; height: 44px;
      display: grid; place-items: center;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--e1);
      flex: 0 0 auto;
    }
    .icon i{ color: var(--gold); }
    .titles{ min-width: 0; }
    .titles h2{
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 950;
      letter-spacing: .01em;
      font-size: 1.07rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .titles .subline{
      margin-top: .14rem;
      font-size: .78rem;
      opacity: .62;
      font-weight: 850;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .right{
      display: flex;
      align-items: center;
      gap: .6rem;
      flex: 0 0 auto;
    }
    .tag{
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      padding: .34rem .7rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      font-weight: 900;
      font-size: .74rem;
      opacity: .92;
      white-space: nowrap;
      box-shadow: var(--edge);
    }
    .tag i{ color: rgba(255,215,64,.95); }
    .chev{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.09);
      display: grid; place-items: center;
      transition: transform var(--t-med) var(--ease-out), background var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out);
      box-shadow: var(--edge);
    }
    .card[aria-expanded="true"] .chev{ transform: rotate(180deg); }
    .chev:focus-visible{ outline: 3px solid rgba(0,180,230,.55); outline-offset: 2px; }
    .chev i{ opacity: .92; }

    /* Details */
    .details{
      margin-top: .95rem;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height var(--t-slow) var(--ease-out), opacity var(--t-med) var(--ease-out);
    }
    .card[aria-expanded="true"] .details{
      max-height: 680px;
      opacity: 1;
    }
    .details p{
      opacity: .86;
      font-weight: 650;
      line-height: 1.6;
      font-size: .92rem;
    }

    .meta-grid{
      margin-top: .85rem;
      display: grid;
      gap: .6rem;
    }
    @media (min-width: 720px){
      .meta-grid{ grid-template-columns: 1fr 1fr; }
    }
    .meta{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      padding: .75rem .85rem;
      display: flex;
      align-items: flex-start;
      gap: .6rem;
      box-shadow: var(--edge);
    }
    .meta i{ color: rgba(0,180,230,.95); margin-top: .12rem; }
    .meta strong{ display: block; font-weight: 950; font-size: .82rem; }
    .meta span{ display: block; margin-top: .10rem; opacity: .74; font-weight: 800; font-size: .76rem; line-height: 1.35; }

    /* Tiny sunrise/sunset icon row */
    .sunrow{
      display: inline-flex;
      align-items: center;
      gap: .5rem;
    }
    .sunbadge{
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .18rem .45rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      font-weight: 950;
      font-size: .70rem;
      color: rgba(255,255,255,.92);
    }
    .sunbadge i{ color: rgba(255,215,64,.95); }

    .actions{
      margin-top: .85rem;
      display: flex;
      flex-wrap: wrap;
      gap: .55rem;
    }
    .pillbtn{
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      padding: .55rem .85rem;
      font-weight: 950;
      font-size: .78rem;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      transition: background var(--t-fast) var(--ease-out), transform var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out), filter var(--t-fast) var(--ease-out);
      user-select: none;
      box-shadow: var(--edge);
    }
    .pillbtn:hover{ background: rgba(255,255,255,.14); border-color: rgba(0,180,230,.28); }
    .pillbtn:active{ transform: translateY(1px); }
    .pillbtn.primary{
      background: linear-gradient(135deg, rgba(0,180,230,.95), rgba(255,215,64,.92));
      color: rgba(8,28,46,.96);
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.18) inset, 0 18px 50px rgba(0,0,0,.18);
    }
    .pillbtn.primary:hover{ filter: brightness(1.03); }
    .pillbtn.on{
      background: rgba(0,180,230,.95);
      color: rgba(7,26,44,.98);
      border-color: rgba(0,180,230,.18);
    }
    .pillbtn.danger{
      background: rgba(255,80,80,.14);
      border-color: rgba(255,80,80,.22);
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 16px);
      z-index: 3000;
      background: rgba(10,46,74,.94);
      color: white;
      border: 1px solid rgba(255,255,255,.14);
      padding: .62rem .9rem;
      border-radius: 999px;
      box-shadow: var(--e2);
      display: flex;
      align-items: center;
      gap: .55rem;
      font-weight: 900;
      font-size: .82rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--t-fast) var(--ease-out), transform var(--t-fast) var(--ease-out);
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-2px); }

    /* Back to top */
    .back-to-top{
      position: fixed;
      bottom: 102px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 48px;
      background: var(--accent);
      color: #0a2e4a;
      border: none;
      box-shadow: var(--e2);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 800;
      transition: transform var(--t-fast) var(--ease-out), filter var(--t-fast) var(--ease-out);
    }
    .back-to-top.show{ display: flex; }
    .back-to-top:active{ transform: translateY(1px); }
    .back-to-top:hover{ filter: brightness(1.03); }

    /* Bottom nav for mobile */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 990;
      display: none;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      padding: 8px 12px calc(8px + env(safe-area-inset-bottom));
      background: rgba(241,250,255,.92);
      border-top: 1px solid rgba(8,89,136,.18);
      backdrop-filter: blur(10px);
    }
    .bottom-nav__item{
      min-height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(8,89,136,.14);
      background: rgba(255,255,255,.64);
      color: #1f567c;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: .65rem;
      font-weight: 800;
      transition: background var(--t-fast) var(--ease-out), border-color var(--t-fast) var(--ease-out), transform var(--t-fast) var(--ease-out);
    }
    .bottom-nav__item i{ font-size: .95rem; margin-bottom: 2px; }
    .bottom-nav__item:active{ transform: translateY(1px); }
    .bottom-nav__item.active{ border-color: var(--gold); background: rgba(255,190,92,.22); }
    @media (max-width: 767px){
      body{ padding-bottom: 86px; }
      .bottom-nav{ display: grid; }
    }
  </style>
</head>

<body>
  <a class="skip" href="#main">Skip to itinerary</a>
  <div class="sr-live" id="live" aria-live="polite" aria-atomic="true"></div>

  <canvas id="ocean" aria-hidden="true"></canvas>
  <div class="atmo" aria-hidden="true"></div>
  <div class="sparklegrid" aria-hidden="true"></div>
  <i class="fas fa-ship ship-sil" aria-hidden="true"></i>
  <canvas id="confetti" aria-hidden="true"></canvas>

  <!-- Sail-away overlay -->
  <div class="sailaway" id="sailaway" aria-hidden="true">
    <div class="layer"></div>
    <div class="horn">
      <span class="pulse" aria-hidden="true"></span>
      <i class="fas fa-bullhorn" aria-hidden="true"></i>
      <span>Sail-Away Moment</span>
    </div>
    <i class="fas fa-ship ship-run" aria-hidden="true"></i>
  </div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="brand" title="Cruise Hub">
        <i class="fas fa-crown" aria-hidden="true"></i>
        <div class="brand-text">
          <div class="brand-title">Adventure of the Seas</div>
          <div class="brand-sub">Rahe Family &amp; Friends · Itinerary</div>
        </div>
      </div>
      <div class="spacer"></div>
      <span class="hdr-pill" id="sailPill" aria-label="Sail dates">
        <i class="fas fa-calendar-alt" aria-hidden="true"></i>
        Feb 14–20, 2026
      </span>
      <button class="hdr-iconbtn" id="menuBtn" type="button" aria-label="Open menu" aria-haspopup="dialog" aria-controls="drawerBackdrop">
        <i class="fas fa-bars" aria-hidden="true"></i>
      </button>
    </div>
  </header>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop" role="dialog" aria-modal="true" aria-label="Menu">
    <aside class="drawer" id="drawer" tabindex="-1">
      <div class="drawer-head">
        <h3><i class="fas fa-compass" aria-hidden="true" style="color:var(--gold); margin-right:.45rem;"></i> Cruise Hub</h3>
        <button class="hdr-iconbtn" id="closeDrawerBtn" type="button" aria-label="Close menu">
          <i class="fas fa-xmark" aria-hidden="true"></i>
        </button>
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="index.html"><i class="fas fa-house" aria-hidden="true"></i> Home</a>
        <a href="decks.html"><i class="fas fa-layer-group" aria-hidden="true"></i> Decks</a>
        <a href="itinerary.html" class="active"><i class="fas fa-route" aria-hidden="true"></i> Itinerary</a>
        <a href="dining.html"><i class="fas fa-utensils" aria-hidden="true"></i> Dining</a>
        <a href="tips.html"><i class="fas fa-life-ring" aria-hidden="true"></i> Tips</a>
        <a href="contacts.html"><i class="fas fa-phone" aria-hidden="true"></i> Contacts</a>
        <a href="operations.html"><i class="fas fa-clipboard-check" aria-hidden="true"></i> Operations</a>
      </nav>

      <div class="drawer-foot" aria-label="Quick actions">
        <div class="minirow">
          <strong>Itinerary tools</strong>
          <span style="opacity:.72;">local</span>
        </div>
        <div class="minirow" style="gap:.75rem;">
          <span style="opacity:.82; font-weight:900;">Ambient animations</span>
          <label style="display:inline-flex; align-items:center; gap:.5rem; user-select:none;">
            <input id="animToggle" type="checkbox" style="width:18px; height:18px; accent-color: var(--accent);" />
            <span style="opacity:.86; font-weight:900; font-size:.8rem;">On</span>
          </label>
        </div>
        <button type="button" id="resetBtn"><i class="fas fa-rotate-left" aria-hidden="true"></i> Reset plans</button>
      </div>
    </aside>
  </div>

  <!-- Hero -->
  <section class="hero" aria-label="Itinerary hero">
    <h1>Western Caribbean &amp; Perfect Day</h1>
    <p>
      Tap a day to expand. Swipe left/right <em>on the timeline</em> to jump days.
      Mark excursions as planned — they persist on this device.
    </p>
    <div class="hint" aria-hidden="true">
      <span><i class="fas fa-hand-pointer" aria-hidden="true"></i> Tap to expand</span>
      <span><i class="fas fa-arrows-left-right" aria-hidden="true"></i> Swipe timeline</span>
      <span><i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i> Confetti on “planned”</span>
    </div>
    <div class="day-controls" role="group" aria-label="Day navigation">
      <button class="ctlbtn" id="prevDayBtn" type="button"><i class="fas fa-arrow-left" aria-hidden="true"></i> Previous</button>
      <button class="ctlbtn primary" id="todayBtn" type="button"><i class="fas fa-bullseye" aria-hidden="true"></i> Jump to Today</button>
      <button class="ctlbtn" id="nextDayBtn" type="button">Next <i class="fas fa-arrow-right" aria-hidden="true"></i></button>
    </div>
  </section>

  <main id="main">
    <section class="timeline" id="timeline" aria-label="Cruise itinerary timeline"></section>
    <div style="margin-top:1.25rem; text-align:center; opacity:.68; font-weight:850; font-size:.78rem; color:rgba(255,255,255,.78);">
      Tip: long-press the “Copy day summary” button to share in group chat.
    </div>
  </main>

  <button class="back-to-top" id="backToTop" aria-label="Back to top" type="button">
    <i class="fas fa-arrow-up" aria-hidden="true"></i>
  </button>

  <!-- Bottom nav (mobile) -->
  <nav class="bottom-nav" aria-label="Bottom navigation">
    <a class="bottom-nav__item" href="index.html"><i class="fas fa-house" aria-hidden="true"></i><span>Home</span></a>
    <a class="bottom-nav__item" href="decks.html"><i class="fas fa-layer-group" aria-hidden="true"></i><span>Decks</span></a>
    <a class="bottom-nav__item active" href="itinerary.html"><i class="fas fa-route" aria-hidden="true"></i><span>Route</span></a>
    <a class="bottom-nav__item" href="dining.html"><i class="fas fa-utensils" aria-hidden="true"></i><span>Dining</span></a>
    <button class="bottom-nav__item" id="moreBtn" type="button" aria-label="More"><i class="fas fa-ellipsis" aria-hidden="true"></i><span>More</span></button>
  </nav>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
    (function () {
      'use strict';

      // =========================================================
      // Config (edit these two and everything updates)
      // =========================================================
      const SAIL_START = new Date('2026-02-14T16:00:00Z'); // Explicit UTC // local device time
      const STORAGE_EXCURSIONS = 'rccl.itin.excursions.v2';
      const STORAGE_OPEN_DAY = 'rccl.itin.openDay.v2';
      const STORAGE_ACTIVE_DAY = 'rccl.itin.activeDay.v2';
      const STORAGE_ANIM = 'rccl.itin.anim.v1';

      // Day 6/7 times are reasonable defaults; tweak if RC updates your schedule.
      const ITIN = [
        {
          label: 'Port Canaveral',
          icon: 'fa-ship',
          sub: 'Departure · Sail-Away',
          desc: 'Embarkation day. Check in, board, muster drill, and then the ship slides into vacation mode.',
          lat: 28.4158, lon: -80.6077,
          theme: { sky1:'rgba(0,180,230,.18)', sky2:'rgba(255,215,64,.10)', sky3:'rgba(0,0,0,.55)' },
          arrival: null, depart: '16:00'
        },
        {
          label: 'Sea Day',
          icon: 'fa-water',
          sub: 'Full ship day',
          desc: 'Prime time for shows, pools, specialty dining, and wandering every deck like a curious raccoon.',
          lat: 26.0, lon: -79.0,
          theme: { sky1:'rgba(0,180,230,.20)', sky2:'rgba(0,255,210,.08)', sky3:'rgba(0,0,0,.60)' },
          arrival: null, depart: null
        },
        {
          label: 'Grand Cayman',
          icon: 'fa-umbrella-beach',
          sub: 'Tender port',
          desc: 'Clear water. Big beach energy. Tender timing matters—get off early if you want maximum calm.',
          lat: 19.3133, lon: -81.2546,
          theme: { sky1:'rgba(90,230,255,.18)', sky2:'rgba(255,215,64,.12)', sky3:'rgba(0,0,0,.58)' },
          arrival: '08:00', depart: '16:00'
        },
        {
          label: 'Falmouth, Jamaica',
          icon: 'fa-mountain',
          sub: 'Port day',
          desc: 'History, music, and excursions inland. This is the “do stuff” day, if you want one.',
          lat: 18.4939, lon: -77.6560,
          theme: { sky1:'rgba(0,180,230,.15)', sky2:'rgba(255,140,60,.10)', sky3:'rgba(0,0,0,.62)' },
          arrival: '09:30', depart: '17:00'
        },
        {
          label: 'Sea Day',
          icon: 'fa-water',
          sub: 'Reset & roam',
          desc: 'The quiet power of a sea day: nap, snack, repeat. Also: final shopping and show planning.',
          lat: 24.5, lon: -77.0,
          theme: { sky1:'rgba(0,180,230,.16)', sky2:'rgba(140,120,255,.09)', sky3:'rgba(0,0,0,.62)' },
          arrival: null, depart: null
        },
        {
          label: 'Perfect Day at CocoCay',
          icon: 'fa-sun',
          sub: 'Private island',
          desc: 'Water, sun, and the strange joy of a private island that runs like a theme park with waves.',
          lat: 25.8156, lon: -77.9341,
          theme: { sky1:'rgba(0,180,230,.18)', sky2:'rgba(255,215,64,.14)', sky3:'rgba(0,0,0,.56)' },
          arrival: '07:00', depart: '17:00'
        },
        {
          label: 'Port Canaveral',
          icon: 'fa-anchor',
          sub: 'Return · Disembark',
          desc: 'Final morning. Coffee, photos, double-check the room, and glide off like a professional.',
          lat: 28.4158, lon: -80.6077,
          theme: { sky1:'rgba(0,180,230,.12)', sky2:'rgba(255,215,64,.10)', sky3:'rgba(0,0,0,.66)' },
          arrival: '07:00', depart: null
        }
      ];

      // =========================================================
      // DOM
      // =========================================================
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const timeline = $('#timeline');
      const shipSil = $('.ship-sil');
      const toastEl = $('#toast');
      const liveEl = $('#live');

      const sailawayEl = $('#sailaway');
      const sailPill = $('#sailPill');

      const menuBtn = $('#menuBtn');
      const moreBtn = $('#moreBtn');
      const drawerBackdrop = $('#drawerBackdrop');
      const drawer = $('#drawer');
      const closeDrawerBtn = $('#closeDrawerBtn');
      const resetBtn = $('#resetBtn');
      const animToggle = $('#animToggle');

      const prevDayBtn = $('#prevDayBtn');
      const nextDayBtn = $('#nextDayBtn');
      const todayBtn = $('#todayBtn');

      const backToTopBtn = $('#backToTop');

      if (!timeline || !shipSil || !toastEl || !liveEl) {
        // Defensive: fail soft if embedded incorrectly.
        console.error('Missing required DOM nodes for itinerary.');
        return;
      }

      // =========================================================
      // Preferences
      // =========================================================
      function readAnimEnabled(){
        const v = localStorage.getItem(STORAGE_ANIM);
        if (v === null) return true;
        return v === '1';
      }
      function writeAnimEnabled(on){
        try { localStorage.setItem(STORAGE_ANIM, on ? '1' : '0'); } catch {}
      }
      function applyReducedMotionClass(){
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    document.body.classList.add('reduced-motion');
  } else {
    document.body.classList.remove('reduced-motion');
  }
}

function applyAnimMode(){
        const on = readAnimEnabled();
        document.body.classList.toggle('no-anim', !on);
        if (animToggle) animToggle.checked = on;
        if (on) startOcean(); else stopOcean();
      }

      // =========================================================
      // Storage helpers
      // =========================================================
      const safeJSON = (s, fallback) => { try { return s ? JSON.parse(s) : fallback; } catch { return fallback; } };

      function getExcursions(){
        return safeJSON(localStorage.getItem(STORAGE_EXCURSIONS), {  },150);
});
      }
      function setExcursions(obj){
        try { localStorage.setItem(STORAGE_EXCURSIONS, JSON.stringify(obj || {})); } catch {}
      }

      function readOpenDay(){
        const n = parseInt(localStorage.getItem(STORAGE_OPEN_DAY) || '0', 10);
        return Number.isFinite(n) ? Math.max(0, Math.min(ITIN.length-1, n)) : 0;
      }
      function writeOpenDay(n){
        try { localStorage.setItem(STORAGE_OPEN_DAY, String(n)); } catch {}
      }

      function readActiveDay(){
        const n = parseInt(localStorage.getItem(STORAGE_ACTIVE_DAY) || '', 10);
        if (!Number.isFinite(n)) return null;
        return Math.max(0, Math.min(ITIN.length-1, n));
      }
      function writeActiveDay(n){
        try { localStorage.setItem(STORAGE_ACTIVE_DAY, String(n)); } catch {}
      }

      // Sync across tabs
      window.addEventListener('storage', (e) => {
        if (!e) return;
        if (e.key === STORAGE_EXCURSIONS) {
          renderExcursionButtons();
          toast('Synced plans from another tab.');
        }
        if (e.key === STORAGE_OPEN_DAY) {
          const idx = readOpenDay();
          openDay(idx, false, {announce:false, fromSync:true});
        }
        if (e.key === STORAGE_ACTIVE_DAY) {
          const idx = readActiveDay();
          if (idx != null) setActiveTheme(idx, {announce:false});
        }
      });

      // =========================================================
      // Date/time helpers
      // =========================================================
      const pad2 = (n) => String(n).padStart(2, '0');

      function formatDateShort(d) {
        try {
          return new Intl.DateTimeFormat(undefined, { weekday:'short', month:'short', day:'2-digit' }).format(d);
        } catch {
          return d.toDateString();
        }
      }

      function setTimeOnDate(d, hhmm) {
        if (!hhmm) return null;
        const [hh, mm] = String(hhmm).split(':').map(x => parseInt(x, 10));
        const t = new Date(d);
        if (Number.isFinite(hh)) t.setHours(hh);
        if (Number.isFinite(mm)) t.setMinutes(mm);
        t.setSeconds(0); t.setMilliseconds(0);
        return t;
      }

      function countdownTo(dt) {
        if (!dt) return '—';
        const now = new Date();
        const diff = dt - now;
        if (diff <= 0) return 'Now / passed';
        const mins = Math.floor(diff / 60000);
        const days = Math.floor(mins / (60*24));
        const hours = Math.floor((mins - days*60*24) / 60);
        const m = mins % 60;
        if (days > 0) return `${days}d ${hours}h`;
        if (hours > 0) return `${hours}h ${m}m`;
        return `${m}m`;
      }

      function isSameLocalDay(a, b){
        return a.getFullYear() === b.getFullYear()
          && a.getMonth() === b.getMonth()
          && a.getDate() === b.getDate();
      }

      // =========================================================
      // Sunrise / Sunset (simplified NOAA)
      // =========================================================
      function sunTimes(date, lat, lon) {
        const clampedLat = Math.max(-89.8, Math.min(89.8, Number(lat) || 0));
        const lng = Number(lon) || 0;
        const start = new Date(date.getFullYear(), 0, 0);
        const diff = date - start;
        const oneDay = 1000*60*60*24;
        const N = Math.floor(diff / oneDay);
        const gamma = (2 * Math.PI / 365) * (N - 1 + ((date.getHours() - 12) / 24));
        const eqtime = 229.18 * (0.000075 + 0.001868 * Math.cos(gamma) - 0.032077 * Math.sin(gamma) - 0.014615 * Math.cos(2*gamma) - 0.040849 * Math.sin(2*gamma));
        const decl = 0.006918 - 0.399912 * Math.cos(gamma) + 0.070257 * Math.sin(gamma) - 0.006758 * Math.cos(2*gamma) + 0.000907 * Math.sin(2*gamma) - 0.002697 * Math.cos(3*gamma) + 0.00148  * Math.sin(3*gamma);
        const latRad = clampedLat * (Math.PI/180);
        const zenith = 90.833 * (Math.PI/180);
        const cosH = (Math.cos(zenith) - Math.sin(latRad)*Math.sin(decl)) / (Math.cos(latRad)*Math.cos(decl));
        if (cosH > 1) return { sunrise: '—', sunset: '—' };
        if (cosH < -1) return { sunrise: '—', sunset: '—' };
        const H = Math.acos(cosH);
        const Hdeg = H * (180/Math.PI);
        const tzOffsetMin = -date.getTimezoneOffset();
        const solarNoon = (720 - 4*lng - eqtime + tzOffsetMin);
        const sunriseMin = solarNoon - (Hdeg*4);
        const sunsetMin = solarNoon + (Hdeg*4);

        const toHM = (mins) => {
          let m = Math.round(mins);
          m = (m % (24*60) + (24*60)) % (24*60);
          const hh = Math.floor(m/60);
          const mm = m % 60;
          const hr12 = ((hh + 11) % 12) + 1;
          const ampm = hh >= 12 ? 'PM' : 'AM';
          return `${hr12}:${pad2(mm)} ${ampm}`;
        };
        return { sunrise: toHM(sunriseMin), sunset: toHM(sunsetMin) };
      }

      // =========================================================
      // Toast + announcer
      // =========================================================
      let toastTimer = 0;
      function toast(msg, icon='fa-circle-check') {
        if (!toastEl) return;
        if (toastTimer) window.clearTimeout(toastTimer);
        toastEl.innerHTML = `<i class="fas ${icon}" aria-hidden="true"></i><span>${escapeHTML(String(msg || ''))}</span>`;
        toastEl.classList.add('show');
        toastTimer = window.setTimeout(() => toastEl.classList.remove('show'), 1800);
      }
      function announce(msg){
        if (!liveEl) return;
        liveEl.textContent = String(msg || '');
      }
      function escapeHTML(s){
        return s.replace(/[&<>"']/g, (ch) => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
        }[ch]));
      }

      // =========================================================
      // Confetti (capped, debounced resize)
      // =========================================================
      const confCanvas = $('#confetti');
      const confCtx = confCanvas ? confCanvas.getContext('2d', { alpha:true }) : null;
      let confetti = [];
      let confRAF = 0;

      function debounce(fn, ms){
        let t = 0;
        return function(...args){
          if (t) window.clearTimeout(t);
          t = window.setTimeout(() => fn.apply(this, args), ms);
        };
      }

      function resizeConfetti() {
        if (!confCanvas || !confCtx) return;
        const dpr = Math.min(2, window.devicePixelRatio || 1);
        confCanvas.width = Math.floor(window.innerWidth * dpr);
        confCanvas.height = Math.floor(window.innerHeight * dpr);
        confCanvas.style.width = window.innerWidth + 'px';
        confCanvas.style.height = window.innerHeight + 'px';
        confCtx.setTransform(dpr,0,0,dpr,0,0);
      }
      const onResize = debounce(() => { resizeConfetti(); resizeOcean(); }, 120);
      window.addEventListener('resize', onResize, { passive:true });

      function burstConfetti(x, y, intensity = 120) {
        if (!confCanvas || !confCtx) return;
        if (prefersReducedMotion() || !readAnimEnabled()) return;
        const MAX_PARTICLES = 700;
        const colors = ['#00b4e6', '#ffd740', '#ffffff', '#7de3ff', '#ffe58b'];
        const add = Math.min(intensity, Math.max(0, MAX_PARTICLES - confetti.length));
        if (add <= 0) return;

        for (let i = 0; i < add; i++) {
          confetti.push({
            x, y,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 1.2) * 10,
            g: 0.22 + Math.random() * 0.12,
            r: 2 + Math.random() * 3,
            a: 1,
            rot: Math.random() * Math.PI * 2,
            vr: (Math.random() - 0.5) * 0.25,
            c: colors[(Math.random()*colors.length) | 0]
          });
        }
        if (!confRAF) confRAF = requestAnimationFrame(tickConfetti);
      }

      function tickConfetti() {
        if (!confCanvas || !confCtx) { confRAF = 0; return; }
        const w = window.innerWidth, h = window.innerHeight;
        confCtx.clearRect(0,0,w,h);

        confetti = confetti.filter(p => p.a > 0.02 && p.y < h + 60 && p.x > -80 && p.x < w + 80);
        for (const p of confetti) {
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.a *= 0.985;

          confCtx.save();
          confCtx.globalAlpha = p.a;
          confCtx.translate(p.x, p.y);
          confCtx.rotate(p.rot);
          confCtx.fillStyle = p.c;
          confCtx.fillRect(-p.r, -p.r/2, p.r*2.4, p.r);
          confCtx.restore();
        }

        if (confetti.length) confRAF = requestAnimationFrame(tickConfetti);
        else { confCtx.clearRect(0,0,w,h); confRAF = 0; }
      }

      // =========================================================
      // Sail-away (cooldown replay + time-aware trigger)
      // =========================================================
      let sailLock = false;
      let lastSailAt = 0;

      function sailAwayMoment(force=false) {
        if (!sailawayEl) return;
        const now = Date.now();
        const COOLDOWN_MS = 60_000; // 1 minute
        if (!force) {
          if (sailLock) return;
          if (now - lastSailAt < COOLDOWN_MS) return;
        }
        sailLock = true;
        lastSailAt = now;
        sailawayEl.classList.add('on');
        window.setTimeout(() => { sailawayEl.classList.remove('on'); }, 2800);
        window.setTimeout(() => { sailLock = false; }, 3100);
      }

      // =========================================================
      // Theme application (lighting system hook)
      // =========================================================
      function setActiveTheme(idx, opts={announce:true}) {
        const item = ITIN[idx];
        if (!item || !item.theme) return;

        const root = document.documentElement;
        root.style.setProperty('--sky1', item.theme.sky1 || 'rgba(0,180,230,.20)');
        root.style.setProperty('--sky2', item.theme.sky2 || 'rgba(0,255,210,.08)');
        root.style.setProperty('--sky3', item.theme.sky3 || 'rgba(0,0,0,.60)');

        // Update active card lighting
        $$('.card').forEach(c => c.classList.toggle('is-active', String(c.dataset.day) === String(idx)));

        writeActiveDay(idx);
        if (opts.announce) announce(`Active day set to Day ${idx+1}: ${item.label}.`);
      }

      // =========================================================
      // Rendering
      // =========================================================
      function buildCards() {
        const base = new Date(SAIL_START);
        base.setHours(0,0,0,0);

        const excursions = getExcursions();

        const frag = document.createDocumentFragment();
        for (let i = 0; i < ITIN.length; i++) {
          const d = new Date(base);
          d.setDate(base.getDate() + i);

          const item = ITIN[i];
          const portTag = (item.arrival || item.depart) ? 'PORT DAY' : 'SEA DAY';

          const times = sunTimes(d, item.lat, item.lon);
          const arriveDT = setTimeOnDate(d, item.arrival);
          const departDT = setTimeOnDate(d, item.depart);

          const isPlanned = !!excursions[String(i)];
          const today = new Date();
          const isToday = isSameLocalDay(today, d);

          const article = document.createElement('article');
          article.className = 'card';
          if (isToday) article.classList.add('is-today');
          // NOTE (a11y): Card is not a button because it contains interactive descendants.
          // Expansion is controlled by a dedicated header button.
          article.setAttribute('aria-expanded', 'false');
          article.dataset.day = String(i);

          article.innerHTML = `
            <div class="card-head">
              <div class="left">
                <div class="icon" aria-hidden="true"><i class="fas ${escapeHTML(item.icon)}"></i></div>
                <div class="titles">
                  <h2 id="day-title-${i}">Day ${i+1} · ${escapeHTML(item.label)}</h2>
                  <div class="subline" id="day-sub-${i}">${escapeHTML(formatDateShort(d))} · ${escapeHTML(item.sub || '')}</div>
                </div>
              </div>
              <div class="right">
                <span class="tag"><i class="fas fa-sparkles" aria-hidden="true"></i> ${escapeHTML(portTag)}</span>
                <button class="chev" type="button" data-action="toggle" aria-expanded="false" aria-controls="details-${i}" aria-describedby="day-sub-${i}" aria-label="Toggle details for Day ${i+1}">
                  <i class="fas fa-chevron-down" aria-hidden="true"></i>
                </button>
              </div>
            </div>

            <div class="details" id="details-${i}" role="region" aria-labelledby="day-title-${i}">
              <p>${escapeHTML(item.desc || '')}</p>

              <div class="meta-grid">
                <div class="meta">
                  <i class="fas fa-clock" aria-hidden="true"></i>
                  <div>
                    <strong>Timing</strong>
                    <span>${item.arrival ? `Arrive ${escapeHTML(item.arrival)} · <span data-countdown="arrive" data-day="${i}"></span>` : 'No port arrival'}</span>
                    <span>${item.depart ? `Depart ${escapeHTML(item.depart)} · <span data-countdown="depart" data-day="${i}"></span>` : 'No scheduled departure'}</span>
                  </div>
                </div>

                <div class="meta">
                  <i class="fas fa-sun" aria-hidden="true"></i>
                  <div>
                    <strong>Sun</strong>
                    <span class="sunrow">
                      <span class="sunbadge"><i class="fas fa-sunrise" aria-hidden="true"></i> ${escapeHTML(times.sunrise)}</span>
                      <span class="sunbadge"><i class="fas fa-sunset" aria-hidden="true"></i> ${escapeHTML(times.sunset)}</span>
                    </span>
                    <span style="opacity:.62;">Approximate for location</span>
                  </div>
                </div>
              </div>

              <div class="actions">
                <button class="pillbtn primary" type="button" data-action="jump" aria-label="Set this day as active theme">
                  <i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i> Set as active day
                </button>

                <button class="pillbtn ${isPlanned ? 'on' : ''}" type="button" data-action="excursion" aria-pressed="${isPlanned ? 'true' : 'false'}">
                  <i class="fas fa-flag-checkered" aria-hidden="true"></i> ${isPlanned ? 'Excursion planned' : 'Plan excursion'}
                </button>

                <button class="pillbtn" type="button" data-action="copy">
                  <i class="fas fa-copy" aria-hidden="true"></i> Copy day summary
                </button>
              </div>
            </div>
          `;

          // Cache event data for countdown updates
          article._arriveDT = arriveDT;
          article._departDT = departDT;

          frag.appendChild(article);
        }

        timeline.innerHTML = '';
        timeline.appendChild(frag);
      }

      function renderExcursionButtons(){
        const excursions = getExcursions();
        $$('.card').forEach(card => {
          const day = String(card.dataset.day || '');
          const planned = !!excursions[day];
          const btn = $('[data-action="excursion"]', card);
          if (!btn) return;
          btn.classList.toggle('on', planned);
          btn.setAttribute('aria-pressed', planned ? 'true' : 'false');
          btn.innerHTML = `<i class="fas fa-flag-checkered" aria-hidden="true"></i> ${planned ? 'Excursion planned' : 'Plan excursion'}`;
        });
      }

      // =========================================================
      // Card open/close + keyboard
      // =========================================================
      function openDay(idx, scrollIntoView=true, opts={announce:true, fromSync:false}) {
        idx = Math.max(0, Math.min(ITIN.length-1, idx));

        const cards = $$('.card');
        const target = cards[idx];
        if (!target) return;

        // Close others
        cards.forEach((card, i) => {
          const isTarget = i === idx;
          card.setAttribute('aria-expanded', isTarget ? 'true' : 'false');
          const tbtn = card.querySelector('button[data-action="toggle"]');
          if (tbtn) tbtn.setAttribute('aria-expanded', isTarget ? 'true' : 'false');
        });

        // Persist
        writeOpenDay(idx);

        // Apply “active day” theme immediately if none is set
        if (readActiveDay() == null) setActiveTheme(idx, {announce:false});

        // Sail-away: only when Day 1 is opened and it is near/after sail time
        if (idx === 0) {
          const now = new Date();
          const withinWindow = Math.abs(now - SAIL_START) < 1000 * 60 * 60 * 12; // 12h window
          const alreadySailed = now >= SAIL_START;
          if (alreadySailed || withinWindow) sailAwayMoment(false);
        }

        if (scrollIntoView) {
          target.scrollIntoView({ behavior: prefersReducedMotion() ? 'auto' : 'smooth', block: 'center' });
        }

        // Announce
        if (opts.announce) announce(`Expanded itinerary details for Day ${idx+1}: ${ITIN[idx].label}.`);

        // Update countdowns right away
        updateCountdowns();

        // Ensure focus is stable (keyboard users)
        if (!opts.fromSync) {
          const tbtn = target.querySelector('button[data-action="toggle"]');
          if (tbtn) tbtn.focus({ preventScroll: true });
        }
      }

      function toggleCard(card){
        if (!card) return;
        const expanded = card.getAttribute('aria-expanded') === 'true';
        const idx = parseInt(card.dataset.day || '0', 10);

        const tbtn = card.querySelector('button[data-action="toggle"]');
        if (expanded) {
          card.setAttribute('aria-expanded', 'false');
          if (tbtn) tbtn.setAttribute('aria-expanded', 'false');
          // When closing, clear stored open day so reload doesn't surprise.
          try { localStorage.removeItem(STORAGE_OPEN_DAY); } catch {}
          announce(`Collapsed itinerary details for Day ${idx+1}: ${ITIN[idx].label}.`);
        } else {
          openDay(idx, true);
        }
      }

      function currentOpenIndex(){
        const expanded = $('.card[aria-expanded="true"]');
        if (expanded && expanded.dataset && expanded.dataset.day != null) {
          const n = parseInt(expanded.dataset.day, 10);
          if (Number.isFinite(n)) return n;
        }
        return readOpenDay();
      }

      // Global keyboard day navigation (arrow keys)
      window.addEventListener('keydown', (e) => {
        if (!e) return;

        // If drawer open, let focus trap handle it.
        if (drawerBackdrop && drawerBackdrop.classList.contains('open')) return;

        const key = e.key || '';
        if (key !== 'ArrowLeft' && key !== 'ArrowRight') return;
        if (e.altKey || e.ctrlKey || e.metaKey) return;

        const idx = currentOpenIndex();
        if (key === 'ArrowRight') openDay(Math.min(ITIN.length-1, idx + 1), true);
        else openDay(Math.max(0, idx - 1), true);
      }, { passive:false });

      // =========================================================
      // Card click / action delegation
      // =========================================================
      function onTimelineClick(e){
        const t = e.target;
        const card = t && t.closest ? t.closest('.card') : null;
        if (!card) return;

        const actionBtn = t.closest && t.closest('button[data-action]');
        if (actionBtn) {
          e.stopPropagation();
          const action = actionBtn.getAttribute('data-action');
          const idx = parseInt(card.dataset.day || '0', 10);

          if (action === 'toggle') {
            toggleCard(card);
            return;
          }

          if (action === 'jump') {
            setActiveTheme(idx, {announce:true});
            burstConfetti(window.innerWidth/2, window.innerHeight*0.35, 70);
            toast(`Active day: Day ${idx+1}`, 'fa-wand-magic-sparkles');
            return;
          }

          if (action === 'excursion') {
            const ex = getExcursions();
            const key = String(idx);
            ex[key] = !ex[key];
            setExcursions(ex);
            renderExcursionButtons();

            const rect = actionBtn.getBoundingClientRect();
            burstConfetti(rect.left + rect.width/2, rect.top + rect.height/2, ex[key] ? 160 : 60);
            toast(ex[key] ? 'Planned!' : 'Unplanned', ex[key] ? 'fa-party-horn' : 'fa-circle-minus');
            announce(ex[key] ? `Excursion planned for Day ${idx+1}.` : `Excursion unplanned for Day ${idx+1}.`);
            return;
          }

          if (action === 'copy') {
            copyDaySummary(idx);
            return;
          }
          return;
        }

        // Card body click toggles expansion
        toggleCard(card);
      }
      timeline.addEventListener('click', onTimelineClick);

      // Keyboard activate on card
      timeline.addEventListener('keydown', (e) => {
        const target = e.target;
        // Don't hijack keyboard events on real interactive controls
        if (target && (target.matches('button, a, input, select, textarea') || target.closest('button, a, input, select, textarea'))) return;

        const card = target && target.closest ? target.closest('.card') : null;
        if (!card) return;
        const key = e.key || '';
        if (key === 'Enter' || key === ' ') {
          e.preventDefault();
          toggleCard(card);
        }
      });

      // =========================================================
      // Copy to clipboard
      // =========================================================
      async function copyText(text){
        const s = String(text || '');
        if (!s) return false;

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(s);
            return true;
          }
        } catch {}

        // Fallback (best-effort)
        try {
          const ta = document.createElement('textarea');
          ta.value = s;
          ta.setAttribute('readonly', 'true');
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return !!ok;
        } catch {
          return false;
        }
      }

      function daySummary(idx){
        const base = new Date(SAIL_START);
        base.setHours(0,0,0,0);
        const d = new Date(base);
        d.setDate(base.getDate() + idx);

        const item = ITIN[idx];
        const planned = !!getExcursions()[String(idx)];

        const arrive = item.arrival ? `Arrive ${item.arrival}` : 'No port arrival';
        const depart = item.depart ? `Depart ${item.depart}` : 'No scheduled departure';

        return [
          `Day ${idx+1} · ${item.label} (${formatDateShort(d)})`,
          item.sub ? `${item.sub}` : '',
          `${arrive} · ${depart}`,
          `Planned excursion: ${planned ? 'Yes' : 'No'}`,
          '',
          item.desc || ''
        ].filter(Boolean).join('\n');
      }

      async function copyDaySummary(idx){
        const ok = await copyText(daySummary(idx));
        if (ok) toast('Copied day summary', 'fa-copy');
        else toast('Copy failed (browser restrictions)', 'fa-triangle-exclamation');
      }

      // =========================================================
      // Countdown: refresh every minute + immediately on open
      // =========================================================
      function updateCountdowns(){
        const cards = $$('.card');
        for (const card of cards) {
          const idx = parseInt(card.dataset.day || '0', 10);
          const arriveEl = $(`[data-countdown="arrive"][data-day="${idx}"]`, card);
          const departEl = $(`[data-countdown="depart"][data-day="${idx}"]`, card);

          if (arriveEl && card._arriveDT) arriveEl.textContent = countdownTo(card._arriveDT);
          if (departEl && card._departDT) departEl.textContent = countdownTo(card._departDT);
        }
      }
      function startCountdownTicker(){
        updateCountdowns();
        // align to minute boundary for nicer updates
        const now = new Date();
        const msToNextMinute = (60 - now.getSeconds()) * 1000 + (1000 - now.getMilliseconds());
        window.setTimeout(() => {
          updateCountdowns();
          window.setInterval(updateCountdowns, 60_000);
        }, Math.max(250, Math.min(msToNextMinute, 60_000)));
      }

      // =========================================================
      // Swipe gesture (timeline-only, diagonals ignored)
      // =========================================================
      let touchStartX = 0, touchStartY = 0, touchStartT = 0;

      function onTouchStart(e){
        const t = e.touches && e.touches[0];
        if (!t) return;
        touchStartX = t.clientX;
        touchStartY = t.clientY;
        touchStartT = performance.now();
      }

      function onTouchEnd(e){
        const t = e.changedTouches && e.changedTouches[0];
        if (!t) return;

        const dx = t.clientX - touchStartX;
        const dy = t.clientY - touchStartY;
        const dt = performance.now() - touchStartT;

        const absX = Math.abs(dx);
        const absY = Math.abs(dy);

        // Cancel vertical/diagonal scroll attempts
        if (absY > 50 && absY > absX) return;

        // Require a minimum horizontal distance & reasonable speed
        const MIN = Math.max(70, Math.floor(window.innerWidth * 0.12));
        if (absX < MIN) return;
        if (dt > 900) return;

        const idx = currentOpenIndex();
        if (dx < 0) openDay(Math.min(ITIN.length-1, idx + 1), true);
        else openDay(Math.max(0, idx - 1), true);
      }

      timeline.addEventListener('touchstart', onTouchStart, { passive:true });
      timeline.addEventListener('touchend', onTouchEnd, { passive:true });

      // =========================================================
      // Drawer: open/close + focus trap
      // =========================================================
      const focusableSel = [
        'a[href]',
        'button:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(',');

      let lastFocus = null;

      function openDrawer(){
        if (!drawerBackdrop || !drawer) return;
        if (drawerBackdrop.classList.contains('open')) return;
        lastFocus = document.activeElement;
        drawerBackdrop.classList.add('open');
        // focus first item
        const f = $(focusableSel, drawer) || drawer;
        window.setTimeout(() => f.focus({ preventScroll: true }), 20);
      }

      function closeDrawer(){
        if (!drawerBackdrop || !drawer) return;
        if (!drawerBackdrop.classList.contains('open')) return;
        drawerBackdrop.classList.remove('open');
        // restore focus safely
        const target = (menuBtn && document.contains(menuBtn)) ? menuBtn : lastFocus;
        window.setTimeout(() => {
          if (target && target.focus) target.focus({ preventScroll: true });
        }, 20);
      }

      function trapFocus(e){
        if (!drawerBackdrop || !drawerBackdrop.classList.contains('open')) return;
        if (!e || e.key !== 'Tab') return;

        const focusables = $$(focusableSel, drawer);
        if (!focusables.length) return;

        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        const active = document.activeElement;

        if (e.shiftKey && active === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && active === last) {
          e.preventDefault();
          first.focus();
        }
      }

      function onBackdropClick(e){
        if (!drawerBackdrop) return;
        if (e.target === drawerBackdrop) closeDrawer();
      }

      if (menuBtn) menuBtn.addEventListener('click', openDrawer);
      if (moreBtn) moreBtn.addEventListener('click', openDrawer);
      if (closeDrawerBtn) closeDrawerBtn.addEventListener('click', closeDrawer);
      if (drawerBackdrop) drawerBackdrop.addEventListener('click', onBackdropClick);
      window.addEventListener('keydown', (e) => {
        if (!drawerBackdrop || !drawerBackdrop.classList.contains('open')) return;
        if (e.key === 'Escape') closeDrawer();
      });
      window.addEventListener('keydown', trapFocus, { passive:false });

      // =========================================================
      // Reset tool
      // =========================================================
      function resetPlans(){
        try { localStorage.removeItem(STORAGE_EXCURSIONS); } catch {}
        try { localStorage.removeItem(STORAGE_OPEN_DAY); } catch {}
        try { localStorage.removeItem(STORAGE_ACTIVE_DAY); } catch {}
        try { localStorage.removeItem(STORAGE_ANIM); } catch {}
        renderExcursionButtons();
        setActiveTheme(0, {announce:false});
        openDay(0, true);
        toast('Reset complete', 'fa-rotate-left');
      }
      if (resetBtn) resetBtn.addEventListener('click', () => {
        resetPlans();
        closeDrawer();
      });
      if (animToggle) animToggle.addEventListener('change', () => {
        writeAnimEnabled(!!animToggle.checked);
        applyReducedMotionClass();
      applyAnimMode();
        toast(readAnimEnabled() ? 'Animations on' : 'Animations off', 'fa-wand-magic-sparkles');
      });

      // =========================================================
      // Hero controls
      // =========================================================
      prevDayBtn.addEventListener('click', () => openDay(Math.max(0, currentOpenIndex() - 1), true));
      nextDayBtn.addEventListener('click', () => openDay(Math.min(ITIN.length-1, currentOpenIndex() + 1), true));
      todayBtn.addEventListener('click', () => {
        const idx = computeTodayIndex();
        openDay(idx, true);
        toast(`Jumped to ${idx === 0 ? 'Day 1' : `Day ${idx+1}`}`, 'fa-bullseye');
      });

      // =========================================================
      // Intersection reveal (lazy entrance)
      // =========================================================
      function setupReveal(){
        const cards = $$('.card');
        if (!('IntersectionObserver' in window)) {
          cards.forEach(c => c.classList.add('visible'));
          return;
        }
        const io = new IntersectionObserver((entries) => {
          for (const ent of entries) {
            if (ent.isIntersecting) {
              ent.target.classList.add('visible');
              io.unobserve(ent.target);
            }
          }
        }, { root: null, threshold: 0.12 });
        cards.forEach(c => io.observe(c));
      }

      // =========================================================
      // Back to top
      // =========================================================
      window.addEventListener('scroll', () => {
        backToTopBtn.classList.toggle('show', (window.scrollY || 0) > 700);
      }, { passive:true });
      backToTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: prefersReducedMotion() ? 'auto' : 'smooth' });
      });

      // =========================================================
      // Parallax ship (throttled via rAF)
      // =========================================================
      let parallaxRAF = 0;
      function onScrollParallax(){
        if (parallaxRAF) return;
        parallaxRAF = requestAnimationFrame(() => {
          parallaxRAF = 0;
          const y = window.scrollY || 0;
          shipSil.style.transform = `translateX(-50%) translateY(${y * 0.06}px)`;
        });
      }
      window.addEventListener('scroll', onScrollParallax, { passive:true });

      // =========================================================
      // Ocean animation (paused on hidden)
      // =========================================================
      const ocean = $('#ocean');
      const ctx = ocean ? ocean.getContext('2d', { alpha:true }) : null;
      let oceanT = 0;
      let oceanRAF = 0;
      let oceanRunning = false;

      function prefersReducedMotion(){
        return !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
      }

      function resizeOcean(){
        if (!ocean || !ctx) return;
        const dpr = Math.min(2, window.devicePixelRatio || 1);
        ocean.width = Math.floor(window.innerWidth * dpr);
        ocean.height = Math.floor(window.innerHeight * dpr);
        ocean.style.width = window.innerWidth + 'px';
        ocean.style.height = window.innerHeight + 'px';
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }

      function drawOcean(){
        if (!ocean || !ctx) return;
        const w = window.innerWidth, h = window.innerHeight;
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = '#071a2c';
        ctx.fillRect(0,0,w,h);

        const g = ctx.createLinearGradient(0,0,0,h);
        g.addColorStop(0,'rgba(10,46,74,.10)');
        g.addColorStop(1,'rgba(0,0,0,.28)');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);

        for (let i=0;i<3;i++){
          const amp = 22 + i*12;
          const len = 0.010 - i*0.0018;
          const base = h*(0.48 + i*0.07);
          ctx.beginPath();
          ctx.moveTo(0, base);
          for (let x=0;x<=w;x+=8){
            const y = base + Math.sin(x*len + oceanT*(0.9+i*0.2)) * amp;
            ctx.lineTo(x,y);
          }
          ctx.lineTo(w,h);
          ctx.lineTo(0,h);
          ctx.closePath();
          ctx.fillStyle = `rgba(0,180,230,${0.12 - i*0.03})`;
          ctx.fill();
        }

        oceanT += prefersReducedMotion() ? 0.004 : 0.012;
      }

      function oceanTick(){
        if (!oceanRunning) return;
        drawOcean();
        oceanRAF = requestAnimationFrame(oceanTick);
      }

      function startOcean(){
        if (oceanRunning) return;
        oceanRunning = true;
        oceanRAF = requestAnimationFrame(oceanTick);
      }

      function stopOcean(){
        oceanRunning = false;
        if (oceanRAF) cancelAnimationFrame(oceanRAF);
        oceanRAF = 0;
      }

      document.addEventListener('visibilitychange', () => {
        if (!readAnimEnabled()) return;
        if (document.hidden) stopOcean();
        else startOcean();
      });

      // =========================================================
      // Today index (based on local date)
      // =========================================================
      function computeTodayIndex(){
        const start = new Date(SAIL_START);
        start.setHours(0,0,0,0);
        const now = new Date();
        now.setHours(0,0,0,0);
        const diffDays = Math.floor((now - start) / (24*60*60*1000));
        return Math.max(0, Math.min(ITIN.length-1, diffDays));
      }

      // =========================================================
      // Header pill "live" state if currently sailing week
      // =========================================================
      function updateSailPill(){
        if (!sailPill) return;
        const start = new Date(SAIL_START);
        const end = new Date(SAIL_START);
        end.setDate(end.getDate() + (ITIN.length - 1));
        const now = new Date();
        const live = now >= start && now <= end;
        sailPill.classList.toggle('is-live', live);
      }

      
      // Midnight rollover check (updates TODAY badge without reload)
      function scheduleMidnightUpdate(){
        const now = new Date();
        const next = new Date(now);
        next.setHours(24,0,0,0);
        const ms = next.getTime() - now.getTime();
        setTimeout(() => {
          buildCards();
      scheduleMidnightUpdate();
          scheduleMidnightUpdate();
        }, ms + 1000);
      }

      // =========================================================
      // Init
      // =========================================================
      function init(){
        buildCards();
      scheduleMidnightUpdate();
        setupReveal();

        resizeConfetti();
        resizeOcean();
        applyReducedMotionClass();
      applyAnimMode();

        // Restore theme + open day
        const active = readActiveDay();
        if (active != null) setActiveTheme(active, {announce:false});

        const idx = readOpenDay();
        openDay(idx, false, {announce:false});

        updateSailPill();
        startCountdownTicker();

        // Auto-highlight today's card and gently scroll to it once (first load only)
        const todayIdx = computeTodayIndex();
        const todayCard = $(`.card[data-day="${todayIdx}"]`);
        if (todayCard) {
          // ensure “today” tag stays accurate even after midnight
          // and set an initial visible nudge
          if (!prefersReducedMotion()) {
            window.setTimeout(() => {
              todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 250);
          }
        }

        // Long-press on copy: share sheet (best-effort)
        timeline.addEventListener('pointerdown', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest('button[data-action="copy"]') : null;
          if (!btn) return;
          const card = btn.closest('.card');
          if (!card) return;
          const idx = parseInt(card.dataset.day || '0', 10);

          let fired = false;
          const timer = window.setTimeout(async () => {
            fired = true;
            const text = daySummary(idx);
            if (navigator.share) {
              try { await navigator.share({ text }); toast('Shared', 'fa-share-nodes'); }
              catch { /* ignore */ }
            }
          }, 520);

          const clear = () => window.clearTimeout(timer);
          btn.addEventListener('pointerup', clear, { once:true });
          btn.addEventListener('pointercancel', clear, { once:true });
          btn.addEventListener('pointerleave', clear, { once:true });
        }, { passive:true });
      }

      init();
    })();
  </script>

  <noscript>
    <div style="padding:1rem; text-align:center; background:#ffd740; color:#0d2236; font-weight:900;">
      This itinerary needs JavaScript enabled.
    </div>
  </noscript>
</body>
</html>
