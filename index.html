<!DOCTYPE html>
<html lang="en" class="theme--dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>üö¢ Cruise Companion ‚Äî Mission Control 2.0</title>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
/* ==========================================================================
   Cruise Companion ‚Äî Mission Control 2.0
   Enhanced, immersive, feature-rich UI/UX
   ========================================================================== */

/* ----------------------------- Tokens / Theme ---------------------------- */
:root {
  --bg0: #0a0e1a;
  --bg1: #11172b;
  --surf: rgba(255, 255, 255, 0.07);
  --surf2: rgba(255, 255, 255, 0.10);
  --text: rgba(255, 255, 255, 0.95);
  --muted: rgba(255, 255, 255, 0.75);
  --dim: rgba(255, 255, 255, 0.55);
  --border: rgba(255, 255, 255, 0.15);
  --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
  
  --gradient-primary: linear-gradient(135deg, #7dd3fc, #60a5fa, #a78bfa);
  --gradient-success: linear-gradient(135deg, #a7f3d0, #34d399, #10b981);
  --gradient-warning: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
  --gradient-danger: linear-gradient(135deg, #fb7185, #f43f5e, #e11d48);
  --gradient-ocean: linear-gradient(135deg, #1e40af, #3b82f6, #0ea5e9, #06b6d4);
  
  --a: #7dd3fc;
  --a2: #60a5fa;
  --ok: #a7f3d0;
  --warn: #fbbf24;
  --bad: #fb7185;
  
  --r-sm: .5rem;
  --r-md: 1rem;
  --r-lg: 1.5rem;
  --r-xl: 2rem;
  --r-2xl: 2.5rem;
  
  --s-2: .25rem;
  --s-1: .5rem;
  --s0: 1rem;
  --s1: 1.5rem;
  --s2: 2rem;
  --s3: 3rem;
  
  --z-stars: 0;
  --z-background: 1;
  --z-progress: 80;
  --z-sidebar: 20;
  --z-topbar: 30;
  --z-fab: 60;
  --z-modal: 90;
  
  --t-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
  --t: 250ms cubic-bezier(0.4, 0, 0.2, 1);
  --t-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
  --t-bounce: 500ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
  
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  --mono: ui-monospace, "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", monospace;
  
  --focus: 0 0 0 4px rgba(125, 211, 252, 0.2);
}

@media (prefers-color-scheme: light) {
  :root {
    --bg0: #f0f4ff;
    --bg1: #ffffff;
    --surf: rgba(10, 16, 32, 0.05);
    --surf2: rgba(10, 16, 32, 0.08);
    --text: rgba(10, 16, 32, 0.95);
    --muted: rgba(10, 16, 32, 0.75);
    --dim: rgba(10, 16, 32, 0.55);
    --border: rgba(10, 16, 32, 0.16);
    --shadow: 0 14px 36px rgba(10, 16, 32, 0.16);
    --focus: 0 0 0 4px rgba(96, 165, 250, 0.2);
  }
}

.theme--dark {
  --bg0: #0a0e1a; --bg1: #11172b;
  --surf: rgba(255, 255, 255, 0.07); --surf2: rgba(255, 255, 255, 0.10);
  --text: rgba(255, 255, 255, 0.95); --muted: rgba(255, 255, 255, 0.75); --dim: rgba(255, 255, 255, 0.55);
  --border: rgba(255, 255, 255, 0.15); --shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
  --focus: 0 0 0 4px rgba(125, 211, 252, 0.2);
}
.theme--light {
  --bg0: #f0f4ff; --bg1: #ffffff;
  --surf: rgba(10, 16, 32, 0.05); --surf2: rgba(10, 16, 32, 0.08);
  --text: rgba(10, 16, 32, 0.95); --muted: rgba(10, 16, 32, 0.75); --dim: rgba(10, 16, 32, 0.55);
  --border: rgba(10, 16, 32, 0.16); --shadow: 0 14px 36px rgba(10, 16, 32, 0.16);
  --focus: 0 0 0 4px rgba(96, 165, 250, 0.2);
}

/* ------------------------------- Base ----------------------------------- */
* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; scroll-padding-top: 100px; }
body {
  margin: 0;
  font-family: var(--font);
  color: var(--text);
  background: var(--bg0);
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}
a { color: inherit; text-decoration: none; }
button, input { font: inherit; }
::selection { background: rgba(125, 211, 252, 0.5); color: var(--bg0); }
img { max-width: 100%; height: auto; }

:focus-visible {
  outline: 2px solid var(--a);
  outline-offset: 2px;
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}

/* ------------------------------ Backdrop -------------------------------- */
.stars {
  position: fixed; inset: 0; pointer-events: none; opacity: .6; z-index: var(--z-stars);
  background-image:
    radial-gradient(1px 1px at 10% 20%, rgba(255, 255, 255, .7) 40%, transparent 41%),
    radial-gradient(1px 1px at 40% 70%, rgba(255, 255, 255, .5) 40%, transparent 41%),
    radial-gradient(1px 1px at 90% 35%, rgba(255, 255, 255, .6) 40%, transparent 41%),
    radial-gradient(1px 1px at 72% 82%, rgba(255, 255, 255, .4) 40%, transparent 41%),
    radial-gradient(1px 1px at 22% 88%, rgba(255, 255, 255, .45) 40%, transparent 41%);
  background-size: 520px 520px, 620px 620px, 680px 680px, 740px 740px, 800px 800px;
  animation: drift 28s linear infinite;
  filter: blur(.2px);
}
@keyframes drift { to { transform: translate3d(-60px, 40px, 0); } }

.ocean-waves {
  position: fixed; inset: 0; pointer-events: none; z-index: var(--z-background);
  opacity: 0.15;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(14, 165, 233, 0.2) 0%, transparent 50%),
    radial-gradient(circle at 40% 40%, rgba(96, 165, 250, 0.25) 0%, transparent 50%);
  animation: pulse 20s ease-in-out infinite alternate;
}
@keyframes pulse {
  0% { opacity: 0.1; transform: scale(1); }
  100% { opacity: 0.2; transform: scale(1.05); }
}

/* ---------------------------- Progress Bar ------------------------------ */
.progress {
  position: fixed; top: 0; left: 0; height: 4px; width: 0%;
  background: var(--gradient-primary);
  z-index: var(--z-progress);
  box-shadow: 0 0 20px rgba(125, 211, 252, 0.5);
  transition: width var(--t-fast);
  border-radius: 0 0 2px 0;
}

/* ------------------------------ Layout ---------------------------------- */
.app {
  display: grid;
  grid-template-columns: minmax(300px, 360px) 1fr;
  min-height: 100vh;
  position: relative;
}
@media (max-width: 1100px) {
  .app { grid-template-columns: 1fr; }
}

/* ------------------------------ Sidebar --------------------------------- */
.sidebar {
  position: sticky; top: 0; height: 100vh; overflow: auto;
  padding: var(--s1) var(--s0);
  border-right: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), transparent 46%);
  backdrop-filter: blur(20px);
  z-index: var(--z-sidebar);
  display: flex; flex-direction: column; gap: var(--s1);
}
@media (max-width: 1100px) {
  .sidebar { position: relative; height: auto; max-height: none; border-right: 0; border-bottom: 1px solid var(--border); }
}
.sidebar__header {
  display: flex; gap: var(--s0); align-items: center;
  padding: var(--s0);
  border-radius: var(--r-xl);
  border: 1px solid var(--border);
  background: var(--surf);
  box-shadow: var(--shadow);
  position: relative; overflow: hidden;
}
.sidebar__header::before {
  content: ""; position: absolute; inset: -1px;
  background:
    radial-gradient(500px 180px at 25% 0%, rgba(255, 255, 255, .2), transparent 55%),
    radial-gradient(500px 180px at 80% 30%, rgba(255, 255, 255, .15), transparent 55%);
  pointer-events: none;
}
.logo {
  width: 56px; height: 56px; border-radius: var(--r-lg);
  border: 1px solid var(--border);
  background:
    radial-gradient(circle at 30% 25%, rgba(125, 211, 252, 0.95), rgba(96, 165, 250, 0.6) 55%, transparent 72%),
    radial-gradient(circle at 68% 75%, rgba(167, 243, 208, 0.9), rgba(52, 211, 153, 0.5) 58%, transparent 75%),
    rgba(255, 255, 255, 0.08);
  position: relative; overflow: hidden; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem;
}
.logo::after {
  content: ""; position: absolute; inset: -45%;
  background: conic-gradient(from 180deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, .25), rgba(255, 255, 255, 0));
  animation: spin 9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.sidebar__title { font-size: 1rem; font-weight: 800; letter-spacing: .2px; position: relative; z-index: 1; }
.sidebar__subtitle { margin-top: 4px; font-size: .85rem; color: var(--muted); position: relative; z-index: 1; line-height: 1.25; }

.sidebar__section {
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: var(--surf);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.sidebar__section-header {
  padding: var(--s0) var(--s1);
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .04));
  display: flex; align-items: center; justify-content: space-between; gap: var(--s-1);
}
.sidebar__section-header h2 {
  margin: 0;
  font-size: .8rem; text-transform: uppercase; letter-spacing: .2px;
  color: var(--muted);
  font-weight: 700;
}
.sidebar__section-body { padding: var(--s1); }

/* ------------------------------- Search --------------------------------- */
.search {
  display: flex; align-items: center; gap: var(--s-1);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: var(--s0);
  background: rgba(255, 255, 255, 0.06);
  transition: border-color var(--t-fast), box-shadow var(--t-fast);
}
.search:focus-within { border-color: var(--a); box-shadow: 0 0 0 3px rgba(125, 211, 252, 0.1); }
.search__icon { color: var(--muted); flex-shrink: 0; }
.search__input {
  width: 100%; border: 0; outline: 0; background: transparent;
  color: var(--text); font-size: .95rem;
}
.search__input::placeholder { color: var(--dim); }

.search-meta {
  display: flex; gap: var(--s-1); align-items: center; justify-content: space-between;
  margin-top: var(--s0);
  color: var(--muted);
  font-size: .85rem;
}
.pill {
  display: inline-flex; gap: 6px; align-items: center;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.05);
  font-size: .85rem;
  transition: all var(--t-fast);
}
.pill:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-1px); }
kbd {
  font-family: var(--mono);
  font-size: .75rem;
  color: var(--muted);
  border: 1px solid var(--border);
  border-bottom-color: rgba(255, 255, 255, .25);
  padding: 6px 10px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.05);
}

/* ------------------------------ Buttons --------------------------------- */
.button-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--s-1); margin-top: var(--s0); }
.button {
  display: flex; align-items: center; justify-content: center; gap: var(--s-1);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.06);
  color: var(--text);
  font-size: .95rem;
  cursor: pointer;
  user-select: none;
  transition: all var(--t);
  font-weight: 600;
}
.button:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
.button:active { transform: translateY(0); }
.button__icon { font-family: var(--mono); font-size: .85rem; color: var(--muted); }
.button--primary { 
  border-color: rgba(125, 211, 252, .4); 
  background: linear-gradient(135deg, rgba(125, 211, 252, 0.2), rgba(96, 165, 250, 0.1));
  box-shadow: 0 0 0 4px rgba(125, 211, 252, 0.1);
  position: relative; overflow: hidden;
}
.button--primary::before {
  content: ""; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(125, 211, 252, 0.3), transparent);
  opacity: 0;
  transition: opacity var(--t);
}
.button--primary:hover::before { opacity: 1; }

/* ------------------------------- Filters -------------------------------- */
.filters { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--s-1); }
.filter {
  display: flex; align-items: center; gap: var(--s-1);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 12px;
  background: rgba(255, 255, 255, 0.04);
  font-size: .95rem;
  color: var(--muted);
  cursor: pointer; user-select: none;
  transition: all var(--t-fast);
}
.filter:hover { background: rgba(255, 255, 255, 0.07); }
.filter input { width: 18px; height: 18px; accent-color: var(--a); flex-shrink: 0; }
.filter__label { color: var(--text); font-weight: 650; }

.toggle {
  display: flex; align-items: center; gap: var(--s-1);
  margin-top: var(--s0);
  cursor: pointer; user-select: none;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  background: rgba(255, 255, 255, 0.04);
  transition: all var(--t-fast);
}
.toggle:hover { background: rgba(255, 255, 255, 0.07); }
.toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
.toggle__slider {
  position: relative; width: 48px; height: 26px;
  background: var(--surf2);
  border-radius: 13px;
  transition: background var(--t-fast);
  flex-shrink: 0;
}
.toggle__slider::before {
  content: ""; position: absolute; width: 22px; height: 22px;
  left: 2px; top: 2px; background: var(--text);
  border-radius: 999px;
  transition: transform var(--t-fast);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}
.toggle input:checked + .toggle__slider { background: var(--a); }
.toggle input:checked + .toggle__slider::before { transform: translateX(22px); }
.toggle__label { color: var(--text); font-weight: 650; font-size: .95rem; }

/* ------------------------------- TOC ------------------------------------ */
.toc { list-style: none; margin: 0; padding: 0; display: grid; gap: 8px; }
.toc__item {
  border: 1px solid transparent;
  border-radius: var(--r-lg);
  transition: all var(--t-fast);
}
.toc__item:hover { background: rgba(255, 255, 255, 0.08); border-color: var(--border); transform: translateX(4px); }
.toc__link {
  display: flex; gap: var(--s-1);
  padding: 12px 14px;
  text-decoration: none;
  align-items: flex-start;
}
.toc__num {
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--mono);
  font-size: .8rem; font-weight: 700;
  color: var(--dim);
  background: rgba(255, 255, 255, 0.05);
  border-radius: var(--r-sm);
  flex-shrink: 0;
  padding-top: 2px;
}
.toc__content { min-width: 0; flex: 1; }
.toc__title { font-size: .95rem; line-height: 1.25; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.toc__meta { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; color: var(--muted); font-size: .8rem; }

/* ------------------------------- Main ----------------------------------- */
.main { padding: var(--s2) var(--s1); position: relative; }
@media (max-width: 1100px) { .main { padding: var(--s1); } }

/* ------------------------------ Topbar ---------------------------------- */
.topbar {
  position: sticky; top: 0; z-index: var(--z-topbar);
  max-width: 1200px; margin: 0 auto;
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(20px);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: var(--s2);
}
.topbar__inner {
  padding: var(--s0) var(--s1);
  display: flex; gap: var(--s0);
  align-items: center; justify-content: space-between;
  flex-wrap: wrap;
}
.chips { display: flex; gap: var(--s0); align-items: center; flex-wrap: wrap; }
.chip {
  display: inline-flex; gap: 10px; align-items: center;
  padding: 12px 16px;
  border-radius: var(--r-lg);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  color: var(--muted);
  font-size: .95rem;
  transition: all var(--t-fast);
}
.chip:hover { background: rgba(255, 255, 255, 0.09); transform: translateY(-1px); }
.chip strong { color: var(--text); font-weight: 700; }
.chip .mono { font-family: var(--mono); color: var(--text); }
.topbar__actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

.daystrip {
  display: flex; gap: 8px; overflow: auto;
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.04));
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}
.daystrip::-webkit-scrollbar { height: 8px; }
.daystrip::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.daychip {
  flex: 0 0 auto;
  min-width: 180px;
  text-align: left;
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  padding: 12px 14px;
  background: rgba(255, 255, 255, 0.05);
  cursor: pointer;
  transition: all var(--t);
}
.daychip:hover { background: rgba(255, 255, 255, 0.09); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
.daychip:active { transform: translateY(0); }
.daychip--today { border-color: rgba(125, 211, 252, .5); background: linear-gradient(135deg, rgba(125, 211, 252, 0.15), rgba(96, 165, 250, 0.05)); box-shadow: var(--focus); }
.daychip__day { font-size: .8rem; color: var(--muted); }
.daychip__label { margin-top: 4px; font-size: .95rem; color: var(--text); font-weight: 700; }

/* ------------------------------- Hero ----------------------------------- */
.hero {
  max-width: 1200px;
  margin: 0 auto var(--s2);
  border: 1px solid var(--border);
  border-radius: 30px;
  background:
    radial-gradient(1000px 400px at 20% 0%, rgba(255, 255, 255, .2), transparent 60%),
    radial-gradient(1000px 400px at 78% 25%, rgba(255, 255, 255, .15), transparent 62%),
    linear-gradient(135deg, rgba(125, 211, 252, .2), rgba(167, 243, 208, .15) 42%, rgba(255, 255, 255, .08) 72%),
    rgba(255, 255, 255, .06);
  box-shadow: var(--shadow);
  overflow: hidden;
  position: relative;
}
.hero::after {
  content: ""; position: absolute; inset: -2px;
  background:
    radial-gradient(800px 300px at 30% 20%, rgba(125, 211, 252, .15), transparent 60%),
    radial-gradient(850px 320px at 80% 60%, rgba(167, 243, 208, .15), transparent 60%);
  pointer-events: none;
}
.hero__content {
  position: relative; z-index: 1;
  padding: var(--s2) var(--s1);
  display: grid;
  grid-template-columns: 1.2fr .8fr;
  gap: var(--s1);
}
@media (max-width: 1100px) { .hero__content { grid-template-columns: 1fr; } }
.hero__title { margin: 0; font-size: clamp(1.5rem, 2.5vw, 2rem); letter-spacing: .3px; font-weight: 800; line-height: 1.2; }
.hero__desc { margin-top: 12px; color: var(--muted); font-size: 1.05rem; line-height: 1.5; }
.hero__badges { display: flex; flex-wrap: wrap; gap: 10px; margin-top: var(--s1); }
.badge {
  display: inline-flex; gap: 10px; align-items: center;
  padding: 12px 14px;
  border-radius: var(--r-lg);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  color: var(--muted);
  font-size: .95rem;
  transition: all var(--t-fast);
}
.badge:hover { background: rgba(255, 255, 255, 0.09); transform: translateY(-1px); }
.badge strong { color: var(--text); font-weight: 700; }
.hero__art {
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: rgba(255, 255, 255, 0.06);
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06);
  overflow: hidden;
  min-height: 280px;
  display: grid;
  place-items: center;
  position: relative;
}
.hero__art::before {
  content: ""; position: absolute; inset: -30%;
  background: conic-gradient(from 180deg, rgba(125, 211, 252, 0), rgba(125, 211, 252, .15), rgba(167, 243, 208, .15), rgba(125, 211, 252, 0));
  animation: spin 18s linear infinite;
  opacity: .6;
}
.hero__art svg { position: relative; z-index: 1; width: 92%; height: auto; opacity: .95; }

/* ----------------------------- Dashboard -------------------------------- */
.dashboard {
  max-width: 1200px; margin: 0 auto var(--s2);
  display: grid;
  grid-template-columns: 1.05fr .95fr;
  gap: var(--s1);
}
@media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr; } }

.panel {
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: rgba(255, 255, 255, 0.06);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.panel__header {
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
}
.panel__title { margin: 0; font-size: 1.05rem; letter-spacing: .2px; font-weight: 700; }
.panel__sub { font-size: .85rem; color: var(--muted); }
.panel__body { padding: 18px; }

.kpi {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
@media (max-width: 520px) { .kpi { grid-template-columns: 1fr; } }
.kpi__box {
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 16px;
  background: rgba(255, 255, 255, 0.05);
  transition: all var(--t-fast);
}
.kpi__box:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-2px); }
.kpi__label { font-size: .85rem; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
.kpi__value { font-family: var(--mono); font-size: 1rem; color: var(--text); line-height: 1.35; white-space: pre-line; font-weight: 700; }

.table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  overflow: hidden;
  background: rgba(255, 255, 255, 0.04);
}
.table th, .table td {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  font-size: .95rem;
  vertical-align: top;
}
.table th {
  font-size: .8rem;
  text-transform: uppercase;
  letter-spacing: .2px;
  color: var(--muted);
  background: rgba(255, 255, 255, 0.06);
  text-align: left;
  font-weight: 700;
}
.table tr:last-child td { border-bottom: 0; }
.table__row--today td { background: rgba(125, 211, 252, 0.12); }

/* ------------------------------ Chapters -------------------------------- */
.chapters {
  max-width: 1200px; margin: 0 auto;
  display: grid; gap: var(--s1);
}
.chapter {
  border: 1px solid var(--border);
  border-radius: 30px;
  background: rgba(255, 255, 255, 0.06);
  box-shadow: var(--shadow);
  overflow: hidden;
  transform: translateZ(0);
  transition: all var(--t);
}
.chapter:hover { box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3); }
.chapter__header {
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
  display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; flex-wrap: wrap;
}
.chapter__left {
  display: flex; gap: 12px; align-items: center; min-width: 0; flex: 1;
}
.chapter__num {
  width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  font-family: var(--mono);
  font-size: .85rem; font-weight: 700;
  color: var(--muted);
  flex-shrink: 0;
}
.chapter__title {
  margin: 0;
  font-size: 1.1rem;
  letter-spacing: .2px;
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.chapter__right {
  display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
}
.progress-chip {
  display: inline-flex; align-items: center; gap: 10px;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  color: var(--muted);
  font-size: .9rem;
  transition: all var(--t-fast);
}
.progress-chip:hover { background: rgba(255, 255, 255, 0.09); }
.progress-chip b { color: var(--text); }
.icon-btn {
  display: inline-flex; align-items: center; justify-content: center;
  width: 40px; height: 40px;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  cursor: pointer;
  transition: all var(--t);
}
.icon-btn:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); }
.icon-btn:active { transform: translateY(0); }
.icon-btn svg { width: 20px; height: 20px; opacity: .9; }
.chapter__body { padding: 18px 18px 22px; }

.section {
  margin-top: 16px;
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: rgba(255, 255, 255, 0.05);
  overflow: hidden;
}
.section summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
  padding: 14px 16px;
  display: flex; align-items: center; justify-content: space-between; gap: 10px;
  transition: all var(--t-fast);
}
.section summary:hover { background: rgba(255, 255, 255, 0.03); }
.section summary::-webkit-details-marker { display: none; }
.section summary .left {
  display: flex; gap: 10px; align-items: center; min-width: 0; flex: 1;
}
.section summary .title {
  font-weight: 700; color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.section summary .meta {
  font-size: .85rem; color: var(--muted);
  display: flex; gap: 10px; flex-wrap: wrap;
}
.section summary .chev {
  transition: transform var(--t);
  opacity: .9;
}
.section[open] summary .chev { transform: rotate(180deg); }
.section__body { padding: 16px 16px 20px; border-top: 1px solid var(--border); }

.p {
  margin: 12px 0;
  color: var(--text);
  font-size: 1rem;
  line-height: 1.6;
}
.h {
  margin: 18px 0 12px;
  font-size: 1.1rem;
  letter-spacing: .15px;
  font-weight: 700;
}
.kv {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 12px;
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  background: rgba(255, 255, 255, 0.05);
  margin: 12px 0;
  transition: all var(--t-fast);
}
.kv:hover { background: rgba(255, 255, 255, 0.07); }
@media (max-width: 1100px) { .kv { grid-template-columns: 1fr; } }
.kv .k { font-family: var(--mono); font-size: .85rem; color: var(--muted); font-weight: 600; }
.kv .v { color: var(--text); font-size: .95rem; line-height: 1.5; }

ul.list { margin: 12px 0 0 24px; }
ul.list li { margin: 8px 0; font-size: 1rem; line-height: 1.6; padding-left: 8px; }

/* ------------------------------- Tasks ---------------------------------- */
.task {
  display: flex; gap: 12px; align-items: flex-start;
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 16px;
  background: rgba(255, 255, 255, 0.05);
  margin: 12px 0;
  transition: all var(--t);
}
.task:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-2px); }
.task--crit { border-color: rgba(251, 113, 133, .4); background: rgba(251, 113, 133, 0.05); }
.task--warn { border-color: rgba(251, 191, 36, .4); background: rgba(251, 191, 36, 0.05); }
.task--ok { border-color: rgba(52, 211, 153, .35); background: rgba(52, 211, 153, 0.05); }
.task--info { border-color: rgba(96, 165, 250, .35); background: rgba(96, 165, 250, 0.05); }
.task__check {
  width: 20px; height: 20px; margin-top: 2px;
  accent-color: var(--a);
  flex-shrink: 0;
  cursor: pointer;
}
.task__emoji { font-size: 1.1rem; line-height: 1; margin-top: 2px; flex-shrink: 0; }
.task__text { font-size: 1rem; line-height: 1.5; flex: 1; }
.task__text strong { font-weight: 800; }

.task--done {
  opacity: .7;
  background: rgba(255, 255, 255, 0.03);
}
.task--done .task__text { color: var(--muted); text-decoration: line-through; text-decoration-thickness: 1px; }

/* ----------------------------- Search Highlight ------------------------- */
mark.hit {
  background: rgba(251, 191, 36, .4);
  color: inherit;
  padding: 0 4px;
  border-radius: 6px;
  animation: highlight-pulse 1s ease;
}
@keyframes highlight-pulse {
  0% { background-color: rgba(251, 191, 36, .2); }
  50% { background-color: rgba(251, 191, 36, .6); }
  100% { background-color: rgba(251, 191, 36, .4); }
}

/* ------------------------------ Footer ---------------------------------- */
.footer {
  max-width: 1200px; margin: var(--s2) auto 0;
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: rgba(255, 255, 255, 0.05);
  padding: 18px 20px;
  color: var(--muted);
  box-shadow: var(--shadow);
  text-align: center;
  font-size: .95rem;
}
.footer b { color: var(--text); font-weight: 700; }

/* -------------------------- Floating Action Buttons --------------------- */
.fab {
  position: fixed; right: 20px; bottom: 20px;
  display: grid; gap: 12px;
  z-index: var(--z-fab);
}
.fab__btn {
  width: 52px; height: 52px;
  border-radius: var(--r-lg);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.08);
  color: var(--text);
  cursor: pointer;
  box-shadow: var(--shadow);
  backdrop-filter: blur(20px);
  transition: all var(--t);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
}
.fab__btn:hover { background: rgba(255, 255, 255, 0.12); transform: translateY(-3px) scale(1.05); }
.fab__btn:active { transform: translateY(0) scale(1); }

/* ---------------------------- Command Palette --------------------------- */
.palette {
  position: fixed; inset: 0;
  background: rgba(0, 0, 0, .7);
  display: none;
  align-items: flex-start;
  justify-content: center;
  padding: 100px 16px 16px;
  z-index: var(--z-modal);
  backdrop-filter: blur(10px);
  animation: fadeIn var(--t-fast);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.palette[aria-hidden="false"] { display: flex; }
.palette__content {
  width: min(800px, 100%);
  border: 1px solid var(--border);
  border-radius: var(--r-xl);
  background: rgba(255, 255, 255, 0.08);
  box-shadow: var(--shadow);
  overflow: hidden;
  animation: slideUp var(--t-slow) cubic-bezier(0.4, 0, 0.2, 1);
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.palette__header {
  padding: 12px 14px;
  border-bottom: 1px solid var(--border);
  display: flex; gap: 12px; align-items: center;
  background: linear-gradient(180deg, rgba(255, 255, 255, .1), rgba(255, 255, 255, .05));
}
.palette__icon {
  width: 36px; height: 36px; border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-family: var(--mono);
  font-weight: 700;
}
.palette__input {
  width: 100%;
  border: 0; outline: 0;
  background: transparent;
  color: var(--text);
  font-size: 1.1rem;
  padding: 12px 10px;
}
.palette__input::placeholder { color: var(--dim); }
.palette__list { max-height: 60vh; overflow: auto; padding: 8px; list-style: none; margin: 0; }

.cmd {
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  padding: 12px 14px;
  border-radius: var(--r-lg);
  border: 1px solid transparent;
  cursor: pointer;
  transition: all var(--t-fast);
}
.cmd:hover, .cmd[aria-selected="true"] {
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--border);
}
.cmd__left { display: flex; gap: 12px; align-items: flex-start; min-width: 0; flex: 1; }
.cmd__ic {
  width: 36px; height: 36px;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.06);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-size: 1rem;
}
.cmd__text { min-width: 0; }
.cmd__title { font-size: 1rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cmd__sub { font-size: .85rem; color: var(--muted); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cmd__kbd { font-family: var(--mono); font-size: .8rem; color: var(--muted); border: 1px solid var(--border); padding: 6px 10px; border-radius: 10px; background: rgba(255, 255, 255, 0.06); }

/* ------------------------------ Toast ----------------------------------- */
.toast {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 20px;
  z-index: var(--z-modal);
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 12px 16px;
  box-shadow: var(--shadow);
  color: var(--text);
  display: none;
  gap: 10px;
  align-items: center;
  backdrop-filter: blur(20px);
  animation: toastSlideUp var(--t-bounce);
}
@keyframes toastSlideUp {
  0% { transform: translateX(-50%) translateY(20px); opacity: 0; }
  70% { transform: translateX(-50%) translateY(-5px); opacity: 1; }
  100% { transform: translateX(-50%) translateY(0); opacity: 1; }
}
.toast[aria-hidden="false"] { display: flex; }

/* ------------------------------ Print ----------------------------------- */
@media print {
  .stars, .ocean-waves, .progress, .sidebar, .topbar, .fab, .palette, .toast { display: none !important; }
  .app { grid-template-columns: 1fr !important; }
  body { background: #fff !important; color: #111 !important; }
  .hero, .panel, .chapter { box-shadow: none !important; border: 1px solid #ddd !important; }
  mark.hit { background: none !important; }
}

/* -------------------------- Loading Animation --------------------------- */
.loading {
  position: fixed;
  inset: 0;
  background: var(--bg0);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity var(--t-slow), visibility var(--t-slow);
}
.loading.hidden {
  opacity: 0;
  visibility: hidden;
}
.loading-spinner {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 4px solid transparent;
  border-top-color: var(--a);
  border-right-color: var(--a);
  animation: spinner 1s linear infinite;
}
@keyframes spinner {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* --------------------------- Confetti Effect ---------------------------- */
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  background: var(--gradient-primary);
  top: -20px;
  z-index: 1000;
  opacity: 0;
}

/* Utility */
.sr { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
.glow-text { text-shadow: 0 0 20px rgba(125, 211, 252, 0.5); }
.text-gradient { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.pulse { animation: pulse 2s infinite; }
  
/* iPhone safe-area polish */
:root { --safe-top: env(safe-area-inset-top); --safe-right: env(safe-area-inset-right); --safe-bottom: env(safe-area-inset-bottom); --safe-left: env(safe-area-inset-left); }
body { padding-left: var(--safe-left); padding-right: var(--safe-right); }
.topbar { padding-top: calc(var(--safe-top) + 10px); }
.fab { bottom: calc(18px + var(--safe-bottom)); }
.palette__card { margin-bottom: calc(12px + var(--safe-bottom)); }
@media (max-width: 430px){
  .topbar__chips { gap: 8px; }
  .chip { max-width: 100%; }
  .chip .mono { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
}
</style>
</head>

<body>
  <!-- Loading Screen -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Background Elements -->
  <div class="stars" aria-hidden="true"></div>
  <div class="ocean-waves" aria-hidden="true"></div>
  <div class="progress" id="progress"></div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <header class="sidebar__header">
        <div class="logo" aria-hidden="true">üö¢</div>
        <div>
          <div class="sidebar__title text-gradient">Family & Friends Cruise Companion</div>
          <div class="sidebar__subtitle">Mission Control 2.0 ¬∑ Enhanced & Immersive</div>
        </div>
      </header>

      <section class="sidebar__section" aria-labelledby="search-section">
        <div class="sidebar__section-header">
          <h2 id="search-section"><i class="fas fa-search"></i> Search</h2>
          <kbd>Ctrl/‚åòK</kbd>
        </div>
        <div class="sidebar__section-body">
          <div class="search" role="search">
            <i class="search__icon fas fa-search"></i>
            <input id="search-input" class="search__input" type="search"
                   placeholder="Search: muster, tender, CocoCay, dining‚Ä¶"
                   aria-label="Search the manual">
          </div>

          <div class="search-meta">
            <span class="pill"><i class="fas fa-bullseye"></i> <span id="search-count">0</span> hits</span>
            <span class="pill"><i class="fas fa-arrow-right"></i> <span id="search-pos">0/0</span></span>
          </div>

          <div class="button-row">
            <button id="open-palette" class="button button--primary" type="button">
              <span class="button__icon">‚åò</span> Command Palette
            </button>
            <button id="print-btn" class="button" type="button">
              <span class="button__icon"><i class="fas fa-print"></i></span> Print/PDF
            </button>
          </div>
          <div class="button-row">
            <button id="jump-today" class="button" type="button">
              <span class="button__icon"><i class="fas fa-calendar-day"></i></span> Today
            </button>
            <button id="toggle-theme" class="button" type="button">
              <span class="button__icon"><i class="fas fa-adjust"></i></span> Theme
            </button>
          </div>
        </div>
      </section>

      <section class="sidebar__section" aria-labelledby="filters-section">
        <div class="sidebar__section-header">
          <h2 id="filters-section"><i class="fas fa-filter"></i> Filters</h2>
          <kbd>Enter</kbd>
        </div>
        <div class="sidebar__section-body">
          <div class="filters">
            <label class="filter"><input type="checkbox" id="filter-crit" checked><span>üî¥</span><span class="filter__label">Critical</span></label>
            <label class="filter"><input type="checkbox" id="filter-warn" checked><span>üü°</span><span class="filter__label">Recommended</span></label>
            <label class="filter"><input type="checkbox" id="filter-ok" checked><span>üü¢</span><span class="filter__label">Info</span></label>
            <label class="filter"><input type="checkbox" id="filter-info" checked><span>üîµ</span><span class="filter__label">Secondary</span></label>
          </div>

          <label class="toggle">
            <input type="checkbox" id="focus-mode">
            <span class="toggle__slider"></span>
            <span class="toggle__label">Focus mode (tasks only)</span>
          </label>

          <div class="button-row">
            <button id="expand-all" class="button" type="button"><span class="button__icon"><i class="fas fa-expand-alt"></i></span> Expand</button>
            <button id="collapse-all" class="button" type="button"><span class="button__icon"><i class="fas fa-compress-alt"></i></span> Collapse</button>
          </div>
        </div>
      </section>

      <nav class="sidebar__section" aria-labelledby="toc-section">
        <div class="sidebar__section-header">
          <h2 id="toc-section"><i class="fas fa-list"></i> Contents</h2>
          <kbd>click</kbd>
        </div>
        <div class="sidebar__section-body">
          <ul class="toc" id="toc" aria-label="Table of contents"></ul>
        </div>
      </nav>

      <section class="sidebar__section" aria-labelledby="legend-section">
        <div class="sidebar__section-header">
          <h2 id="legend-section"><i class="fas fa-key"></i> Legend</h2>
          <kbd>tap</kbd>
        </div>
        <div class="sidebar__section-body">
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <span class="pill">üî¥ Critical</span>
            <span class="pill">üü° Recommended</span>
            <span class="pill">üü¢ Info</span>
            <span class="pill">üîµ Secondary</span>
          </div>
          <div class="kv" style="margin-top:12px;">
            <div class="k">Progress</div>
            <div class="v">Task completion is saved locally</div>
          </div>
        </div>
      </section>
    </aside>

    <!-- Main -->
    <main class="main" id="main">
      <header class="topbar" id="topbar">
        <div class="topbar__inner">
          <div class="chips">
            <span class="chip"><strong><i class="fas fa-ship"></i> Ship</strong><span class="mono">Adventure of the Seas</span></span>
            <span class="chip"><strong><i class="fas fa-calendar-alt"></i> Sail</strong><span class="mono">Feb 14‚Äì20, 2026</span></span>
            <span class="chip" id="today-banner"><strong><i class="fas fa-info-circle"></i> Status</strong><span class="mono">Pre-cruise</span></span>
            <span class="chip"><strong><i class="fas fa-users"></i> Stateroom</strong><span class="mono">6650 ¬∑ Deck 6 ¬∑ Aft</span></span>
            <span class="chip"><strong><i class="fas fa-user-friends"></i> Party</strong><span class="mono">4 (2 adults, 2 kids)</span></span>
            <span class="chip"><strong><i class="fas fa-glass-whiskey"></i> Packages</strong><span class="mono">Refreshment + 3‚Äënight Dining (adults)</span></span>
          </div>
          <div class="topbar__actions">
            <kbd><i class="fas fa-keyboard"></i> Ctrl/‚åòK</kbd>
            <kbd><i class="fas fa-times"></i> Esc</kbd>
          </div>
        </div>
        <nav class="daystrip" id="daystrip" aria-label="Trip days"></nav>
      </header>

      <section class="hero" id="top">
        <div class="hero__content">
          <div>
            <h1 class="hero__title">Cruise Companion ¬∑ <span class="text-gradient">Mission Control 2.0</span></h1>
            <p class="hero__desc">
              <strong>Enhanced for maximum efficiency.</strong> Fast search with real-time highlighting, persistent task tracking, 
              smart filtering, and intuitive navigation. Use <kbd>Enter</kbd> to cycle search hits, <kbd>Ctrl/‚åòK</kbd> for command palette.
            </p>
            <div class="hero__badges" aria-label="Key identifiers">
              <span class="badge"><strong><i class="fas fa-tag"></i> Reservation</strong><span class="mono">4519230</span></span>
              <span class="badge"><strong><i class="fas fa-door-open"></i> Stateroom</strong><span class="mono">6650 (Deck 6, aft)</span></span>
              <span class="badge"><strong><i class="fas fa-user-friends"></i> Party</strong><span class="mono">2 adults ¬∑ 2 kids</span></span>
              <span class="badge"><strong><i class="fas fa-utensils"></i> Dining</strong><span class="mono">3-night specialty</span></span>
              <span class="badge"><strong><i class="fas fa-cocktail"></i> Drinks</strong><span class="mono">Refreshment package</span></span>
            </div>
          </div>

          <div class="hero__art" aria-label="Night ship cover art">
            <svg viewBox="0 0 900 420" role="img" aria-label="Ship silhouette with lights">
              <defs>
                <linearGradient id="g1" x1="0" x2="1">
                  <stop offset="0" stop-color="rgba(125,211,252,0.95)"/>
                  <stop offset="1" stop-color="rgba(167,243,208,0.85)"/>
                </linearGradient>
                <linearGradient id="sea" x1="0" x2="1">
                  <stop offset="0" stop-color="rgba(96,165,250,0.14)"/>
                  <stop offset="1" stop-color="rgba(125,211,252,0.06)"/>
                </linearGradient>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="4" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <rect x="0" y="0" width="900" height="420" fill="rgba(7,10,20,0.15)"/>
              <path d="M0,310 C120,290 210,330 330,310 C450,290 560,320 690,300 C780,286 840,300 900,290 L900,420 L0,420 Z" fill="url(#sea)"/>
              <path d="M115,270 L760,270 L830,310 L145,310 Z" fill="rgba(255,255,255,0.10)" stroke="rgba(255,255,255,0.10)"/>
              <path d="M220,140 L660,140 L700,270 L180,270 Z" fill="rgba(255,255,255,0.07)" stroke="rgba(255,255,255,0.10)"/>
              <path d="M520,95 L570,95 L585,140 L505,140 Z" fill="rgba(255,255,255,0.08)"/>
              <path d="M590,105 L635,105 L650,140 L575,140 Z" fill="rgba(255,255,255,0.06)"/>
              <g filter="url(#glow)">
                <circle cx="250" cy="175" r="3" fill="url(#g1)"/>
                <circle cx="290" cy="185" r="3" fill="url(#g1)"/>
                <circle cx="330" cy="195" r="3" fill="url(#g1)"/>
                <circle cx="370" cy="205" r="3" fill="url(#g1)"/>
                <circle cx="410" cy="215" r="3" fill="url(#g1)"/>
                <circle cx="450" cy="225" r="3" fill="url(#g1)"/>
                <circle cx="490" cy="235" r="3" fill="url(#g1)"/>
                <circle cx="530" cy="245" r="3" fill="url(#g1)"/>
                <circle cx="570" cy="255" r="3" fill="url(#g1)"/>
                <circle cx="610" cy="255" r="3" fill="url(#g1)"/>
              </g>
              <text x="36" y="56" fill="rgba(255,255,255,0.75)" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" font-size="14">
                MISSION CONTROL 2.0 // ENHANCED UI
              </text>
            </svg>
          </div>
        </div>
      </section>

      <section class="dashboard" aria-label="Quick panels">
        <div class="panel">
          <header class="panel__header">
            <div>
              <h3 class="panel__title"><i class="fas fa-tachometer-alt"></i> Command Snapshot</h3>
              <div class="panel__sub">Real-time status & analytics</div>
            </div>
            <span class="pill" id="overall-progress">0%</span>
          </header>
          <div class="panel__body">
            <div class="kpi">
              <div class="kpi__box">
                <div class="kpi__label"><i class="fas fa-exclamation-circle"></i> Next "must-do"</div>
                <div class="kpi__value" id="kpi-next">‚Äî</div>
              </div>
              <div class="kpi__box">
                <div class="kpi__label"><i class="fas fa-clock"></i> Countdown</div>
                <div class="kpi__value" id="kpi-countdown">‚Äî</div>
              </div>
              <div class="kpi__box">
                <div class="kpi__label"><i class="fas fa-calendar-day"></i> Today</div>
                <div class="kpi__value" id="kpi-today">‚Äî</div>
              </div>
              <div class="kpi__box">
                <div class="kpi__label"><i class="fas fa-tasks"></i> Tasks (visible)</div>
                <div class="kpi__value" id="kpi-visible">‚Äî</div>
              </div>
            </div>

            <div class="kv" style="margin-top:18px;">
              <div class="k">Operating mode</div>
              <div class="v"><strong>Red tasks first.</strong> One rendezvous point. Snacks are a stability layer. This manual adapts to reality.</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <header class="panel__header">
            <div>
              <h3 class="panel__title"><i class="fas fa-map-marked-alt"></i> Official Itinerary</h3>
              <div class="panel__sub">Today auto-highlights</div>
            </div>
            <button class="icon-btn" id="copy-itin" aria-label="Copy itinerary to clipboard" title="Copy itinerary">
              <i class="fas fa-copy"></i>
            </button>
          </header>
          <div class="panel__body">
            <table class="table" aria-label="Itinerary table">
              <thead><tr><th>Day</th><th>Port</th><th>Time</th><th>Action</th></tr></thead>
              <tbody id="itinerary-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="chapters" id="chapters">
        <!-- Chapters will be dynamically generated by JavaScript -->
      </section>

      <footer class="footer">
        <div><b><i class="fas fa-lightbulb"></i> Pro tip:</b> Reduce decisions. Keep defaults. Execute red tasks early. Then relax. This manual adapts.</div>
      </footer>
    </main>
  </div>

  <!-- FAB -->
  <div class="fab" aria-label="Quick actions">
    <button id="fab-top" class="fab__btn" aria-label="Back to top" title="Back to top"><i class="fas fa-arrow-up"></i></button>
    <button id="fab-command" class="fab__btn" aria-label="Open command palette" title="Command palette"><i class="fas fa-terminal"></i></button>
    <button id="fab-help" class="fab__btn" aria-label="Show help" title="Help"><i class="fas fa-question"></i></button>
  </div>

  <!-- Command Palette -->
  <div id="palette" class="palette" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Command palette">
    <div class="palette__content">
      <div class="palette__header">
        <div class="palette__icon" aria-hidden="true"><i class="fas fa-terminal"></i></div>
        <input id="palette-input" class="palette__input" type="text"
               placeholder="Type: today, muster, packing, coco‚Ä¶"
               aria-label="Search commands">
        <kbd>Esc</kbd>
      </div>
      <ul id="palette-list" class="palette__list" role="listbox"></ul>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" aria-hidden="true" role="status" aria-live="polite">
    <span id="toast-text">Copied</span>
  </div>

  <script>
/* ==========================================================================
   Mission Control 2.0 JS ‚Äî Enhanced UX with advanced features
   ========================================================================== */
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

// Enhanced utilities
function toast(msg, type = 'info') {
  const t = $('#toast');
  const tt = $('#toast-text');
  if (!t || !tt) return;
  
  // Add icon based on type
  const icons = {
    info: '‚ÑπÔ∏è',
    success: '‚úÖ',
    warning: '‚ö†Ô∏è',
    error: '‚ùå'
  };
  
  tt.innerHTML = `${icons[type] || icons.info} ${msg}`;
  t.setAttribute('aria-hidden', 'false');
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => t.setAttribute('aria-hidden', 'true'), 1800);
}

function smoothTo(el, opts = {}) {
  if (!el) return;
  el.scrollIntoView({ behavior: 'smooth', block: 'start', ...opts });
}

function createConfetti() {
  const colors = ['#7dd3fc', '#60a5fa', '#a78bfa', '#a7f3d0', '#fbbf24', '#fb7185'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.width = Math.random() * 10 + 5 + 'px';
    confetti.style.height = Math.random() * 10 + 5 + 'px';
    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
    document.body.appendChild(confetti);
    
    const animation = confetti.animate([
      { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
      { transform: `translateY(${window.innerHeight + 20}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
    ], {
      duration: Math.random() * 3000 + 2000,
      easing: 'cubic-bezier(0.215, 0.610, 0.355, 1)'
    });
    
    animation.onfinish = () => confetti.remove();
  }
}

/* ----------------------------- App State -------------------------------- */
class AppState {
  constructor() {
    this.itinerary = [
      { day: 1, date: '2026-02-14', label: 'Sat, Feb 14', port: 'Port Canaveral', time: 'Depart 4:00 PM', icon: 'üö¢' },
      { day: 2, date: '2026-02-15', label: 'Sun, Feb 15', port: 'At Sea', time: 'All Day', icon: 'üåä' },
      { day: 3, date: '2026-02-16', label: 'Mon, Feb 16', port: 'George Town, Grand Cayman (Tender)', time: '10:30 AM‚Äì6:00 PM', icon: 'üèùÔ∏è' },
      { day: 4, date: '2026-02-17', label: 'Tue, Feb 17', port: 'Falmouth, Jamaica', time: '8:00 AM‚Äì5:00 PM', icon: 'üå¥' },
      { day: 5, date: '2026-02-18', label: 'Wed, Feb 18', port: 'At Sea', time: 'All Day', icon: 'üåä' },
      { day: 6, date: '2026-02-19', label: 'Thu, Feb 19', port: 'Perfect Day at CocoCay', time: '7:00 AM‚Äì5:00 PM', icon: '‚òÄÔ∏è' },
      { day: 7, date: '2026-02-20', label: 'Fri, Feb 20', port: 'Port Canaveral', time: 'Arrive 7:00 AM', icon: 'üèÅ' },
    ];
    
    // Enhanced chapter data
    this.chapters = [
      {
        id: 'executive',
        num: 1,
        title: 'Executive Summary ¬∑ Run the Cruise Like Software',
        color: 'primary',
        sections: [
          {
            title: 'Operating rules',
            icon: 'üß≠',
            type: 'Principles',
            content: `
              <p class="p">This manual is a <b>human-friendly operations playbook</b>. It assumes real life: small humans, hunger, time windows, and surprise chaos.</p>
              <ul class="list">
                <li><b>Default calm.</b> Fewer decisions. More rhythm.</li>
                <li><b>Do irreversible things early.</b> Muster, reservations, key logistics.</li>
                <li><b>One rendezvous point.</b> Everyone knows where to return.</li>
                <li><b>Red tasks first.</b> Then yellow. Then enjoy being alive.</li>
              </ul>
            `,
            tasks: [
              { id: 'exec-muster', emoji: 'üî¥', text: '<strong>Muster:</strong> complete immediately after boarding. Future-you will thank you.', type: 'crit' },
              { id: 'exec-dining', emoji: 'üü°', text: '<strong>Dining plan:</strong> lock specialty nights early so you don\'t end up eating sadness at 9:45 PM.', type: 'warn' },
              { id: 'exec-rally', emoji: 'üü¢', text: '<strong>Rendezvous:</strong> pick a default meetup spot + time window. Make it boring. Boring wins.', type: 'ok' }
            ]
          }
        ]
      },
      {
        id: 'embarkation',
        num: 2,
        title: 'Embarkation ¬∑ Golden Hour Protocol',
        color: 'warning',
        sections: [
          {
            title: 'Immediate wins',
            icon: '‚ö°',
            type: 'Checklist',
            content: `<p class="p">The first hour onboard is where most "we should've..." stories are born. Keep it simple. Execute the basics.</p>`,
            tasks: [
              { id: 'embark-docs', emoji: 'üî¥', text: '<strong>Documents:</strong> verify access (SeaPass/app). Photograph anything important.', type: 'crit' },
              { id: 'embark-muster', emoji: 'üî¥', text: '<strong>Muster:</strong> do it now, not later.', type: 'crit' },
              { id: 'embark-wifi', emoji: 'üü°', text: '<strong>Connectivity:</strong> decide "Wi‚ÄëFi vs airplane mode." Set expectations.', type: 'warn' },
              { id: 'embark-meet', emoji: 'üü°', text: '<strong>Rendezvous point:</strong> pick one meetup spot + time window.', type: 'warn' }
            ]
          },
          {
            title: 'Stateroom quick ops',
            icon: 'üõèÔ∏è',
            type: 'Room',
            content: `
              <div class="kv">
                <div class="k">Room</div>
                <div class="v">6650 (Deck 6, aft). Put a small "go bag" by the door: sunscreen, meds, band-aids, chargers.</div>
              </div>
              <div class="kv">
                <div class="k">First meal strategy</div>
                <div class="v">Eat something simple early. Hungry people make inventive bad decisions.</div>
              </div>
            `,
            tasks: []
          }
        ]
      },
      // Additional chapters would follow the same pattern...
    ,
      {
        id: "manual",
        chapter: "X",
        title: "Full Operations Manual (Integrated)",
        blurb: "Everything from the PDF, cleanly formatted and searchable ‚Äî no external files needed.",
        sections: [
          {
            id: "manual-full",
            title: "The Family & Friends Cruise Companion ‚Äî Unabridged Operations Manual",
            body: `<p class="p">The Family and Friends Cruise Companion: Unabridged Operations Manual Adventure of the Seas | February 14‚Äì20, 2026 | Western Caribbean &amp; Perfect Day ‚Äî Table of Contents 1. Pre-Cruise Command Center 2. Embarkation Day: The Golden Hour Protocol 3. Ship Fundamentals &amp; Daily Rhythm 4. The Daily Navigator: A Flexible Itinerary 5. Port Playbook: Grand Cayman, Falmouth &amp; CocoCay 6. Dining &amp; Speciality Restaurant Strategy 7. Finance, Communication &amp; Logistics 8. Debarkation &amp; Return to Reality --- Pre-Cruise Command Center</p>
<h2>1.1 Guest Manifest &amp; Core Data</h2>
<p class="p">‚Äì</p>
<h2>Primary Booking (4519230):</h2>
<p class="p">‚Äì Stateroom: 6650 (Deck 6, Aft) ‚Äì Guests: William, Melissa, Declan, Owen ‚Äì Muster Station: D22 ‚Äì</p>
<h2>Secondary Booking (6788946):</h2>
<p class="p">‚Äì Stateroom: 6651 (Deck 6, Aft) ‚Äì Guest: Amy Abel ‚Äì Muster Station: D22 ‚Äì</p>
<h2>Tertiary Booking (4352113):</h2>
<p class="p">‚Äì Stateroom: 8528 (Deck 8, Forward-Mid) ‚Äì Guest: Karin Aimee ‚Äì Muster Station: A2</p>
<h2>1.2 Official Itinerary</h2>
<p class="p">‚Äì Day 1 (Sat, Feb 14): Port Canaveral | Depart 4:00 PM ‚Äì Day 2 (Sun, Feb 15): AT SEA ‚Äì Day 3 (Mon, Feb 16): George Town, Grand Cayman | 10:30 AM - 6:00 PM (Tender Port) ‚Äì Day 4 (Tue, Feb 17): Falmouth, Jamaica | 8:00 AM - 5:00 PM ‚Äì Day 5 (Wed, Feb 18): AT SEA ‚Äì Day 6 (Thu, Feb 19): Perfect Day at CocoCay | 7:00 AM - 5:00 PM ‚Äì Day 7 (Fri, Feb 20): Port Canaveral | Arrive 7:00 AM</p>
<h2>1.3 Mandatory Pre-Departure Tasks (Complete by Feb 13)</h2>
<p class="p">‚Äì Royal App: Download and ensure all adults have access. ‚Äì Online Check-In: Complete via app as soon as it opens (‚âà45 days prior). Upload photos, select earliest arrival time (10:30 AM target). ‚Äì Linking Bookings: The designated ‚ÄúConcierge‚Äù (likely William/Melissa) must link all three booking numbers in the Royal app. ‚Äì Documentation: Ensure passports are valid. Print SetSail passes and luggage tags as backup. ‚Äì Communication: Establish a WhatsApp group as the primary external channel. Designate the ‚ÄúConcierge‚Äôs‚Äù device as the holder of the 1-device VOOM internet plan for shore-based comms. ‚Äî 2. Embarkation Day: The Golden Hour Protocol Objective: Transition from land-based chaos to onboard control within the first 60 minutes. Time Action Location Responsi- Notes Block Item ble Party 10:30 AM Arrive at Port All SetSail Terminal Canaveral Pass &amp; Passport ready. Check bags with porters. 12:00 PM STEP 1: Deck 4/5 ADlol not The Prome- disperse. Huddle nade Find a wall or quiet seating. 12:05 PM STEP 2: Onboard Concierge 1. Connect Digital 1 to ROYAL- Activation WIFI. 2. Open Royal app, verify linked bookings.</p>
<h2>12:10 PM STEP 3: Concierge Concierge 1. Dining:</h2>
<p class="p">Priority 1 1 Modify Booking auto- Via Royal booked App specialty. Secure Nights 1, 3,</p>
<h2>4 at</h2>
<p class="p">chosen venues for venues for</p>
<h2>6 people.</h2>
<h2>2. Shows:</h2>
<p class="p">Book any reservable shows (if offered).</p>
<h2>12:30 PM STEP 4: Muster All 1. eMuster:</h2>
<p class="p">Muster &amp; Stations / Disperse Verify Dining to stations</p>
<h2>D22 &amp; A2,</h2>
<p class="p">scan in, watch video. 2.</p>
<h2>Regroup:</h2>
<p class="p">Meet at Pool Bar. 3. Physical Link: Visit Specialty Dining podium &amp; MDR ma√Ætre d‚Äô ma√Ætre d‚Äô to confirm linked tables. 1:00 PM Mission Windjam- AHlalve Complete mer / Caf√© lunch. The opera- tional heavy lifting is done. Cabins ready</p>
<h2>‚âà1:30 Pm.</h2>
<p class="p">--- 3. Ship Fundamentals &amp; Daily Rhythm</p>
<h2>3.1 Your Ship Geography</h2>
<p class="p">‚Äì Deck 6 Aft (6650, 6651): ‚ÄúThe Quiet Zone.‚Äù Optimal for quick elevator access to Dining Rooms (Decks 3-5) and Windjammer (Deck 11). Use aft stairwell/elevators as your primary vertical artery. ‚Äì Deck 8 Forward-Mid (8528): ‚ÄúThe Central Hub.‚Äù Closer to forward entertainment (Theater, Spa). Use forward stairwell/elevators. Ideal meeting point: R Bar on Deck 5 Promenade.</p>
<h2>3.2 The Non-Negotiable Daily Beat</h2>
<p class="p">‚Äì</p>
<h2>Morning (7:30-9:00 AM):</h2>
<p class="p">‚Äì</p>
<h2>Morning (7:30-9:00 AM):</h2>
<p class="p">Light breakfast (Caf√© Promenade) or full buffet (Windjammer). Confirm day‚Äôs plan via group chat. ‚Äì</p>
<h2>Late Morning (10:00 AM):</h2>
<p class="p">Execute the chosen ‚ÄúPath‚Äù for the day (Adventure, Culture, or Chill). ‚Äì</p>
<h2>Afternoon (1:00-4:00 PM):</h2>
<p class="p">Lunch, followed by flexible time (pool, trivia, nap, return from port). ‚Äì</p>
<h2>Pre-Dinner (6:45 PM):</h2>
<p class="p">Mandatory Group Meet-Up at R Bar. Dress for dinner, coordinate evening plans. ‚Äì</p>
<h2>Evening (7:30 PM+):</h2>
<p class="p">Dinner, followed by show, music, or leisure. ‚Äì</p>
<h2>Night (10:00 PM+):</h2>
<p class="p">Optional late-night activities (comedy, dancing, snacks).</p>
<h2>3.3 Entertainment &amp; Booking Truths</h2>
<p class="p">‚Äì Myth: Shows must be booked months in advance. ‚Äì Reality on Adventure of the Seas: Main theater and ice shows are first-come, first-served. ‚Äì Strategy: The Ice Show in Studio B is the priority. Check the app for performance days (typically sea days). Arrive 30 minutes early for the best group seating. For main theater shows, arriving 15-20 minutes early is sufficient. --- 4. The Daily Navigator: A Flexible Itinerary Each day offers curated ‚ÄúPaths‚Äù (A/B/C) tailored to different energy levels and interests. ‚Äì ‚Äì ‚Äì ‚Äì üìÖ Day 2: Sun, Feb 15 ‚Äî At Sea (Formal Night #1) Path A | Thrill-Seeker: Morning FlowRider clinic (book onboard). Afternoon rock climbing or waterslides. Pre-dinner group photos in formal attire. Path B | Culturist: Morning art auction or trivia. Afternoon ice skating show. Relax in the Solarium before formal dinner. Path C | Family Anchor: Morning pool games and mini-golf. Afternoon Adventure Ocean for kids, spa for adults. Casual early dinner before the show. Dinner: Formal Night in Main Dining Room. ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì ‚Äì üìÖ Day 3: Mon, Feb 16 ‚Äî George Town, Grand Cayman Path A | Aquatic Adventure: Ship-sponsored Stingray City &amp; snorkel tour. Return for late lunch onboard. Path B | Beach Club Relaxation: Taxi to Seven Mile Beach (Calico Jack‚Äôs or Public Beach). Rent chairs, enjoy calm water. Path C | Historic &amp; Culinary: Explore George Town, visit the National Museum. Lunch at a local eatery like ‚ÄúParadise Grill.‚Äù Dinner: Specialty Dining #1 (e.g., Giovanni‚Äôs Table). üìÖ Day 4: Tue, Feb 17 ‚Äî Falmouth, Jamaica Path A | Iconic Excursion: Pre-booked tour to Dunn‚Äôs River Falls and/or Blue Hole. Requires water shoes, sense of adventure. Path B | Curated Culture: Historic Falmouth walking tour, then resort day at nearby ‚ÄúRoyalton‚Äù property (day pass). Path C | Ship Day Savvy: Enjoy a quieter ship. Pool, spa, and onboard activities without crowds. Dinner: Specialty Dining #2 (e.g., Chops Grille). üìÖ Day 5: Wed, Feb 18 ‚Äî At Sea (Formal Night #2) Path A | Final Challenges: Last sessions on FlowRider, rock wall, or zip line (if available). Afternoon packing session. Path B | Enrichment &amp; Leisure: Attend a guest lecture or cooking demo. Afternoon farewell ice show or trivia tournament. Path C | Ultimate Relaxation: Extended spa treatment, leisurely reading on the helipad, final swim. Dinner: Formal Night in Main Dining Room (Lobster Tail night). üìÖ Day 6: Thu, Feb 19 ‚Äî Perfect Day at CocoCay Path A | Thrill Island: Early access to Thrill Waterpark slides (if pre-booked). Afternoon at the Oasis Lagoon pool. Path B | Chill Island: Secure loungers at Chill Island for snorkeling and swimming. Rent a floating mat. Lunch at Chill Grill. Path C | Explorer: Walk the nature trail, visit the observation tower, try the Up, Up &amp; Away balloon (weather/$$), shop at the straw market. Dinner: Specialty Dining #3 or Main Dining Room Farewell. --- 5. Port Playbook: Tactical Briefs</p>
<h2>5.1 Grand Cayman (Tender Port)</h2>
<p class="p">‚Äì Tender Process: Tenders begin ‚âà10:45 AM. Go early (10:15 AM) or expect tickets/lines. Ship excursions meet first. ‚Äì Return: Last tender is at 5:15 PM. Aim to queue by 4:30 PM. ‚Äì Currency: USD widely accepted. Many places take credit cards.</p>
<h2>5.2 Falmouth, Jamaica</h2>
<p class="p">‚Äì Docking: Ship docks. Easy walk-off. ‚Äì Advice: For independent tours, only use licensed operators inside the port gate. Set a clear price and return time. ‚Äì Must-Try: Jerk chicken from ‚ÄúScotchies‚Äù (located just outside port).</p>
<h2>5.3 Perfect Day at CocoCay</h2>
<p class="p">‚Äì #1 Rule: Disembark by 8:00 AM to claim prime lounge chairs. ‚Äì Included: All beaches, the massive Oasis Lagoon pool, multiple buffets (Chill Grill, Skipper‚Äôs Grill), Snack Shacks. ‚Äì Drinks: Your Refreshment Package works here. ‚Äì Return: All aboard 4:30 PM. Tram available for transport from farther beaches. ‚Äî 6. Dining &amp; Speciality Restaurant Strategy</p>
<h2>6.1 The 3-Night Package Execution</h2>
<p class="p">‚Äì Bookings: Made and linked on Embarkation Day. ‚Äì Recommended Nights: Day 1 (avoid MDR chaos), Day 3 (post-Grand Cayman), Day 6 (CocoCay celebration). ‚Äì</p>
<h2>Venue Guide:</h2>
<p class="p">‚Äì Chops Grille: Classic steakhouse. Order the filet and shareable sides. ‚Äì Giovanni‚Äôs Table: Italian family-style. Perfect for groups. ‚Äì Izumi: Hibachi experience (entertaining) or √† la carte sushi. Credit from package ‚Äì applies.</p>
<h2>6.2 Main Dining Room &amp; other Venues</h2>
<p class="p">‚Äì My Time Dining: You have reservations. Show up at your set time each night. ‚Äì Windjammer (Buffet): Best for breakfast variety and casual lunches. Avoid peak times (8:30</p>
<h2>Am, 12:30 Pm).</h2>
<p class="p">‚Äì Caf√© Promenade: 24/7 included snacks (pizza, sandwiches, cookies). Your late-night savior. --- 7. Finance, Communication &amp; Logistics</p>
<h2>7.1 The Financial Control Panel</h2>
<p class="p">‚Äì SeaPass: Your onboard credit card. All spending is charged to your cabin account. ‚Äì Tracking: Use the ‚ÄúOnboard Account‚Äù feature in the Royal app daily to monitor charges. ‚Äì Gratuities: Standard daily gratuity ($18.50+/person/day) will be auto-charged. You pre-paid or will see this on your final bill. ‚Äì Settling Up: Final bill is charged to the card on file early on debarkation day. Review paper statement left at your cabin.</p>
<h2>7.2 The Communication Matrix</h2>
<p class="p">‚Äì Onboard (Primary): Royal App‚Äôs free in-app chat. Works over ship Wi-Fi without an internet package. Create a group for all 6 guests. ‚Äì Onboard (Secondary - External): The 1-device VOOM internet plan. Use for WhatsApp, email, social media. Log in/out as needed on shared devices. ‚Äì In Port: Local cell service may work (check your plan). Use WhatsApp if connected. Always set a clear physical meet-up time and place.</p>
<h2>7.3 Luggage &amp; Packing</h2>
<p class="p">‚Äì Embarkation: Attach tags. Check large bags with porters; keep essentials, meds, swimwear, and documents in carry-on. ‚Äì Debarkation: Place large bags outside your cabin by 11:00 PM on final night. Keep debarkation day clothes and toiletries in carry-on. ‚Äî 8. Debarkation &amp; Return to Reality</p>
<h2>8.1 The Night Before (Day 6)</h2>
<p class="p">‚Äì Pack checked luggage. ‚Äì Settle onboard account (visit Guest Services if discrepancies). ‚Äì Place luggage in hallway by 11:00 PM.</p>
<h2>8.2 Debarkation Morning (Day 7)</h2>
<p class="p">‚Äì Early Breakfast: Windjammer or Caf√© Promenade opens early. ‚Äì</p>
<h2>Two Disembarkation Options:</h2>
<p class="p">1. Self-Assist (Recommended for Control): Keep all luggage, walk off once ship clears (‚âà7:15 AM). Best for those with early travel. 2. Checked Luggage: Wait in a designated lounge for your luggage tag number/color to be called. Disembark, find bags in terminal. ‚Äì Customs: Use facial recognition or present passport. Proceed to transportation.</p>
<h2>8.3 Post-Cruise</h2>
<p class="p">‚Äì Survey: You may receive a guest satisfaction survey via email. Your feedback matters. ‚Äì Memories: Your SeaPass cards are souvenirs. Photos can be purchased or downloaded if you used the ship‚Äôs photographers. ‚Äî Final Transmission This manual is your blueprint. You have mastered the logistics. The only task left is to enjoy the fluid reality of your family‚Äôs adventure. Trust the plan, then live beyond it. Bon Voyage, family and friends. ‚∏ª</p>
<h2>Addendum X ‚Äî Failure Modes, Contingencies &amp;</h2>
<h2>Force Multipliers</h2>
<p class="p">Companion to The Family and Friends Cruise Companion: Unabridged Operations Manual</p>
<h2>Purpose:</h2>
<p class="p">This addendum exists for the moments between the plan and reality. It covers health, weather, kids, fatigue, human error, and ship quirks ‚Äî the things that actually cause stress if they aren‚Äôt pre- decided. Read once. Use rarely. Appreciate silently. ‚∏ª</p>
<h2>X1) Medical &amp; Health Contingency Protocol</h2>
<p class="p">Medical Center (Know Before You Need It) Location: Deck 4 (forward) Hours: Posted daily in app; 24-hour emergency availability Cost reality: Care is not free. Charges go to SeaPass. Decision Tree</p>
<h2>Minor issue (headache, nausea, scrape):</h2>
<p class="p">‚Üí Treat in cabin first ‚Üí reassess in 30‚Äì60 minutes</p>
<h2>Moderate issue (fever, persistent vomiting, allergic reaction):</h2>
<p class="p">‚Üí One adult escorts to Medical ‚Üí One adult remains with kids ‚Üí Concierge notified</p>
<h2>Serious issue (injury, breathing trouble):</h2>
<p class="p">‚Üí Call ship emergency number immediately (posted on cabin phone) Medication Safeguard ‚Ä¢ All critical meds must be split across two carry-ons, not one bag. ‚Ä¢ Never leave all meds in one cabin. ‚∏ª</p>
<h2>X2) Weather &amp; Sea-State Adaptation Logic</h2>
<p class="p">If CocoCay Is Windy or Overcast ‚Ä¢ Shade &gt; chairs &gt; water ‚Ä¢ Poolside + Snack Shack beats beach frustration ‚Ä¢ Accept ‚Äúhalf-day win‚Äù and leave early if conditions turn If Tendering Is Delayed (Grand Cayman) ‚Ä¢ Ship excursions go first ‚Äî this is intentional ‚Ä¢ Independent plans should not rush ‚Ä¢ Convert morning plan ‚Üí afternoon plan without negotiation The Family and Friends Cruise Companion: Unabridged Operations Manual Adventure of the Seas | February 14‚Äì20, 2026 | Western Caribbean &amp; Perfect Day --- üìå Emoji Legend (Quick Reference Box) Emoji Meaning üî¥ Critical Task ‚Äì Must be on time / affects safety or major plans üü° Optional / Recommended ‚Äì Enhances experience but not mandatory üü¢ Informational / Flexible ‚Äì Helpful notes, tips, or reminders ‚óè (Legend repeats in footer of each page for quick scanning) --- ‚Äì ‚óè ‚óè ‚óè ‚óè ‚Äì ‚óè ‚óè ‚óè ‚óè ‚Äì ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè ‚óè üî¥ üü° üü¢ 1. Pre-Cruise Command Center</p>
<h2>1.1 Guest Manifest &amp; Core Data</h2>
<p class="p">üî¥ Primary Booking (4519230) ‚Ä¢ Stateroom: 6650 (Deck 6, Aft) ‚Ä¢ Guests: William, Melissa, Declan, Owen ‚Ä¢ Muster Station: D22 üîµ Secondary Booking (6788946) ‚Ä¢ Stateroom: 6651 (Deck 6, Aft) ‚Ä¢ Guest: Amy Abel ‚Ä¢ Muster Station: D22 üîµ Tertiary Booking (4352113) ‚Ä¢ Stateroom: 8528 (Deck 8, Forward-Mid) ‚Ä¢ Guest: Karin Aimee ‚Ä¢ Muster Station: A2 ---</p>
<h2>1.2 Official Itinerary (Visual Timeline)</h2>
<p class="p">Day Port/Activity Time Emoji Feb 14 (Sat) Port 4:00 PM Canaveral ‚Äì Depart üî¥ Feb 15 (Sun) At Sea All Day üü° Feb 16 (Mon) Grand 10:30 AM‚Äì6 Cayman PM (Tender) üî¥</p>
<h2>10:30 Am‚Äì6</h2>
<p class="p">Cayman PM (Tender) ‚óè ‚óè ‚Äì ‚óè ‚óè ‚Äì ‚óè ‚óè ‚óè ‚Äì ‚óè ‚óè ‚Äì ‚óè ‚óè ‚óè ‚Äì ‚óè ‚óè ‚óè ‚óè ‚óè üî¥ Feb 17 (Tue) Falmouth, 8 AM‚Äì5 PM Jamaica üî¥ Feb 18 (Wed) At Sea All Day üü° Feb 19 (Thu) Perfect Day at 7 AM‚Äì5 PM CocoCay üî¥ Feb 20 (Fri) Port 7 AM Canaveral ‚Äì Arrive üî¥ --- 1.3 üî¥ Mandatory Pre-Departure Tasks (By Feb 13) üî¥ Royal App ‚Ä¢ Download and confirm access for all adults üî¥ Online Check-In ‚Ä¢ Complete as soon as available (~45 days prior) ‚Ä¢ Upload photos and select earliest arrival (10:30 AM) üî¥ Link Bookings ‚Ä¢ Concierge (William/Melissa) must link all three bookings in the app üü° Documentation ‚Ä¢ Verify passports ‚Ä¢ Print SetSail passes and luggage tags üü¢ Communication Setup ‚Ä¢ Create WhatsApp group ‚Ä¢ Concierge device holds VOOM internet --- üî¥ üü° 2. Embarkation Day: The Golden Hour Protocol</p>
<h2>Objective:</h2>
<p class="p">‚úÖ Achieve full onboard readiness within the first 60 minutes ‚è∞ Time üîπ Action üìç Location üë§ Lead üìù Notes</p>
<h2>10:30 Am</h2>
<p class="p">üî¥ Arrive Port All SetSail &amp; at Terminal Canaveral passport ready; check bags with porters</p>
<h2>12:00 Pm</h2>
<p class="p">üî¥ Step 1: Deck 4/5 AGlalther The Prome- before Huddle nade dispersing</p>
<h2>12:05 Pm</h2>
<p class="p">üî¥ Step 2: Onboard Concierge Connect to Digital 1 Wi-Fi; Activation verify bookings in app</p>
<h2>12:10 Pm</h2>
<p class="p">üî¥ Step 3: Royal App Concierge Reserve Priority 1 dining Bookings (Nights 1,3,4) &amp; shows</p>
<h2>12:30 Pm</h2>
<p class="p">üî¥ Step 4: Muster/ All eMuster, Muster &amp; Dining Verify Muster/ All eMuster, Muster &amp; Dining regroup, Verify confirm linked tables</p>
<h2>1:00 Pm</h2>
<p class="p">‚Äì ‚Äì ‚óè ‚óè ‚óè üü¢ Mission Windjam- ALullnch; Complete mer / Caf√© cabins ready</p>
<h2>~1:30 Pm</h2>
<p class="p">--- üü° üü¢ 3. Ship Fundamentals &amp; Daily Rhythm</p>
<h2>3.1 Ship Geography</h2>
<p class="p">üü¢ Deck 6 Aft (6650, 6651) ‚Ä¢ Quiet Zone; easy dining access via aft elevators üü¢ Deck 8 Forward-Mid (8528) ‚Ä¢ Central Hub near theater and spa ‚Ä¢ Meeting spot: R Bar, Deck 5 ---</p>
<h2>3.2 Daily Schedule (Visual Flow)</h2>
<p class="p">Time Activity Emoji 7:30‚Äì9:00 AM Breakfast &amp; group plan confirmation üü° 10:00 AM Begin chosen Path (Adventure/ Culture) üü° Culture) ‚óè üü° 1:00‚Äì4:00 PM Lunch + flexible activity/rest üü° 6:45 PM Group meet at R Bar üü° 7:30 PM+ Dinner + Evening Show üü° 10:00 PM+ Optional late-night fun üü¢ --- üî¥ üü° 4. The Daily Navigator: Flexible Itineraries (Reformatted with daily tables or timelines with emoji-coded tasks for clarity.) --- üî¥ üü° 5. Port Playbook (Tactical Tables) Grand Cayman Task Time Emoji Tender Start 10:45 AM üî¥ Early Queue 10:15 AM üî¥ Last Tender 5:15 PM üî¥ All Aboard 4:30 PM üî¥ Falmouth Task Time Emoji Docking 8:00 AM ‚óè ‚óè ‚óè ‚óè ‚óè üü° Port Close 5:00 PM üü° CocoCay Task Time Emoji Arrive Early 8:00 AM üî¥ All Aboard 4:30 PM üî¥ --- üî¥ Quick-Reference: Critical Tasks Task Time/Date Page Arrive at Terminal Feb 14, 10:30 AM 2 Muster Drill Feb 14, 12:30 PM 2 Complete Link Bookings in By Feb 13 1 App Grand Cayman Feb 16, 5:15 PM 5 Last Tender CocoCay All Feb 19, 4:30 PM 5 Aboard Luggage in Feb 19, 11:00 PM 8 Hallway --- üü° Addendum X ‚Äî Contingencies &amp; Force Multipliers (Reorganized with color-coded tasks, tables for medical, weather, and kid safety protocols.) --- üîö Final Command Note With this manual, you are fully prepared. Enjoy the cruise. Trust the plan. Live beyond it. üö¢ Bon Voyage! ---</p>
<h2>Footer:</h2>
<p class="p">üî¥ Critical | üü° Recommended | üü¢ Informational</p>`
          }
        ]
      }];
  }
  
  todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }
  
  parse(iso) {
    const [y, m, d] = iso.split('-').map(Number);
    return new Date(y, m - 1, d);
  }
}

/* ---------------------------- Persistence ------------------------------- */
class Store {
  constructor(key) { this.key = key; this.state = this.load(); }
  load() { try { return JSON.parse(localStorage.getItem(this.key) || '{}'); } catch { return {}; } }
  save() { localStorage.setItem(this.key, JSON.stringify(this.state)); }
  get(k, def = null) { return (k in this.state) ? this.state[k] : def; }
  set(k, v) { this.state[k] = v; this.save(); }
}

/* ------------------------------ Theme ----------------------------------- */
class Theme {
  constructor() {
    this.store = new Store('mc-theme-v2');
    this.root = document.documentElement;
  }
  
  init() {
    $('#toggle-theme')?.addEventListener('click', () => this.cycle());
    this.apply(this.store.get('theme', 'auto'));
  }
  
  apply(mode) {
    this.root.classList.remove('theme--light', 'theme--dark');
    if (mode === 'light' || mode === 'dark') this.root.classList.add(`theme--${mode}`);
    this.store.set('theme', mode);
    toast(`Theme: ${mode}`, 'info');
  }
  
  cycle() {
    const cur = this.store.get('theme', 'auto');
    const next = (cur === 'auto') ? 'dark' : (cur === 'dark') ? 'light' : 'auto';
    this.apply(next);
  }
}

/* ---------------------------- Itinerary --------------------------------- */
class Itinerary {
  constructor(state) { this.state = state; }
  
  init() {
    this.daystrip = $('#daystrip');
    this.body = $('#itinerary-body');
    this.banner = $('#today-banner .mono');
    this.renderDaystrip();
    this.renderTable();
    this.updateBanner();
    $('#jump-today')?.addEventListener('click', () => this.jumpToToday());
    $('#copy-itin')?.addEventListener('click', () => this.copyItin());
  }

  renderDaystrip() {
    if (!this.daystrip) return;
    this.daystrip.innerHTML = '';
    const today = this.state.todayISO();

    this.state.itinerary.forEach(d => {
      const b = document.createElement('button');
      b.className = 'daychip';
      b.type = 'button';
      b.innerHTML = `
        <div class="daychip__day">${d.icon} Day ${d.day} ¬∑ ${d.label}</div>
        <div class="daychip__label">${d.port}</div>
      `;
      if (d.date === today) {
        b.classList.add('daychip--today');
        b.setAttribute('aria-current', 'true');
      }
      b.addEventListener('click', () => this.scrollToDay(d.day));
      this.daystrip.appendChild(b);
    });

    const cur = this.daystrip.querySelector('.daychip--today');
    cur?.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }

  renderTable() {
    if (!this.body) return;
    this.body.innerHTML = '';
    const today = this.state.todayISO();

    this.state.itinerary.forEach(d => {
      const tr = document.createElement('tr');
      if (d.date === today) tr.className = 'table__row--today';
      tr.innerHTML = `
        <td><b>${d.icon} Day ${d.day}</b><br><span style="color:var(--muted);font-size:.85rem">${d.label}</span></td>
        <td>${d.port}</td>
        <td style="font-family:var(--mono)">${d.time}</td>
        <td><button class="pill" data-day="${d.day}" style="font-size:.8rem">Jump</button></td>
      `;
      this.body.appendChild(tr);
    });
    
    // Add event listeners to jump buttons
    $$('[data-day]', this.body).forEach(btn => {
      btn.addEventListener('click', (e) => {
        const day = e.target.dataset.day;
        this.scrollToDay(day);
      });
    });
  }

  updateBanner() {
    const today = new Date();
    const todayISO = this.state.todayISO();
    const first = this.state.parse(this.state.itinerary[0].date);
    const last = this.state.parse(this.state.itinerary[this.state.itinerary.length - 1].date);

    let status = 'Pre-cruise';
    const item = this.state.itinerary.find(x => x.date === todayISO);
    if (item) status = `${item.icon} Day ${item.day}: ${item.port}`;
    else if (today > last) status = 'Post-cruise';

    if (this.banner) this.banner.textContent = status;
    document.dispatchEvent(new CustomEvent('mc:today', { detail: { status } }));
  }

  jumpToToday() {
    const iso = this.state.todayISO();
    const item = this.state.itinerary.find(x => x.date === iso);
    if (!item) return smoothTo($('#top'));
    this.scrollToDay(item.day);
    toast(`Jumped to Day ${item.day}: ${item.port}`, 'info');
  }

  scrollToDay(day) {
    const map = {
      1: '#embarkation', 2: '#sea-days', 3: '#port-days', 4: '#port-days',
      5: '#sea-days', 6: '#port-days', 7: '#disembarkation'
    };
    const id = map[day] || '#top';
    smoothTo($(id));
    history.replaceState(null, '', id);
  }

  copyItin() {
    const lines = this.state.itinerary.map(d => `Day ${d.day} (${d.label}): ${d.port} ‚Äî ${d.time}`);
    navigator.clipboard?.writeText(lines.join('\n'))
      .then(() => toast('Itinerary copied to clipboard', 'success'))
      .catch(() => toast('Copy failed', 'error'));
  }
}

/* ---------------------------- Task System -------------------------------- */
class Tasks {
  constructor() {
    this.store = new Store('mc-tasks-v3');
  }
  
  init() {
    this.bindCheckboxes();
    document.addEventListener('filters:applied', () => this.updateAllProgress());
    document.addEventListener('mc:today', () => this.updateAllProgress());
    this.updateAllProgress();
  }

  bindCheckboxes() {
    $$('.task[data-task-id]').forEach(task => {
      const id = task.getAttribute('data-task-id');
      const cb = $('.task__check', task);
      if (!id || !cb) return;

      cb.checked = !!this.store.get(id, false);
      task.classList.toggle('task--done', cb.checked);

      cb.addEventListener('change', () => {
        this.store.set(id, cb.checked);
        task.classList.toggle('task--done', cb.checked);
        this.updateAllProgress();
        
        // Celebrate when all tasks in a chapter are complete
        const chapter = task.closest('.chapter');
        if (chapter) {
          const chapterProgress = this.chapterProgress(chapter);
          if (chapterProgress.pct === 100) {
            createConfetti();
            toast(`Chapter ${chapter.dataset.chapter} complete!`, 'success');
          }
        }
      });
    });
  }

  chapterProgress(chapterEl) {
    const tasks = $$('.task[data-task-id]', chapterEl).filter(t => t.style.display !== 'none');
    const total = tasks.length;
    if (!total) return { done: 0, total: 0, pct: 100 };
    let done = 0;
    tasks.forEach(t => {
      const id = t.getAttribute('data-task-id');
      if (id && this.store.get(id, false)) done++;
    });
    const pct = Math.round((done / total) * 100);
    return { done, total, pct };
  }

  updateAllProgress() {
    // per chapter
    $$('.chapter').forEach(ch => {
      const chip = $('[data-chapter-progress]', ch);
      if (!chip) return;
      const p = this.chapterProgress(ch);
      chip.innerHTML = `<b>${p.pct}%</b> done`;
    });

    // overall
    const all = $$('.task[data-task-id]').filter(t => t.style.display !== 'none');
    const total = all.length;
    let done = 0;
    all.forEach(t => {
      const id = t.getAttribute('data-task-id');
      if (id && this.store.get(id, false)) done++;
    });
    const pct = total ? Math.round((done / total) * 100) : 100;
    $('#overall-progress')?.textContent = `${pct}%`;
  }

  nextMustDo() {
    // pick first visible critical not done, else warning not done, else any not done
    const pick = (sel) => $$(sel).find(t => {
      if (t.style.display === 'none') return false;
      const id = t.getAttribute('data-task-id');
      return id ? !this.store.get(id, false) : false;
    });

    return pick('.task.task--crit') || pick('.task.task--warn') || pick('.task[data-task-id]');
  }
}

/* ------------------------------ Filters ---------------------------------- */
class Filters {
  init() {
    this.filters = {
      crit: $('#filter-crit'),
      warn: $('#filter-warn'),
      ok: $('#filter-ok'),
      info: $('#filter-info'),
    };
    this.focus = $('#focus-mode');

    Object.values(this.filters).forEach(cb => cb?.addEventListener('change', () => this.apply()));
    this.focus?.addEventListener('change', () => this.apply());

    $('#expand-all')?.addEventListener('click', () => this.expandAll(true));
    $('#collapse-all')?.addEventListener('click', () => this.expandAll(false));

    this.apply();
  }

  apply() {
    const allow = {
      crit: this.filters.crit?.checked ?? true,
      warn: this.filters.warn?.checked ?? true,
      ok: this.filters.ok?.checked ?? true,
      info: this.filters.info?.checked ?? true,
    };

    $$('.task').forEach(t => {
      const level =
        t.classList.contains('task--crit') ? 'crit' :
        t.classList.contains('task--warn') ? 'warn' :
        t.classList.contains('task--ok') ? 'ok' :
        t.classList.contains('task--info') ? 'info' : null;
      t.style.display = (level && allow[level]) ? '' : 'none';
    });

    const focus = this.focus?.checked ?? false;
    $$('.p, .kv, ul.list, .h').forEach(el => el.style.display = focus ? 'none' : '');

    document.dispatchEvent(new CustomEvent('filters:applied'));
    
    const activeFilters = Object.values(allow).filter(v => v).length;
    toast(`${activeFilters} filter${activeFilters !== 1 ? 's' : ''} active`, 'info');
  }

  expandAll(open) {
    // chapter bodies
    $$('.chapter').forEach(ch => {
      const body = $('.chapter__body', ch);
      if (body) body.style.display = open ? '' : 'none';
    });
    // sections (details)
    $$('details.section').forEach(d => d.open = open);
    
    toast(`${open ? 'Expanded' : 'Collapsed'} all sections`, 'info');
  }
}

/* ------------------------------ TOC -------------------------------------- */
class TOC {
  init() {
    this.toc = $('#toc');
    this.build();
  }

  build() {
    if (!this.toc) return;
    this.toc.innerHTML = '';

    $$('.chapter').forEach((ch, idx) => {
      const id = ch.id;
      const num = ch.dataset.chapter || String(idx + 1);
      const title = $('.chapter__title', ch)?.textContent?.trim() || `Section ${num}`;

      const counts = {
        crit: $$('.task--crit', ch).length,
        warn: $$('.task--warn', ch).length,
        ok: $$('.task--ok', ch).length,
        info: $$('.task--info', ch).length,
      };

      const metaBits = [];
      if (counts.crit) metaBits.push(`üî¥ ${counts.crit}`);
      if (counts.warn) metaBits.push(`üü° ${counts.warn}`);
      if (counts.ok) metaBits.push(`üü¢ ${counts.ok}`);
      if (counts.info) metaBits.push(`üîµ ${counts.info}`);

      const li = document.createElement('li');
      li.className = 'toc__item';
      li.innerHTML = `
        <a class="toc__link" href="#${id}">
          <span class="toc__num">${num}</span>
          <span class="toc__content">
            <div class="toc__title">${title}</div>
            <div class="toc__meta">${metaBits.map(x => `<span class="pill">${x}</span>`).join('')}</div>
          </span>
        </a>
      `;
      $('a', li).addEventListener('click', (e) => {
        e.preventDefault();
        smoothTo(document.getElementById(id));
        history.replaceState(null, '', `#${id}`);
        toast(`Jumped to ${title}`, 'info');
      });

      this.toc.appendChild(li);
    });
  }
}

/* ------------------------------ Search ----------------------------------- */
class Search {
  init() {
    this.input = $('#search-input');
    this.count = $('#search-count');
    this.pos = $('#search-pos');
    this.main = $('#main');
    this.hits = [];
    this.idx = 0;

    if (!this.input) return;

    let timer;
    this.input.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(() => this.run(this.input.value), 120);
    });

    this.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (!this.input.value.trim()) return;
        if (!this.hits.length) this.run(this.input.value);
        else this.jump(this.idx + 1);
      } else if (e.key === 'Escape') {
        e.preventDefault();
        this.clear();
      }
    });
  }

  clearMarks() {
    if (!this.main) return;
    $$('mark.hit', this.main).forEach(m => {
      const t = document.createTextNode(m.textContent);
      m.parentNode.replaceChild(t, m);
      m.parentNode.normalize();
    });
  }

  clear() {
    this.input.value = '';
    this.clearMarks();
    this.hits = [];
    this.idx = 0;
    this.updateMeta();
  }

  updateMeta() {
    if (this.count) this.count.textContent = String(this.hits.length);
    if (this.pos) this.pos.textContent = this.hits.length ? `${this.idx + 1}/${this.hits.length}` : '0/0';
  }

  escape(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

  run(q) {
    this.clearMarks();
    this.hits = [];
    this.idx = 0;

    const query = q.trim();
    if (!query) { this.updateMeta(); return; }

    const rx = new RegExp(this.escape(query), 'gi');
    const scopes = ['#chapters', '.hero', '.dashboard']
      .map(sel => $(sel)).filter(Boolean);

    const walkerAccept = (node) => {
      if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
      const p = node.parentElement;
      if (!p) return NodeFilter.FILTER_REJECT;
      if (p.closest('.sidebar') || p.closest('.palette') || p.closest('script') || p.closest('style')) return NodeFilter.FILTER_REJECT;
      return NodeFilter.FILTER_ACCEPT;
    };

    scopes.forEach(scope => {
      const walker = document.createTreeWalker(scope, NodeFilter.SHOW_TEXT, { acceptNode: walkerAccept });
      const nodes = [];
      while (walker.nextNode()) nodes.push(walker.currentNode);

      nodes.forEach(textNode => {
        const text = textNode.nodeValue;
        rx.lastIndex = 0;
        if (!rx.test(text)) return;
        rx.lastIndex = 0;

        const frag = document.createDocumentFragment();
        let last = 0, m;
        while ((m = rx.exec(text)) !== null) {
          const s = m.index;
          const e = s + m[0].length;
          if (s > last) frag.appendChild(document.createTextNode(text.slice(last, s)));
          const mark = document.createElement('mark');
          mark.className = 'hit';
          mark.textContent = text.slice(s, e);
          frag.appendChild(mark);
          this.hits.push(mark);
          last = e;
          if (m.index === rx.lastIndex) rx.lastIndex++;
        }
        if (last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
        textNode.parentNode.replaceChild(frag, textNode);
      });
    });

    this.updateMeta();
    if (this.hits.length) {
      this.jump(0);
      toast(`Found ${this.hits.length} match${this.hits.length !== 1 ? 'es' : ''}`, 'info');
    } else {
      toast('No matches found', 'warning');
    }
  }

  jump(i) {
    if (!this.hits.length) return;
    this.idx = ((i % this.hits.length) + this.hits.length) % this.hits.length;
    const hit = this.hits[this.idx];
    smoothTo(hit, { block: 'center' });
    hit.style.outline = '2px solid rgba(125,211,252,.75)';
    hit.style.outlineOffset = '2px';
    hit.style.boxShadow = '0 0 10px rgba(125,211,252,.5)';
    setTimeout(() => { 
      hit.style.outline = ''; 
      hit.style.outlineOffset = ''; 
      hit.style.boxShadow = ''; 
    }, 1000);
    this.updateMeta();
  }
}

/* --------------------------- Command Palette ----------------------------- */
class Palette {
  init() {
    this.el = $('#palette');
    this.input = $('#palette-input');
    this.list = $('#palette-list');
    if (!this.el || !this.input || !this.list) return;

    $('#open-palette')?.addEventListener('click', () => this.open());
    $('#fab-command')?.addEventListener('click', () => this.open());

    this.input.addEventListener('input', () => this.render());
    this.input.addEventListener('keydown', (e) => this.onKey(e));

    this.el.addEventListener('click', (e) => { if (e.target === this.el) this.close(); });

    document.addEventListener('keydown', (e) => {
      const isMac = navigator.platform.toUpperCase().includes('MAC');
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if (mod && e.key.toLowerCase() === 'k') { e.preventDefault(); this.open(); }
      if (e.key === 'Escape' && this.el.getAttribute('aria-hidden') === 'false') { e.preventDefault(); this.close(); }
    });

    this.commands = [];
  }

  buildCommands() {
    const base = [
      { id: 'today', icon: 'üìç', title: 'Jump to Today', sub: 'Auto-scroll to today\'s relevant section', k: 'T', run: () => $('#jump-today')?.click() },
      { id: 'focus', icon: 'üéØ', title: 'Toggle Focus Mode', sub: 'Show tasks only', k: 'F', run: () => { const t = $('#focus-mode'); if (t) { t.checked = !t.checked; t.dispatchEvent(new Event('change')); } } },
      { id: 'expand', icon: '‚ÜïÔ∏è', title: 'Expand everything', sub: 'Open all sections and bodies', k: 'E', run: () => $('#expand-all')?.click() },
      { id: 'collapse', icon: '‚ÜïÔ∏è', title: 'Collapse everything', sub: 'Hide bodies and close sections', k: 'C', run: () => $('#collapse-all')?.click() },
      { id: 'print', icon: 'üñ®Ô∏è', title: 'Print / Save PDF', sub: 'Open print dialog', k: 'P', run: () => window.print() },
      { id: 'theme', icon: 'üåì', title: 'Cycle theme', sub: 'auto ‚Üí dark ‚Üí light', k: 'M', run: () => $('#toggle-theme')?.click() },
      { id: 'confetti', icon: 'üéâ', title: 'Celebrate!', sub: 'Trigger celebration effect', k: 'üéä', run: () => { createConfetti(); toast('Celebration!', 'success'); } },
    ];

    const chapters = $$('.chapter').map(ch => {
      const id = ch.id;
      const num = ch.dataset.chapter || '?';
      const title = $('.chapter__title', ch)?.textContent?.trim() || 'Section';
      return { id: `ch-${id}`, icon: '¬ß', title: `${num} ¬∑ ${title}`, sub: 'Jump to section', k: '#', run: () => smoothTo(ch) };
    });

    this.commands = [...base, ...chapters];
  }

  open() {
    this.el.setAttribute('aria-hidden', 'false');
    this.buildCommands();
    this.input.value = '';
    this.render();
    setTimeout(() => { this.input.focus(); this.input.select(); }, 0);
  }

  close() {
    this.el.setAttribute('aria-hidden', 'true');
    this.input.blur();
  }

  render() {
    const q = this.input.value.trim().toLowerCase();
    const cmds = this.commands.filter(c => !q || c.title.toLowerCase().includes(q) || c.sub.toLowerCase().includes(q));
    this.list.innerHTML = '';

    if (!cmds.length) {
      const div = document.createElement('div');
      div.style.padding = '16px';
      div.style.textAlign = 'center';
      div.style.color = 'var(--muted)';
      div.textContent = 'No matches found';
      this.list.appendChild(div);
      return;
    }

    cmds.forEach((c, idx) => {
      const li = document.createElement('li');
      li.className = 'cmd';
      li.setAttribute('role', 'option');
      li.setAttribute('tabindex', idx === 0 ? '0' : '-1');
      li.setAttribute('aria-selected', idx === 0 ? 'true' : 'false');
      li.innerHTML = `
        <div class="cmd__left">
          <div class="cmd__ic" aria-hidden="true">${c.icon}</div>
          <div class="cmd__text">
            <div class="cmd__title">${c.title}</div>
            <div class="cmd__sub">${c.sub}</div>
          </div>
        </div>
        <div class="cmd__kbd">${c.k}</div>
      `;
      li.addEventListener('click', () => { this.close(); c.run(); });
      li.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.close(); c.run(); }
      });
      this.list.appendChild(li);
    });
  }

  onKey(e) {
    if (e.key === 'Escape') { e.preventDefault(); this.close(); return; }
    if (e.key === 'Enter') { e.preventDefault(); $('.cmd[aria-selected="true"]', this.list)?.click(); return; }
    if (e.key === 'ArrowDown') { e.preventDefault(); this.nav(1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); this.nav(-1); return; }
  }

  nav(dir) {
    const items = $$('.cmd', this.list);
    if (!items.length) return;
    const cur = items.findIndex(x => x.getAttribute('aria-selected') === 'true');
    let next = cur + dir;
    if (next < 0) next = items.length - 1;
    if (next >= items.length) next = 0;
    items.forEach((it, i) => {
      it.setAttribute('aria-selected', i === next ? 'true' : 'false');
      it.tabIndex = i === next ? 0 : -1;
    });
    items[next].focus();
  }
}

/* ------------------------- Scroll Progress -------------------------------- */
class ProgressBar {
  init() {
    this.bar = $('#progress');
    if (!this.bar) return;
    window.addEventListener('scroll', () => this.update(), { passive: true });
    this.update();
  }
  
  update() {
    const doc = document.documentElement;
    const top = window.scrollY || doc.scrollTop;
    const height = doc.scrollHeight - doc.clientHeight;
    if (height <= 0) return;
    this.bar.style.width = `${clamp((top / height) * 100, 0, 100)}%`;
  }
}

/* ------------------------------ KPIs ------------------------------------- */
class KPIs {
  constructor(state, tasks) { this.state = state; this.tasks = tasks; }
  
  init() {
    this.kNext = $('#kpi-next');
    this.kCountdown = $('#kpi-countdown');
    this.kToday = $('#kpi-today');
    this.kVisible = $('#kpi-visible');

    this.updateAll();
    document.addEventListener('filters:applied', () => this.updateAll());
    document.addEventListener('mc:today', () => this.updateAll());
    setInterval(() => this.updateCountdown(), 60_000);
  }

  updateAll() {
    this.updateNext();
    this.updateCountdown();
    this.updateToday();
    this.updateVisible();
  }

  updateNext() {
    if (!this.kNext) return;
    const t = this.tasks.nextMustDo();
    this.kNext.textContent = t ? t.textContent.trim().replace(/\s+/g, ' ').slice(0, 120) + '...' : '‚Äî';
  }

  updateCountdown() {
    if (!this.kCountdown) return;
    const sail = this.state.parse(this.state.itinerary[0].date);
    const now = new Date();
    const ms = sail - now;
    if (ms <= 0) { this.kCountdown.textContent = 'Sailing (or sailed)'; return; }
    const days = Math.floor(ms / (1000 * 60 * 60 * 24));
    const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
    this.kCountdown.textContent = `${days}d ${hours}h ${mins}m`;
  }

  updateToday() {
    if (!this.kToday) return;
    const iso = this.state.todayISO();
    const item = this.state.itinerary.find(d => d.date === iso);
    this.kToday.textContent = item ? `${item.icon} Day ${item.day} ¬∑ ${item.port}` : 'Not within sail dates';
  }

  updateVisible() {
    if (!this.kVisible) return;
    const visible = $$('.task').filter(t => t.style.display !== 'none').length;
    const total = $$('.task').length;
    this.kVisible.textContent = `${visible}/${total}`;
  }
}

/* --------------------------- Chapter Renderer ---------------------------- */
class ChapterRenderer {
  constructor(state) {
    this.state = state;
  }
  
  init() {
    this.renderChapters();
    bindChapterToggles();
  }
  
  renderChapters() {
    const container = $('#chapters');
    if (!container) return;
    
    container.innerHTML = '';
    
    this.state.chapters.forEach(chapter => {
      const chapterEl = document.createElement('article');
      chapterEl.className = 'chapter';
      chapterEl.id = chapter.id;
      chapterEl.dataset.chapter = chapter.num;
      
      // Build sections HTML
      let sectionsHTML = '';
      chapter.sections.forEach(section => {
        let tasksHTML = '';
        if (section.tasks && section.tasks.length) {
          tasksHTML = section.tasks.map(task => `
            <div class="task task--${task.type}" data-task-id="${task.id}">
              <input class="task__check" type="checkbox" aria-label="Mark task done">
              <div class="task__emoji">${task.emoji}</div>
              <div class="task__text">${task.text}</div>
            </div>
          `).join('');
        }
        
        sectionsHTML += `
          <details class="section" open>
            <summary>
              <div class="left">
                <span class="pill">${section.type}</span>
                <span class="title">${section.title}</span>
              </div>
              <div class="meta">
                <span>${section.icon}</span>
                <svg class="chev" viewBox="0 0 24 24" width="18" height="18" fill="none" aria-hidden="true">
                  <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </summary>
            <div class="section__body">
              ${section.content}
              ${tasksHTML}
            </div>
          </details>
        `;
      });
      
      chapterEl.innerHTML = `
        <header class="chapter__header">
          <div class="chapter__left">
            <div class="chapter__num">${chapter.num.toString().padStart(2, '0')}</div>
            <h3 class="chapter__title">${chapter.title}</h3>
          </div>
          <div class="chapter__right">
            <span class="progress-chip" data-chapter-progress><b>0%</b> done</span>
            <button class="icon-btn" data-chapter-toggle aria-label="Toggle chapter body" title="Collapse/Expand">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </header>
        <div class="chapter__body">
          ${sectionsHTML}
        </div>
      `;
      
      container.appendChild(chapterEl);
    });
  }
}

/* --------------------------- Chapter Toggles ------------------------------ */
function bindChapterToggles() {
  $$('.chapter').forEach(ch => {
    const btn = $('[data-chapter-toggle]', ch);
    const body = $('.chapter__body', ch);
    if (!btn || !body) return;
    btn.addEventListener('click', () => {
      const hidden = body.style.display === 'none';
      body.style.display = hidden ? '' : 'none';
      btn.style.transform = hidden ? 'rotate(0deg)' : 'rotate(180deg)';
    });
  });
}

/* ------------------------------ FAB -------------------------------------- */
function bindFab() {
  $('#fab-top')?.addEventListener('click', () => {
    smoothTo($('#top'));
    toast('Back to top', 'info');
  });
  
  $('#fab-help')?.addEventListener('click', () => {
    toast('Press Ctrl/‚åòK for commands, Enter to cycle search results', 'info');
  });
}

/* ------------------------------ Print ------------------------------------ */
function bindPrint() {
  $('#print-btn')?.addEventListener('click', () => {
    toast('Opening print dialog...', 'info');
    setTimeout(() => window.print(), 300);
  });
}

/* ------------------------------ Boot ------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  // Hide loading screen
  setTimeout(() => {
    $('#loading').classList.add('hidden');
  }, 800);
  
  // Initialize all components
  const state = new AppState();
  const theme = new Theme(); theme.init();
  const itin = new Itinerary(state); itin.init();
  const chapterRenderer = new ChapterRenderer(state); chapterRenderer.init();
  const filters = new Filters(); filters.init();
  const tasks = new Tasks(); tasks.init();
  const toc = new TOC(); toc.init();
  const search = new Search(); search.init();
  const palette = new Palette(); palette.init();
  const pb = new ProgressBar(); pb.init();
  const kpi = new KPIs(state, tasks); kpi.init();

  bindFab();
  bindPrint();
  bindChapterToggles();

  // hash nav
  if (window.location.hash) {
    setTimeout(() => {
      smoothTo($(window.location.hash));
    }, 500);
  }

  toast('Mission Control 2.0 Ready üö¢', 'success');
  
  // Add a subtle welcome animation
  setTimeout(() => {
    document.querySelectorAll('.hero__badges .badge').forEach((badge, i) => {
      setTimeout(() => {
        badge.style.transform = 'translateY(0)';
        badge.style.opacity = '1';
      }, i * 100);
    });
  }, 300);
});
  </script>
</body>
</html>