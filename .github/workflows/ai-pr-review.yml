name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ["main"]
    paths:
      - "**/*.js"
      - "**/*.css"
      - "**/*.html"
      - "tools/**/*.mjs"
      - ".github/workflows/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  ai-review:
    if: ${{ !github.event.pull_request.draft && github.event.pull_request.head.repo.full_name == github.repository && secrets.OPENAI_API_KEY != '' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build PR diff context
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          set -euo pipefail
          git fetch origin "${BASE_REF}" --depth=1
          git diff --unified=2 "origin/${BASE_REF}...HEAD" > /tmp/pr.diff
          git diff --name-only "origin/${BASE_REF}...HEAD" > /tmp/changed_files.txt

      - name: Generate AI review summary
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4.1-mini
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          set -euo pipefail
          node <<'NODE'
          const fs = require('fs');

          const marker = '<!-- ai-pr-review -->';
          const changedFiles = fs.existsSync('/tmp/changed_files.txt')
            ? fs.readFileSync('/tmp/changed_files.txt', 'utf8').trim()
            : '';
          const rawDiff = fs.existsSync('/tmp/pr.diff')
            ? fs.readFileSync('/tmp/pr.diff', 'utf8')
            : '';

          const maxChars = 120000;
          const diff = rawDiff.length > maxChars
            ? `${rawDiff.slice(0, maxChars)}\n\n[Diff truncated at ${maxChars} chars]`
            : rawDiff;

          if (!diff.trim()) {
            fs.writeFileSync('/tmp/ai_review.md', `${marker}\n### AI PR Review\nNo code diff detected.`);
            process.exit(0);
          }

          const prompt = [
            `PR #${process.env.PR_NUMBER}: ${process.env.PR_TITLE}`,
            `URL: ${process.env.PR_URL}`,
            '',
            'Changed files:',
            changedFiles || '(none listed)',
            '',
            'Unified diff:',
            diff,
          ].join('\n');

          const system = 'You are a senior reviewer. Focus on correctness, regressions, security, accessibility, and missing tests. Return concise markdown with sections: Critical, High, Medium, Low, Questions, Summary. If no findings, say "No material issues found."';

          async function main() {
            const res = await fetch('https://api.openai.com/v1/responses', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
              },
              body: JSON.stringify({
                model: process.env.OPENAI_MODEL || 'gpt-4.1-mini',
                input: [
                  { role: 'system', content: [{ type: 'input_text', text: system }] },
                  { role: 'user', content: [{ type: 'input_text', text: prompt }] },
                ],
                max_output_tokens: 900,
              }),
            });

            if (!res.ok) {
              const text = await res.text();
              throw new Error(`OpenAI API ${res.status}: ${text.slice(0, 800)}`);
            }

            const data = await res.json();
            const review = (data.output_text || '').trim() || 'No material issues found.';
            const body = `${marker}\n### AI PR Review\n${review}\n\n_Automated review; validate findings before merge._`;
            fs.writeFileSync('/tmp/ai_review.md', body);
          }

          main().catch((err) => {
            const fallback = `${marker}\n### AI PR Review\nReview could not be generated: ${err.message}`;
            fs.writeFileSync('/tmp/ai_review.md', fallback);
          });
          NODE

      - name: Upsert PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/ai_review.md', 'utf8');
            const marker = '<!-- ai-pr-review -->';
            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(c =>
              c.user?.type === 'Bot' && typeof c.body === 'string' && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
