<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deck Navigator ¬∑ DIAGNOSTIC</title>
  <style>
    /* Reset & minimal layout */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
    }
    header {
      background: #222;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border-bottom: 1px solid #444;
    }
    .spacer { flex: 1; }
    .btn, .pill {
      background: #333;
      border: 1px solid #555;
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 999px;
      cursor: pointer;
    }
    .viewer {
      position: fixed;
      top: 60px; left: 0; right: 0; bottom: 0;
      background: #1a1a1a;
    }
    .frame {
      position: absolute;
      inset: 20px;
      background: #000;  /* solid black so green stands out */
      border: 2px solid cyan;
      overflow: hidden;
    }
    .stage {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .panZoom {
      transform-origin: 0 0;
      transition: none; /* no transitions for diagnostic */
    }
    #svgContainer {
      display: block;
    }
    /* FORCE ALL SVG CONTENT TO BE VISIBLE */
    #inlineSvg * {
      fill: lime !important;
      stroke: black !important;
      stroke-width: 2 !important;
      opacity: 1 !important;
      filter: none !important;
    }
    /* Controls (minimal) */
    .controls {
      position: absolute;
      bottom: 20px; right: 20px;
      display: flex;
      gap: 10px;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 40px;
    }
    button {
      width: 44px; height: 44px;
      border-radius: 22px;
      background: #333;
      border: 1px solid #666;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }
    .dock {
      position: absolute;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 40px;
      color: white;
      font-weight: bold;
    }
    .modal {
      display: none; /* simplified */
    }
    /* Overlay minimal */
    .overlay {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 2rem;
      border-radius: 1rem;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
    }
    .overlay.show { display: block; }
  </style>
</head>
<body>
  <header>
    <span>üîç DECK DIAGNOSTIC</span>
    <div class="spacer"></div>
    <span class="pill" id="deckPill">Deck 4</span>
    <button class="btn" id="openDecksBtn">Decks</button>
  </header>

  <div class="viewer">
    <div class="frame" id="frame">
      <div class="stage" id="stage">
        <div class="panZoom" id="panZoom">
          <div id="svgContainer"></div>
        </div>
      </div>

      <!-- Minimal overlays -->
      <div class="overlay" id="loadingOverlay">Loading...</div>
      <div class="overlay" id="errorOverlay" style="background: darkred;">Error</div>

      <div class="controls">
        <button id="zoomInBtn">+</button>
        <button id="zoomOutBtn">‚àí</button>
        <button id="resetBtn">‚ü≤</button>
      </div>
      <div class="dock" id="zoomReadout">100%</div>
    </div>
  </div>

  <script>
    (() => {
      'use strict';
      console.clear();

      const DECK_MANIFEST = [2,3,4,5,6,7,8,9,10,11,12,14].map(n => ({
        num: n,
        id: String(n).padStart(2,'0'),
        path: `decks/deck-${String(n).padStart(2,'0')}-final.min.svg`
      }));

      const frame = document.getElementById('frame');
      const panZoom = document.getElementById('panZoom');
      const svgContainer = document.getElementById('svgContainer');
      const deckPill = document.getElementById('deckPill');
      const loading = document.getElementById('loadingOverlay');
      const errorEl = document.getElementById('errorOverlay');
      const zoomReadout = document.getElementById('zoomReadout');

      let currentDeckIndex = 4; // start at deck 4 (adjust as needed)
      let scale = 1, tx = 0, ty = 0;
      const minScale = 0.2, maxScale = 5;

      function applyTransform() {
        panZoom.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
        zoomReadout.textContent = Math.round(scale * 100) + '%';
      }

      function fitSvg() {
        const svg = document.getElementById('inlineSvg');
        if (!svg) return;

        const frameRect = frame.getBoundingClientRect();
        const vb = svg.viewBox.baseVal;
        if (!vb || vb.width === 0 || vb.height === 0) {
          console.error('No viewBox');
          return;
        }

        const scaleX = frameRect.width / vb.width;
        const scaleY = frameRect.height / vb.height;
        scale = Math.min(scaleX, scaleY) * 0.95; // 5% margin
        tx = (frameRect.width - vb.width * scale) / 2;
        ty = (frameRect.height - vb.height * scale) / 2;
        applyTransform();
        console.log('Fit:', { scale, tx, ty, frameRect, vb });
      }

      async function loadDeck(index) {
        const deck = DECK_MANIFEST[index];
        if (!deck) return;

        loading.classList.add('show');
        errorEl.classList.remove('show');

        try {
          const res = await fetch(deck.path);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const svgText = await res.text();

          const parser = new DOMParser();
          const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
          let svg = svgDoc.documentElement;

          // Ensure viewBox
          if (!svg.hasAttribute('viewBox')) {
            const w = parseFloat(svg.getAttribute('width'));
            const h = parseFloat(svg.getAttribute('height'));
            if (!isNaN(w) && !isNaN(h)) {
              svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
            } else {
              // Fallback to bbox
              document.body.appendChild(svg.cloneNode(true));
              const bbox = svg.getBBox();
              svg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
            }
          }

          // Clear and inject
          while (svgContainer.firstChild) svgContainer.removeChild(svgContainer.firstChild);
          svgContainer.appendChild(svg);
          svg.id = 'inlineSvg';

          deckPill.textContent = `Deck ${deck.num}`;

          // Fit after injection
          requestAnimationFrame(() => {
            fitSvg();
            loading.classList.remove('show');
          });

          console.log('SVG viewBox:', svg.viewBox.baseVal);
        } catch (err) {
          console.error(err);
          errorEl.classList.add('show');
          loading.classList.remove('show');
        }
      }

      // Simple zoom controls
      document.getElementById('zoomInBtn').onclick = () => {
        scale = Math.min(scale * 1.2, maxScale);
        applyTransform();
      };
      document.getElementById('zoomOutBtn').onclick = () => {
        scale = Math.max(scale / 1.2, minScale);
        applyTransform();
      };
      document.getElementById('resetBtn').onclick = () => {
        fitSvg();
      };

      // Load deck 4 (or from URL)
      const urlParams = new URLSearchParams(location.search);
      const deckParam = urlParams.get('deck');
      if (deckParam) {
        const idx = DECK_MANIFEST.findIndex(d => d.num == deckParam);
        if (idx >= 0) currentDeckIndex = idx;
      }
      loadDeck(currentDeckIndex);

      // Re-fit on resize
      window.addEventListener('resize', () => {
        if (document.getElementById('inlineSvg')) fitSvg();
      });
    })();
  </script>
</body>
</html>