<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Deck Navigator · Adventure of the Seas</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Plus+Jakarta+Sans:wght@700;800;900&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* ----- RESET & VARIABLES (merged) ----- */
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html{scroll-behavior:smooth}
  body{font-family:'Inter',system-ui,sans-serif;background:#071a2c;color:#fff;min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased;padding-bottom:calc(1.5rem + env(safe-area-inset-bottom,0px))}
  button{cursor:pointer;font:inherit;border:none;background:none;color:inherit}
  a{color:inherit;text-decoration:none}
  :root{
    --navy:#0a2e4a;--accent:#00b4e6;--gold:#ffd740;
    --glass:rgba(255,255,255,.07);--brd:rgba(255,255,255,.11);
    --ease:cubic-bezier(.22,.61,.36,1);
  }

  /* ----- OCEAN ----- */
  #ocean{position:fixed;inset:0;z-index:-2}
  .vignette{position:fixed;inset:0;z-index:-1;pointer-events:none;
    background:radial-gradient(ellipse at 50% 20%,rgba(0,180,230,.1),transparent 55%),
               linear-gradient(180deg,rgba(0,0,0,.08),rgba(0,0,0,.45))}

  /* ----- HEADER ----- */
  header{position:sticky;top:0;z-index:200;background:rgba(10,46,74,.72);backdrop-filter:blur(16px);border-bottom:1px solid var(--brd)}
  .hdr{max-width:900px;margin:0 auto;height:56px;padding:0 1rem;display:flex;align-items:center;gap:.65rem}
  .brand-title{font-family:'Plus Jakarta Sans',sans-serif;font-weight:900;font-size:.95rem;line-height:1.1}
  .brand-sub{font-size:.67rem;color:rgba(255,255,255,.5)}
  .spacer{flex:1}
  .hdr-pill{display:inline-flex;align-items:center;gap:.35rem;background:rgba(255,215,64,.12);border:1px solid rgba(255,215,64,.28);color:var(--gold);padding:.28rem .7rem;border-radius:999px;font-weight:800;font-size:.7rem;white-space:nowrap}
  .hdr-btn{width:36px;height:36px;border-radius:50%;border:1px solid var(--brd);background:var(--glass);display:grid;place-items:center;font-size:.85rem}

  /* ----- HERO ----- */
  .hero{max-width:900px;margin:0 auto;padding:2rem 1rem .75rem;text-align:center}
  .hero h1{font-family:'Plus Jakarta Sans',sans-serif;font-weight:900;font-size:clamp(1.7rem,5vw,2.6rem);letter-spacing:-.02em;margin-bottom:.3rem}
  .hero p{color:rgba(255,255,255,.55);font-size:.9rem;font-weight:500}

  /* ----- SEARCH ----- */
  .search-wrap{max-width:900px;margin:.75rem auto 0;padding:0 1rem}
  .search-box{display:flex;align-items:center;gap:.55rem;background:rgba(255,255,255,.09);border:1px solid var(--brd);border-radius:999px;padding:.5rem 1rem;transition:.18s}
  .search-box:focus-within{border-color:rgba(0,180,230,.5);background:rgba(255,255,255,.12)}
  .search-box i{color:var(--gold);flex-shrink:0;font-size:.85rem}
  .search-box input{background:transparent;border:none;outline:none;color:#fff;width:100%;font-size:.9rem}
  .search-box input::placeholder{color:rgba(255,255,255,.38)}

  /* ----- FILTER PILLS ----- */
  .filters{display:flex;gap:.4rem;overflow-x:auto;padding:.75rem 1rem;max-width:900px;margin:0 auto;scrollbar-width:none}
  .filters::-webkit-scrollbar{display:none}
  .f-btn{background:var(--glass);border:1px solid var(--brd);border-radius:999px;padding:.42rem .95rem;font-weight:700;font-size:.78rem;color:rgba(255,255,255,.8);white-space:nowrap;transition:.18s}
  .f-btn.active{background:var(--accent);color:var(--navy);border-color:var(--accent)}

  /* ----- CONTENT ----- */
  .content{max-width:900px;margin:0 auto;padding:0 1rem}

  /* ----- SECTION HEADER ----- */
  .sec-head{display:flex;align-items:center;gap:.55rem;margin:1.4rem 0 .65rem}
  .sec-icon{width:30px;height:30px;border-radius:10px;display:grid;place-items:center;font-size:.8rem;flex-shrink:0}
  .sec-icon.ent{background:rgba(168,85,247,.2);color:#c084fc}
  .sec-icon.wel{background:rgba(34,197,94,.15);color:#4ade80}
  .sec-icon.ess{background:rgba(0,180,230,.15);color:var(--accent)}
  .sec-title{font-family:'Plus Jakarta Sans',sans-serif;font-weight:900;font-size:.95rem;letter-spacing:.01em}
  .sec-count{margin-left:auto;font-size:.75rem;color:rgba(255,255,255,.38);font-weight:600}

  /* ----- DECK GRID / CARDS ----- */
  .deck-grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  @media(min-width:560px){.deck-grid{grid-template-columns:repeat(3,1fr)}}
  @media(min-width:760px){.deck-grid{grid-template-columns:repeat(4,1fr)}}
  .deck-card{background:var(--glass);border:1px solid var(--brd);border-radius:18px;padding:.85rem .8rem;cursor:pointer;transition:.2s var(--ease);display:flex;flex-direction:column;gap:.45rem;position:relative;overflow:hidden}
  .deck-card::before{content:'';position:absolute;inset:0;opacity:0;background:radial-gradient(ellipse at 50% 0%,rgba(0,180,230,.18),transparent 70%);transition:.2s}
  .deck-card:hover{transform:translateY(-2px);border-color:rgba(0,180,230,.35)}
  .deck-card:hover::before{opacity:1}
  .deck-card:active{transform:scale(.97)}
  .card-top{display:flex;align-items:center;justify-content:space-between}
  .card-num{width:32px;height:32px;border-radius:10px;background:var(--accent);color:var(--navy);font-weight:900;font-size:.8rem;display:grid;place-items:center;flex-shrink:0}
  .card-arrow{color:rgba(255,255,255,.25);font-size:.7rem;transition:.2s}
  .deck-card:hover .card-arrow{color:var(--accent);transform:translateX(2px)}
  .card-name{font-weight:800;font-size:.88rem;line-height:1.2}
  .card-sub{font-size:.72rem;color:var(--gold);font-weight:600;line-height:1.2}
  .card-tags{display:flex;flex-wrap:wrap;gap:.25rem;margin-top:.1rem}
  .card-tag{background:rgba(255,255,255,.08);border-radius:999px;padding:.12rem .5rem;font-size:.65rem;font-weight:600;color:rgba(255,255,255,.7)}

  /* ----- STATEROOM CHIP ROW ----- */
  .cabin-row{display:flex;gap:.4rem;overflow-x:auto;scrollbar-width:none;padding-bottom:.2rem}
  .cabin-row::-webkit-scrollbar{display:none}
  .cabin-chip{display:flex;align-items:center;gap:.4rem;background:var(--glass);border:1px solid var(--brd);border-radius:999px;padding:.45rem .85rem;cursor:pointer;transition:.18s;white-space:nowrap;flex-shrink:0}
  .cabin-chip:hover{background:rgba(255,255,255,.12);border-color:rgba(0,180,230,.3)}
  .cabin-chip:active{transform:scale(.96)}
  .chip-num{width:22px;height:22px;border-radius:50%;background:rgba(0,180,230,.2);color:var(--accent);font-weight:900;font-size:.68rem;display:grid;place-items:center;flex-shrink:0}
  .chip-label{font-size:.78rem;font-weight:700}
  .chip-sub{font-size:.65rem;color:rgba(255,255,255,.45);font-weight:500}

  /* ----- OVERVIEW CARD ----- */
  .overview-card{background:linear-gradient(135deg,rgba(0,180,230,.15),rgba(0,180,230,.05));border:1px solid rgba(0,180,230,.25);border-radius:18px;padding:1rem;cursor:pointer;display:flex;align-items:center;gap:.85rem;transition:.2s var(--ease);margin-bottom:.6rem}
  .overview-card:hover{border-color:rgba(0,180,230,.5);transform:translateY(-1px)}
  .overview-icon{width:42px;height:42px;border-radius:13px;background:rgba(0,180,230,.2);display:grid;place-items:center;font-size:1rem;color:var(--accent);flex-shrink:0}
  .overview-text strong{display:block;font-weight:800;font-size:.95rem;margin-bottom:.15rem}
  .overview-text span{font-size:.78rem;color:rgba(255,255,255,.55)}
  .overview-arrow{margin-left:auto;color:var(--accent);font-size:.85rem}

  /* ----- EMPTY STATE ----- */
  .empty{text-align:center;padding:3rem 1rem;color:rgba(255,255,255,.35);font-weight:600;display:none}
  .empty i{display:block;font-size:2rem;margin-bottom:.5rem;opacity:.4}

  /* ----- MODAL – bottom sheet + premium rail ----- */
  .modal{position:fixed;inset:0;z-index:500;display:none;align-items:flex-end;justify-content:center}
  .modal.open{display:flex}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(10px)}
  .modal-sheet{
    position:relative;z-index:1;background:#0c2d45;
    border:1px solid rgba(255,255,255,.1);
    width:100%;max-width:860px;
    height:92dvh;
    border-radius:26px 26px 0 0;
    display:flex;flex-direction:column;overflow:hidden;
    box-shadow:0 -20px 80px rgba(0,0,0,.5);
    animation:slideUp .26s var(--ease) both
  }
  @keyframes slideUp{from{transform:translateY(56px);opacity:0}to{transform:translateY(0);opacity:1}}
  @media(min-width:600px){
    .modal{align-items:center}
    .modal-sheet{height:88vh;max-height:760px;border-radius:26px;animation:fadeUp .2s var(--ease) both}
    @keyframes fadeUp{from{transform:scale(.97) translateY(8px);opacity:0}to{transform:none;opacity:1}}
  }
  .drag-handle{display:flex;justify-content:center;padding:.55rem 0 .15rem;flex-shrink:0}
  .drag-handle span{width:34px;height:4px;background:rgba(255,255,255,.18);border-radius:4px}
  @media(min-width:600px){.drag-handle{display:none}}
  .modal-bar{display:flex;align-items:center;gap:.45rem;padding:.55rem .9rem .55rem;border-bottom:1px solid rgba(255,255,255,.08);flex-shrink:0}
  .modal-nav{width:34px;height:34px;border-radius:50%;background:var(--glass);border:1px solid var(--brd);display:grid;place-items:center;font-size:.78rem;transition:.15s;flex-shrink:0}
  .modal-nav:disabled{opacity:.25;pointer-events:none}
  .modal-nav:hover:not(:disabled){background:rgba(255,255,255,.14)}
  .modal-titles{flex:1;min-width:0}
  .modal-title{font-weight:900;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .modal-sub{font-size:.68rem;color:rgba(255,255,255,.45);font-weight:500}
  .modal-close-btn{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.08);border:1px solid var(--brd);display:grid;place-items:center;flex-shrink:0}
  .modal-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;position:relative}

  /* Plan viewer: scrollable for pan, and supports premium reveal */
  .plan-viewer{
    position:relative;
    background:linear-gradient(160deg,#1a5577,#267599);
    overflow:auto;
    touch-action:none;
    height:clamp(180px,42vw,380px);
    border-bottom:1px solid rgba(255,255,255,.07);
    overscroll-behavior:contain;
  }

  .plan-img{
    width:100%;
    height:100%;
    object-fit:contain;
    transform-origin:center;
    transition:transform .14s var(--ease), opacity .22s ease;
    display:block;
    pointer-events:none;
    user-select:none;
    opacity:0;
    filter:none;
    will-change:transform, opacity, filter;
  }
  .plan-img.loaded{opacity:1}

  /* Cinematic intro zoom + soft glow */
  .plan-img.intro{
    transform:scale(1.05);
    animation:cinematicZoom 700ms var(--ease) both;
  }
  @keyframes cinematicZoom{to{transform:scale(1)}}
  .plan-img.glow{
    filter:drop-shadow(0 0 22px rgba(0,180,230,.35));
  }

  /* Light sweep overlay */
  .plan-viewer::after{
    content:'';
    position:absolute; inset:0;
    pointer-events:none;
    opacity:0;
    background:linear-gradient(
      110deg,
      transparent 0%,
      rgba(255,215,64,.06) 40%,
      rgba(255,215,64,.16) 50%,
      rgba(255,215,64,.06) 60%,
      transparent 100%
    );
    background-size:200% 100%;
    transform:translateZ(0);
  }
  .plan-viewer.light-sweep::after{
    opacity:1;
    animation:sweep 900ms ease forwards;
  }
  @keyframes sweep{
    from{background-position:200% 0}
    to{background-position:-200% 0}
  }

  /* Hotspots overlay */
  .hotspots-layer{position:absolute;inset:0;pointer-events:none;z-index:10}
  .hotspot-btn{
    position:absolute;transform:translate(-50%,-50%);
    width:36px;height:36px;border-radius:50%;
    background:var(--accent);border:2px solid white;
    color:var(--navy);font-weight:900;font-size:.85rem;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;pointer-events:auto;
    box-shadow:0 2px 6px rgba(0,0,0,.3);
    transition:.15s;
  }
  .hotspot-btn:hover{transform:translate(-50%,-50%) scale(1.1);background:#fff;border-color:var(--accent)}
  .hotspot-btn.active{box-shadow:0 0 0 3px var(--gold);background:var(--gold);border-color:var(--navy);color:var(--navy)}

  /* Smart mode (time-aware) */
  .hotspot-btn.dim{opacity:.22;filter:grayscale(.6);transform:translate(-50%,-50%) scale(.98)}
  .hotspot-btn.smart-highlight{
    box-shadow:0 0 0 4px rgba(255,215,64,.65);
    animation:pulseGlow 1.8s ease-in-out infinite;
  }
  @keyframes pulseGlow{
    0%,100%{box-shadow:0 0 0 3px rgba(255,215,64,.62)}
    50%{box-shadow:0 0 0 7px rgba(255,215,64,.18)}
  }

  /* Shimmer skeleton */
  .shimmer{position:absolute;inset:0;z-index:2;background:linear-gradient(160deg,#1a5577,#267599);pointer-events:none;transition:opacity .25s ease}
  .shimmer::after{content:'';position:absolute;inset:0;
    background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.08) 40%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.08) 60%,transparent 100%);
    background-size:200% 100%;
    animation:shimmer 1.4s infinite linear}
  @keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}
  .shimmer.hidden{opacity:0;pointer-events:none}

  /* Slide transitions */
  .plan-img.slide-out-left {animation:slideOutLeft .18s var(--ease) both}
  .plan-img.slide-out-right{animation:slideOutRight .18s var(--ease) both}
  .plan-img.slide-in-left  {animation:slideInLeft  .22s var(--ease) both}
  .plan-img.slide-in-right {animation:slideInRight .22s var(--ease) both}
  @keyframes slideOutLeft {to  {transform:translateX(-18%) scale(.96);opacity:0}}
  @keyframes slideOutRight{to  {transform:translateX( 18%) scale(.96);opacity:0}}
  @keyframes slideInLeft  {from{transform:translateX( 18%) scale(.96);opacity:0}to{transform:translateX(0) scale(1);opacity:1}}
  @keyframes slideInRight {from{transform:translateX(-18%) scale(.96);opacity:0}to{transform:translateX(0) scale(1);opacity:1}}

  .zoom-row{display:flex;align-items:center;gap:.45rem;padding:.55rem .9rem;background:rgba(0,0,0,.18);border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0}
  .zoom-btn{width:32px;height:32px;border-radius:50%;background:var(--glass);border:1px solid var(--brd);display:grid;place-items:center;font-size:.78rem;flex-shrink:0;transition:.15s}
  .zoom-btn:hover{background:var(--accent);color:var(--navy)}
  .zoom-track{flex:1;max-width:150px;accent-color:var(--accent)}
  .zoom-pct{font-size:.72rem;font-weight:700;color:rgba(255,255,255,.5);min-width:34px;text-align:right}

  .chips-row{display:flex;gap:.35rem;overflow-x:auto;padding:.55rem .9rem;border-bottom:1px solid rgba(255,255,255,.06);scrollbar-width:none;flex-shrink:0}
  .chips-row:empty{display:none}
  .chips-row::-webkit-scrollbar{display:none}
  .chip{background:var(--glass);border:1px solid var(--brd);border-radius:999px;padding:.3rem .7rem;font-size:.72rem;font-weight:700;white-space:nowrap;transition:.15s;flex-shrink:0}
  .chip.active{background:var(--accent);color:var(--navy);border-color:var(--accent)}

  .legend{padding:.65rem .9rem;display:grid;gap:.4rem}
  .legend-item{display:flex;align-items:flex-start;gap:.6rem;background:var(--glass);border:1px solid var(--brd);border-radius:13px;padding:.6rem .75rem;transition:.15s;text-align:left;cursor:pointer}
  .legend-item:hover,.legend-item.active{background:rgba(0,180,230,.13);border-color:rgba(0,180,230,.35)}
  .legend-n{width:26px;height:26px;border-radius:50%;background:var(--accent);color:var(--navy);font-weight:900;font-size:.72rem;display:grid;place-items:center;flex-shrink:0;margin-top:1px}
  .legend-t strong{display:block;font-size:.84rem;font-weight:700;margin-bottom:.1rem}
  .legend-t span{font-size:.75rem;color:rgba(255,255,255,.55)}

  .modal-footer{display:flex;gap:.4rem;padding:.65rem .9rem calc(.65rem + env(safe-area-inset-bottom,0px));border-top:1px solid rgba(255,255,255,.08);background:#0c2d45;flex-shrink:0}
  .foot-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:.4rem;background:var(--glass);border:1px solid var(--brd);border-radius:999px;padding:.55rem .4rem;font-size:.75rem;font-weight:700;transition:.15s}
  .foot-btn:hover{background:rgba(255,255,255,.13)}
  .foot-btn.primary{background:var(--accent);color:var(--navy);border-color:var(--accent)}
  .foot-btn:disabled,.foot-btn[aria-disabled="true"]{opacity:.3;pointer-events:none}

  /* Premium Quick Jump Rail */
  .deck-rail{
    position:absolute;
    right:10px;
    top:78px;
    bottom:84px;
    width:52px;
    display:flex;
    align-items:stretch;
    justify-content:center;
    z-index:20;
    pointer-events:none;
  }
  .rail-wrap{
    width:46px;
    border-radius:22px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    box-shadow:0 16px 50px rgba(0,0,0,.25);
    backdrop-filter:blur(10px);
    display:flex;
    flex-direction:column;
    padding:8px 6px;
    gap:8px;
    pointer-events:auto;
    user-select:none;
    -webkit-user-select:none;
    touch-action:none;
  }
  .rail-track{
    position:relative;
    flex:1;
    border-radius:18px;
    background:linear-gradient(180deg,rgba(0,0,0,.14),rgba(0,0,0,.05));
    border:1px solid rgba(255,255,255,.06);
    overflow:hidden;
  }
  .rail-track::before{
    content:'';
    position:absolute; inset:0;
    background:radial-gradient(ellipse at 50% 12%, rgba(0,180,230,.14), transparent 65%);
    opacity:.8;
    pointer-events:none;
  }
  .rail-thumb{
    position:absolute;
    left:50%;
    transform:translate(-50%,-50%);
    width:32px;
    height:34px;
    border-radius:18px;
    background:linear-gradient(180deg, rgba(255,215,64,.95), rgba(255,215,64,.7));
    color:var(--navy);
    font-weight:900;
    display:grid;
    place-items:center;
    border:1px solid rgba(10,46,74,.35);
    box-shadow:0 10px 26px rgba(0,0,0,.28);
    transition:transform .12s var(--ease), filter .12s var(--ease);
    will-change:top, transform;
  }
  .rail-thumb.dragging{
    transform:translate(-50%,-50%) scale(1.04);
    filter:saturate(1.05) brightness(1.02);
  }
  .rail-label{
    height:28px;
    display:grid;
    place-items:center;
    font-weight:900;
    font-size:.68rem;
    color:rgba(255,255,255,.58);
    border-radius:14px;
    border:1px solid transparent;
    transition:.14s var(--ease);
  }
  .rail-label.active{
    color:var(--gold);
    background:rgba(255,215,64,.10);
    border-color:rgba(255,215,64,.18);
  }
  .rail-mini{
    display:grid;
    gap:6px;
  }
  .rail-mini button{
    width:100%;
    height:28px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.06);
    display:grid;
    place-items:center;
    font-weight:900;
    font-size:.68rem;
    color:rgba(255,255,255,.82);
    transition:.14s var(--ease);
  }
  .rail-mini button:hover{background:rgba(255,255,255,.10);border-color:rgba(0,180,230,.22)}
  .rail-mini button:active{transform:scale(.98)}
  .rail-mini button[disabled]{opacity:.35;pointer-events:none}

  /* Hide rail on very small screens if it crowds */
  @media(max-width:360px){
    .deck-rail{display:none}
  }

  /* Reduced motion: respect user preference */
  @media (prefers-reduced-motion: reduce){
    html{scroll-behavior:auto}
    .plan-img.intro{animation:none;transform:none}
    .plan-viewer.light-sweep::after{animation:none;opacity:0}
    .hotspot-btn.smart-highlight{animation:none}
    .plan-img.slide-out-left,.plan-img.slide-out-right,.plan-img.slide-in-left,.plan-img.slide-in-right{animation:none}
    .modal-sheet{animation:none}
  }

  /* ----- DRAWER ----- */
  .drawer-backdrop{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.62);backdrop-filter:blur(14px);opacity:0;pointer-events:none;transition:opacity .2s var(--ease)}
  .drawer-backdrop.open{opacity:1;pointer-events:auto}
  .drawer{position:absolute;top:0;right:0;height:100%;width:min(92vw,360px);background:rgba(10,46,74,.86);border-left:1px solid rgba(255,255,255,.12);box-shadow:-20px 0 80px rgba(0,0,0,.45);transform:translateX(20px);opacity:0;transition:transform .24s var(--ease), opacity .24s var(--ease);display:flex;flex-direction:column;padding:1rem}
  .drawer-backdrop.open .drawer{transform:translateX(0);opacity:1}
  .drawer-head{display:flex;align-items:center;justify-content:space-between;padding-bottom:.9rem;border-bottom:1px solid rgba(255,255,255,.1);color:#fff}
  .drawer-head h3{font-family:'Plus Jakarta Sans',sans-serif;font-weight:900}
  .drawer .nav{display:grid;gap:.55rem;padding:.95rem 0;overflow:auto}
  .drawer .nav a{display:flex;align-items:center;gap:.7rem;padding:.7rem .75rem;border-radius:16px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:rgba(255,255,255,.92);font-weight:800;transition:.18s}
  .drawer .nav a:hover{background:rgba(255,255,255,.1);border-color:rgba(0,180,230,.24);transform:translateY(-1px)}
  .drawer .nav a i{color:var(--gold);width:18px;text-align:center}

  /* ----- BACK TO TOP ----- */
  .back-to-top{position:fixed;bottom:100px;right:20px;width:48px;height:48px;border-radius:50%;background:var(--accent);color:var(--navy);border:none;box-shadow:0 8px 20px rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;z-index:800;cursor:pointer}
  .back-to-top.show{display:flex}

  /* ----- TOAST ----- */
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0px) + 16px);z-index:3000;background:rgba(10,46,74,.94);color:#fff;border:1px solid rgba(255,255,255,.14);padding:.62rem .9rem;border-radius:999px;box-shadow:0 20px 50px rgba(0,0,0,.35);display:flex;align-items:center;gap:.55rem;font-weight:900;font-size:.82rem;opacity:0;pointer-events:none;transition:.18s}
  .toast.show{opacity:1}
</style>
</head>

<body>
  <canvas id="ocean"></canvas>
  <div class="vignette" aria-hidden="true"></div>

  <header>
    <div class="hdr">
      <i class="fas fa-crown" style="color:var(--gold);font-size:.9rem"></i>
      <div>
        <div class="brand-title">Adventure of the Seas</div>
        <div class="brand-sub">Rahe Family · Deck Navigator</div>
      </div>
      <div class="spacer"></div>
      <span class="hdr-pill"><i class="fas fa-calendar-alt"></i> Feb 14–20</span>
      <button class="hdr-btn" id="menuBtn" aria-label="Menu"><i class="fas fa-bars"></i></button>
    </div>
  </header>

  <div class="hero">
    <h1>Deck Navigator</h1>
    <p>Find anything on the ship in seconds.</p>
  </div>

  <div class="search-wrap">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input id="deckSearch" type="search" placeholder="Search decks or venues…" autocomplete="off">
    </div>
  </div>

  <div class="filters" id="filters">
    <button class="f-btn active" data-f="all" aria-pressed="true">All</button>
    <button class="f-btn" data-f="entertainment" aria-pressed="false">Entertainment</button>
    <button class="f-btn" data-f="wellness" aria-pressed="false">Wellness</button>
    <button class="f-btn" data-f="essential" aria-pressed="false">Essential</button>
  </div>

  <div class="content" id="content"></div>
  <div class="empty" id="emptyState"><i class="fas fa-search"></i>No matching decks</div>

  <!-- MODAL -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Deck details">
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="modal-sheet" id="modalSheet">
      <div class="drag-handle"><span></span></div>

      <div class="modal-bar">
        <button class="modal-nav" id="prevBtn" aria-label="Previous deck"><i class="fas fa-chevron-left"></i></button>
        <button class="modal-nav" id="nextBtn" aria-label="Next deck"><i class="fas fa-chevron-right"></i></button>
        <div class="modal-titles">
          <div class="modal-title" id="modalTitle"></div>
          <div class="modal-sub" id="modalSub"></div>
        </div>
        <button class="modal-close-btn" id="modalClose" aria-label="Close"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <div class="plan-viewer" id="planViewer" aria-label="Deck plan viewer">
          <div class="shimmer" id="shimmer"></div>
          <img class="plan-img" id="planImg" src="" alt="" draggable="false">
          <div class="hotspots-layer" id="hotspotsLayer"></div>
        </div>

        <!-- Premium Quick Jump Rail -->
        <div class="deck-rail" aria-hidden="false">
          <div class="rail-wrap" id="railWrap" aria-label="Quick deck jump">
            <div class="rail-mini">
              <button id="railUp" aria-label="Deck up"><i class="fas fa-chevron-up"></i></button>
            </div>
            <div class="rail-track" id="railTrack">
              <div class="rail-thumb" id="railThumb" aria-label="Deck slider">—</div>
            </div>
            <div class="rail-mini">
              <button id="railDown" aria-label="Deck down"><i class="fas fa-chevron-down"></i></button>
            </div>
            <div class="rail-label" id="railActiveLabel" aria-label="Current deck">—</div>
          </div>
        </div>

        <div class="zoom-row">
          <button class="zoom-btn" id="zoomOut" aria-label="Zoom out"><i class="fas fa-minus"></i></button>
          <input type="range" class="zoom-track" id="zoomRange" min="50" max="300" value="100" aria-label="Zoom range">
          <button class="zoom-btn" id="zoomIn" aria-label="Zoom in"><i class="fas fa-plus"></i></button>
          <span class="zoom-pct" id="zoomPct">100%</span>
          <button class="zoom-btn" id="zoomReset" aria-label="Reset zoom"><i class="fas fa-compress-arrows-alt"></i></button>
        </div>

        <div class="chips-row" id="chipsRow"></div>
        <div class="legend" id="legend"></div>
      </div>

      <div class="modal-footer">
        <button class="foot-btn" id="btnLoc"><i class="fas fa-location-dot"></i> My Location</button>
        <a class="foot-btn" id="btnPDF" href="#" target="_blank" rel="noopener"><i class="fas fa-file-pdf"></i> PDF</a>
        <button class="foot-btn primary" id="btnClose2"><i class="fas fa-times"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- DRAWER -->
  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true">
    <aside class="drawer" role="dialog" aria-modal="true" aria-label="Navigation menu">
      <div class="drawer-head">
        <h3>Navigate</h3>
        <button class="hdr-btn" id="closeDrawerBtn" aria-label="Close menu"><i class="fas fa-times"></i></button>
      </div>
      <nav class="nav">
        <a href="#"><i class="fas fa-home"></i> Dashboard</a>
        <a href="#"><i class="fas fa-route"></i> Itinerary</a>
        <a href="#"><i class="fas fa-bed"></i> Rooms</a>
        <a href="#" class="active"><i class="fas fa-layer-group"></i> Decks</a>
        <a href="#"><i class="fas fa-list-check"></i> Checklist</a>
        <a href="#"><i class="fas fa-phone"></i> Contacts</a>
        <a href="#"><i class="fas fa-utensils"></i> Dining</a>
        <a href="#"><i class="fas fa-lightbulb"></i> Tips</a>
      </nav>
    </aside>
  </div>

  <!-- BACK TO TOP -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top"><i class="fas fa-arrow-up"></i></button>

  <!-- TOAST -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <i class="fas fa-circle-check"></i>
    <span id="toastText">Deck loaded</span>
  </div>

<script>
(() => {
  'use strict';

  /* ===========================
     DATA (upgraded: spot types)
     =========================== */
  const DECKS = [
    { n:0,  name:'All Decks',  sub:'Ship Overview', tags:['Full layout','Orientation'], cat:'essential', img:'decks/deck-all.svg', svg:'decks/deck-all.min.svg', pdf:'', chips:[], spots:[] },

    { n:5,  name:'Deck 5', sub:'Royal Promenade', tags:['Shops','Dining','Parades'], cat:'entertainment', img:'decks/deck-05.png', svg:'decks/deck-05-final.min.svg', pdf:'decks/deck-05.pdf',
      chips:['Cafe Promenade','Guest Services'],
      spots:[
        { t:'Cafe Promenade', n:'24h coffee & snacks', x:55, y:48, type:'dining' },
        { t:'Guest Services', n:'Crown & Anchor desk', x:48, y:60, type:'service' }
      ] },

    { n:4,  name:'Deck 4', sub:'Dining & Entertainment', tags:['Main Dining','Theater','Casino'], cat:'entertainment', img:'decks/deck-04.png', svg:'decks/deck-04-final.min.svg', pdf:'',
      chips:['Main Dining','Royal Theater','Casino'],
      spots:[
        { t:'Main Dining Room', n:'Dinner 6–9:30pm', x:35, y:55, type:'dining' },
        { t:'Royal Theater', n:'Shows 7pm & 9:30pm', x:65, y:40, type:'entertainment' },
        { t:'Casino Royale', n:'Slots, tables, poker', x:50, y:70, type:'entertainment' }
      ] },

    { n:3,  name:'Deck 3', sub:'Lobby & Guest Services', tags:['Grand Lobby','Shore Ex','Retail'], cat:'entertainment', img:'decks/deck-03.png', svg:'decks/deck-03-final.min.svg', pdf:'',
      chips:['Grand Lobby','Shore Excursions'],
      spots:[
        { t:'Grand Lobby', n:'Atrium & champagne bar', x:40, y:50, type:'essential' },
        { t:'Shore Excursions', n:'Booking desk', x:55, y:45, type:'service' }
      ] },

    { n:14, name:'Deck 14', sub:'Sky Deck', tags:['Viking Crown','Views','Lounges'], cat:'entertainment', img:'decks/deck-14.png', svg:'decks/deck-14-final.min.svg', pdf:'',
      chips:['Viking Crown'],
      spots:[{ t:'Viking Crown Lounge', n:'360° sky bar', x:50, y:30, type:'entertainment' }] },

    { n:13, name:'Deck 13', sub:'Adventure Zone', tags:['Rock Wall','Activities'], cat:'entertainment', img:'decks/deck-13.png', svg:'decks/deck-13-final.min.svg', pdf:'',
      chips:['Rock Wall'],
      spots:[{ t:'Rock Climbing Wall', n:'Up to 40ft tall', x:60, y:70, type:'activity' }] },

    { n:12, name:'Deck 12', sub:'Pool Deck', tags:['Main Pool','Solarium','Windjammer'], cat:'wellness', img:'decks/deck-12.png', svg:'decks/deck-12-final.min.svg', pdf:'',
      chips:['Main Pool','Solarium','Windjammer'],
      spots:[
        { t:'Main Pool', n:'Live music & bar', x:40, y:60, type:'activity' },
        { t:'Solarium', n:'Adults-only pool', x:70, y:30, type:'wellness' },
        { t:'Windjammer Cafe', n:'Buffet with ocean view', x:20, y:70, type:'dining' }
      ] },

    { n:15, name:'Deck 15', sub:'Sports & Observation', tags:['FlowRider','Jog Track','Views'], cat:'wellness', img:'decks/deck-15.png', svg:'decks/deck-15-final.min.svg', pdf:'',
      chips:['FlowRider','Mini Golf'],
      spots:[
        { t:'FlowRider', n:'Surf simulator', x:30, y:40, type:'activity' },
        { t:'Mini Golf', n:'9-hole course', x:70, y:50, type:'activity' },
        { t:'Running Track', n:'Outdoor jogging loop', x:50, y:80, type:'activity' }
      ] },

    { n:11, name:'Deck 11', sub:'Fitness & Spa', tags:['Vitality Spa','Gym','Wellness'], cat:'wellness', img:'decks/deck-11.png', svg:'decks/deck-11-final.min.svg', pdf:'',
      chips:['Vitality Spa','Fitness'],
      spots:[
        { t:'Vitality Spa', n:'Thermal suite & massages', x:48, y:44, type:'wellness' },
        { t:'Fitness Center', n:'Panoramic treadmills', x:30, y:55, type:'wellness' }
      ] },

    { n:10, name:'Deck 10', sub:'Staterooms', tags:['Cabins','Elevators'], cat:'cabin', img:'decks/deck-10.png', svg:'decks/deck-10-final.min.svg', pdf:'', chips:[], spots:[] },
    { n:9,  name:'Deck 9',  sub:'Staterooms', tags:['Cabins','Family'], cat:'cabin', img:'decks/deck-09.png', svg:'decks/deck-09-final.min.svg', pdf:'', chips:[], spots:[] },
    { n:8,  name:'Deck 8',  sub:'Staterooms', tags:['Cabins','Aft access'], cat:'cabin', img:'decks/deck-08.png', svg:'decks/deck-08-final.min.svg', pdf:'', chips:[], spots:[] },
    { n:7,  name:'Deck 7',  sub:'Staterooms', tags:['Cabins','Quiet'], cat:'cabin', img:'decks/deck-07.png', svg:'decks/deck-07-final.min.svg', pdf:'', chips:[], spots:[] },

    { n:6,  name:'Deck 6', sub:'Staterooms', tags:['Cabins','Midship'], cat:'cabin', img:'decks/deck-06.png', svg:'decks/deck-06-final.min.svg', pdf:'',
      chips:['Midship Elevators'],
      spots:[{ t:'Midship Elevators', n:'Fastest route to dining & promenade', x:52, y:50, type:'essential' }] },

    { n:2,  name:'Deck 2', sub:'Medical & Crew', tags:['Medical','Crew','Embark'], cat:'essential', img:'decks/deck-02.png', svg:'decks/deck-02-final.min.svg', pdf:'',
      chips:['Medical Center'],
      spots:[{ t:'Medical Center', n:'24h emergency care', x:50, y:50, type:'essential' }] },
  ];

  const SECTIONS = [
    { key:'entertainment', label:'Entertainment', icon:'fas fa-masks-theater', cls:'ent', decks: DECKS.filter(d => d.cat==='entertainment').map(d=>d.n) },
    { key:'wellness',      label:'Wellness & Activities', icon:'fas fa-water-ladder', cls:'wel', decks: DECKS.filter(d => d.cat==='wellness').map(d=>d.n) },
    { key:'essential',     label:'Essential', icon:'fas fa-compass', cls:'ess', decks: DECKS.filter(d => d.cat==='essential' && d.n!==0).map(d=>d.n) },
    { key:'cabin',         label:'Stateroom Decks', icon:'fas fa-bed', cls:'ess', decks: DECKS.filter(d => d.cat==='cabin').map(d=>d.n) },
  ];

  const byNum = (n) => DECKS.find(d => d.n === n) || null;
  const ordered = DECKS.filter(d => d.n !== 0).sort((a,b) => a.n - b.n);
  const reducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  /* ===========================
     STATE
     =========================== */
  let filt = 'all';
  let query = '';
  let currentDeck = null;
  let zoom = 100;

  let panning = false;
  let panStart = { x:0, y:0, scrollX:0, scrollY:0 };

  let pinching = false;
  let pinchDist0 = 0;
  let pinchZoom0 = 100;

  let railDragging = false;
  let railRaf = 0;
  let lastRailIdx = -1;

  /* ===========================
     DOM
     =========================== */
  const $ = (id) => document.getElementById(id);

  const content = $('content');
  const emptyState = $('emptyState');

  const modal = $('modal');
  const backdrop = $('modalBackdrop');
  const modalSheet = $('modalSheet');
  const modalTitle = $('modalTitle');
  const modalSub = $('modalSub');

  const planViewer = $('planViewer');
  const planImg = $('planImg');
  const shimmer = $('shimmer');
  const hotspotsLayer = $('hotspotsLayer');

  const zoomRange = $('zoomRange');
  const zoomPct = $('zoomPct');

  const chipsRow = $('chipsRow');
  const legend = $('legend');

  const prevBtn = $('prevBtn');
  const nextBtn = $('nextBtn');

  const btnPDF = $('btnPDF');
  const btnLoc = $('btnLoc');

  const drawerBackdrop = $('drawerBackdrop');
  const menuBtn = $('menuBtn');
  const closeDrawerBtn = $('closeDrawerBtn');

  const backToTop = $('backToTop');
  const toast = $('toast');
  const toastText = $('toastText');

  const railWrap = $('railWrap');
  const railTrack = $('railTrack');
  const railThumb = $('railThumb');
  const railUp = $('railUp');
  const railDown = $('railDown');
  const railActiveLabel = $('railActiveLabel');

  /* ===========================
     UTIL
     =========================== */
  function safeFocus(el) {
    try { el && el.focus && el.focus(); } catch (_) {}
  }

  function showToast(msg) {
    toastText.textContent = msg;
    toast.classList.add('show');
    window.clearTimeout(showToast._t);
    showToast._t = window.setTimeout(() => toast.classList.remove('show'), 2000);
  }

  function showShimmer() {
    shimmer.classList.remove('hidden');
    planImg.classList.remove('loaded');
  }
  function hideShimmer() {
    shimmer.classList.add('hidden');
    planImg.classList.add('loaded');
  }

  function clearSpotStates() {
    hotspotsLayer.querySelectorAll('.hotspot-btn').forEach(btn => {
      btn.classList.remove('active','dim','smart-highlight');
    });
    legend.querySelectorAll('.legend-item').forEach(item => item.classList.remove('active'));
  }

  /* ===========================
     RENDER LIST
     =========================== */
  function render() {
    const q = (query || '').trim().toLowerCase();

    const visible = (n) => {
      const d = byNum(n);
      if (!d) return false;
      const matchCat = (filt === 'all') || (d.cat === filt) || (filt === 'essential' && d.cat === 'cabin');
      const hay = `${d.name} ${d.sub} ${d.tags.join(' ')}`.toLowerCase();
      const matchQ = (!q) || hay.includes(q);
      return matchCat && matchQ;
    };

    let html = '';
    let anyVisible = false;

    // Overview
    const ovVis = (filt === 'all' || filt === 'essential') && (!q || 'all decks overview ship orientation blueprint'.includes(q));
    if (ovVis) {
      anyVisible = true;
      html += `<div class="overview-card" data-n="0">
        <div class="overview-icon"><i class="fas fa-layer-group"></i></div>
        <div class="overview-text">
          <strong>All Decks — Ship Overview</strong>
          <span>Full blueprint · Quick orientation</span>
        </div>
        <i class="fas fa-chevron-right overview-arrow"></i>
      </div>`;
    }

    SECTIONS.forEach(sec => {
      const visDecks = sec.decks.filter(n => visible(n));
      if (!visDecks.length) return;

      anyVisible = true;
      html += `<div class="sec-head">
        <span class="sec-icon ${sec.cls}"><i class="${sec.icon}"></i></span>
        <div><div class="sec-title">${sec.label}</div></div>
        <span class="sec-count">${visDecks.length}</span>
      </div>`;

      if (sec.key === 'cabin') {
        html += `<div class="cabin-row">`;
        visDecks.forEach(n => {
          html += `<button class="cabin-chip" data-n="${n}" aria-label="Open deck ${n}">
            <span class="chip-num">${n}</span>
            <span class="chip-label">Deck ${n}</span>
          </button>`;
        });
        html += `</div>`;
      } else {
        html += `<div class="deck-grid">`;
        visDecks.forEach(n => {
          const d = byNum(n);
          const tags = (d.tags || []).slice(0,3).map(t=>`<span class="card-tag">${t}</span>`).join('');
          html += `<div class="deck-card" data-n="${n}" role="button" tabindex="0" aria-label="Open ${d.sub}">
            <div class="card-top">
              <span class="card-num">${n}</span>
              <i class="fas fa-chevron-right card-arrow"></i>
            </div>
            <div class="card-name">${d.sub}</div>
            <div class="card-tags">${tags}</div>
          </div>`;
        });
        html += `</div>`;
      }
    });

    content.innerHTML = html;
    emptyState.style.display = anyVisible ? 'none' : 'block';
  }

  /* ===========================
     SPOTS / HOTSPOTS
     =========================== */
  function renderHotspots(deck) {
    if (!deck || !deck.spots || deck.spots.length === 0) {
      hotspotsLayer.innerHTML = '';
      return;
    }
    hotspotsLayer.innerHTML = deck.spots.map((spot, idx) => {
      const label = `${spot.t}: ${spot.n || ''}`.trim();
      return `<button class="hotspot-btn" data-spot-idx="${idx}" style="left:${spot.x}%; top:${spot.y}%;" aria-label="${escapeHtml(label)}">${idx+1}</button>`;
    }).join('');
  }

  function renderLegend(deck) {
    if (!deck || !deck.spots) {
      legend.innerHTML = '';
      return;
    }
    legend.innerHTML = deck.spots.map((s,i) => `
      <button class="legend-item" data-spot-idx="${i}" aria-label="Highlight ${escapeHtml(s.t)}">
        <span class="legend-n">${i+1}</span>
        <div class="legend-t"><strong>${escapeHtml(s.t)}</strong><span>${escapeHtml(s.n || '')}</span></div>
      </button>`).join('');
  }

  function escapeHtml(str) {
    return String(str || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function highlightSpot(idx) {
    clearSpotStates();

    const spotBtn = hotspotsLayer.querySelector(`.hotspot-btn[data-spot-idx="${idx}"]`);
    const legendItem = legend.querySelector(`.legend-item[data-spot-idx="${idx}"]`);
    if (spotBtn) spotBtn.classList.add('active');
    if (legendItem) legendItem.classList.add('active');

    // keep legend item visible
    if (legendItem) {
      try { legendItem.scrollIntoView({ behavior: reducedMotion ? 'auto' : 'smooth', block: 'nearest' }); } catch (_) {}
    }
  }

  /* ===========================
     SMART MODE (time-aware)
     =========================== */
  function getSmartModeNow() {
    const now = new Date();
    const h = now.getHours();

    // Dinner window (local device time)
    if (h >= 17 && h < 22) return 'dining';
    // Morning
    if (h >= 6 && h < 10) return 'breakfast';
    // Daytime activities
    if (h >= 10 && h < 17) return 'activity';
    return null;
  }

  function applySmartMode(deck) {
    if (!deck || !deck.spots || deck.spots.length === 0) return;

    const mode = getSmartModeNow();
    if (!mode) return;

    // Map breakfast to dining for now unless you add breakfast-specific types later
    const target = (mode === 'breakfast') ? 'dining' : mode;

    deck.spots.forEach((s, i) => {
      const btn = hotspotsLayer.querySelector(`.hotspot-btn[data-spot-idx="${i}"]`);
      if (!btn) return;
      if ((s.type || '').toLowerCase() === target) {
        btn.classList.add('smart-highlight');
      } else {
        btn.classList.add('dim');
      }
    });
  }

  /* ===========================
     CINEMATIC ENTRY
     =========================== */
  function runCinematicReveal() {
    if (reducedMotion) return;

    // Light sweep
    planViewer.classList.add('light-sweep');
    window.setTimeout(() => planViewer.classList.remove('light-sweep'), 950);

    // Soft glow pulse on image
    planImg.classList.add('glow');
    window.setTimeout(() => planImg.classList.remove('glow'), 650);
  }

  function runIntroZoomOnce() {
    if (reducedMotion) return;
    planImg.classList.add('intro');
    planImg.addEventListener('animationend', () => planImg.classList.remove('intro'), { once:true });
  }

  /* ===========================
     DECK SWITCHING + IMAGE LOAD
     =========================== */
  function currentOrderedIndex() {
    if (!currentDeck) return -1;
    return ordered.findIndex(x => x.n === currentDeck.n);
  }

  function setZoom(v) {
    const clamped = Math.min(300, Math.max(50, v));
    zoom = clamped;
    zoomRange.value = String(clamped);
    zoomPct.textContent = clamped + '%';
    planImg.style.transform = `scale(${clamped/100})`;

    // When zoom returns to baseline, recenter scroll
    if (clamped <= 100) {
      planViewer.scrollLeft = 0;
      planViewer.scrollTop = 0;
    }
  }

  function setDeck(deck, dir, opts = {}) {
    if (!deck) return;

    const firstOpen = !!opts.firstOpen;
    currentDeck = deck;

    modalTitle.textContent = deck.name + (deck.n ? ` — ${deck.sub}` : '');
    modalSub.textContent = (deck.tags || []).join(' · ');

    // Prev/Next enable
    const idx = ordered.findIndex(x => x.n === deck.n);
    prevBtn.disabled = idx <= 0;
    nextBtn.disabled = idx >= ordered.length - 1;

    // PDF
    if (deck.pdf) { btnPDF.href = deck.pdf; btnPDF.removeAttribute('aria-disabled'); }
    else { btnPDF.href = '#'; btnPDF.setAttribute('aria-disabled','true'); }

    // Chips + legend
    chipsRow.innerHTML = (deck.chips || []).map(c => `<button class="chip" aria-label="Filter ${escapeHtml(c)}">${escapeHtml(c)}</button>`).join('');
    renderLegend(deck);

    // Rail update
    updateRailToDeck(deck);

    // Image transition
    const animOut = dir === 'left' ? 'slide-out-left' : dir === 'right' ? 'slide-out-right' : null;
    const animIn  = dir === 'left' ? 'slide-in-left'  : dir === 'right' ? 'slide-in-right'  : null;

    const swap = () => {
      planImg.className = 'plan-img'; // reset all classes
      showShimmer();

      // Prefer SVG
      const src = deck.svg || deck.img || '';
      planImg.src = src;
      planImg.alt = deck.name;

      planImg.onload = () => {
        hideShimmer();

        // intro / sweep / glow
        if (firstOpen) runIntroZoomOnce();
        runCinematicReveal();

        if (animIn && !reducedMotion) planImg.classList.add(animIn);

        // hotspots after load
        renderHotspots(deck);
        clearSpotStates();
        applySmartMode(deck);
      };

      planImg.onerror = () => {
        hideShimmer();
        renderHotspots(deck);
        clearSpotStates();
        showToast('Deck image failed to load');
      };
    };

    if (animOut && !reducedMotion && planImg.classList.contains('loaded')) {
      planImg.classList.add(animOut);
      planImg.addEventListener('animationend', swap, { once:true });
    } else {
      swap();
    }

    // reset zoom on deck change
    setZoom(100);
  }

  function openModal(deck) {
    setDeck(deck, null, { firstOpen:true });
    modal.classList.add('open');
    document.body.style.overflow = 'hidden';
    safeFocus(modalCloseBtn());
  }

  function modalCloseBtn() {
    return $('modalClose') || $('btnClose2');
  }

  function closeModal() {
    modal.classList.remove('open');
    document.body.style.overflow = '';
    clearSpotStates();
    // stop rail drag
    railDragging = false;
    railThumb.classList.remove('dragging');
  }

  /* ===========================
     QUICK JUMP RAIL
     =========================== */
  function railDecks() {
    // Use ordered (excludes 0). That’s the premium deck glide list.
    return ordered;
  }

  function updateRailToDeck(deck) {
    const list = railDecks();
    const idx = list.findIndex(d => d.n === deck.n);
    if (idx < 0) return;

    // Thumb position
    const trackRect = railTrack.getBoundingClientRect();
    const yMin = 18; // visual padding inside track
    const yMax = trackRect.height - 18;
    const t = (list.length <= 1) ? 0 : idx / (list.length - 1);
    const y = yMin + t * (yMax - yMin);

    railThumb.style.top = `${y}px`;
    railThumb.textContent = String(deck.n);
    railActiveLabel.textContent = `D${deck.n}`;

    // Up/Down enable
    railUp.disabled = idx <= 0;
    railDown.disabled = idx >= list.length - 1;
  }

  function idxFromClientY(clientY) {
    const list = railDecks();
    const rect = railTrack.getBoundingClientRect();
    const y = Math.min(rect.bottom, Math.max(rect.top, clientY)) - rect.top;

    const yMin = 18;
    const yMax = rect.height - 18;
    const clamped = Math.min(yMax, Math.max(yMin, y));

    const t = (yMax - yMin) <= 0 ? 0 : (clamped - yMin) / (yMax - yMin);
    const idx = Math.round(t * (list.length - 1));
    return Math.min(list.length - 1, Math.max(0, idx));
  }

  function setDeckByRailIndex(idx) {
    const list = railDecks();
    if (idx < 0 || idx >= list.length) return;

    const next = list[idx];
    if (!currentDeck || next.n === currentDeck.n) return;

    const currentIdx = list.findIndex(d => d.n === currentDeck.n);
    const dir = (currentIdx < idx) ? 'left' : 'right';
    setDeck(next, dir, { firstOpen:false });

    // light haptic if available
    try {
      if (navigator.vibrate) navigator.vibrate(8);
    } catch (_) {}
  }

  function railPointerDown(e) {
    if (!modal.classList.contains('open')) return;
    railDragging = true;
    railThumb.classList.add('dragging');
    if (railTrack.setPointerCapture && e.pointerId != null) {
      try { railTrack.setPointerCapture(e.pointerId); } catch (_) {}
    }
    railPointerMove(e);
  }

  function railPointerMove(e) {
    if (!railDragging) return;
    const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
    if (!clientY && clientY !== 0) return;

    // Move thumb immediately (fast)
    const list = railDecks();
    const rect = railTrack.getBoundingClientRect();
    const y = Math.min(rect.bottom, Math.max(rect.top, clientY)) - rect.top;
    railThumb.style.top = `${y}px`;

    // Deck change throttled with rAF + distinct index
    if (!railRaf) {
      railRaf = requestAnimationFrame(() => {
        railRaf = 0;
        const idx = idxFromClientY(clientY);
        if (idx !== lastRailIdx) {
          lastRailIdx = idx;
          setDeckByRailIndex(idx);
        }
      });
    }
  }

  function railPointerUp() {
    railDragging = false;
    railThumb.classList.remove('dragging');
    lastRailIdx = -1;
    // snap thumb precisely to current deck
    if (currentDeck) updateRailToDeck(currentDeck);
  }

  /* ===========================
     PAN / PINCH (kept, polished)
     =========================== */
  const dist = (ts) => Math.hypot(ts[0].clientX - ts[1].clientX, ts[0].clientY - ts[1].clientY);

  planViewer.addEventListener('touchstart', (e) => {
    if (!modal.classList.contains('open')) return;

    if (e.touches.length === 2) {
      pinching = true;
      pinchDist0 = dist(e.touches);
      pinchZoom0 = zoom;
      e.preventDefault();
      return;
    }

    if (e.touches.length === 1 && zoom > 100) {
      panning = true;
      panStart = {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
        scrollX: planViewer.scrollLeft,
        scrollY: planViewer.scrollTop
      };
    }
  }, { passive:false });

  planViewer.addEventListener('touchmove', (e) => {
    if (!modal.classList.contains('open')) return;

    if (pinching && e.touches.length === 2) {
      const d = dist(e.touches);
      const next = Math.round(pinchZoom0 * d / Math.max(10, pinchDist0));
      setZoom(next);
      e.preventDefault();
      return;
    }

    if (panning && e.touches.length === 1) {
      const dx = e.touches[0].clientX - panStart.x;
      const dy = e.touches[0].clientY - panStart.y;
      planViewer.scrollLeft = panStart.scrollX - dx;
      planViewer.scrollTop = panStart.scrollY - dy;
      e.preventDefault();
    }
  }, { passive:false });

  planViewer.addEventListener('touchend', () => { panning = false; pinching = false; }, { passive:true });

  planViewer.addEventListener('pointerdown', (e) => {
    if (!modal.classList.contains('open')) return;
    if (zoom <= 100) return;
    // ignore if rail is interacting
    if (railDragging) return;

    panning = true;
    panStart = { x: e.clientX, y: e.clientY, scrollX: planViewer.scrollLeft, scrollY: planViewer.scrollTop };
    try { planViewer.setPointerCapture(e.pointerId); } catch (_) {}
  });
  planViewer.addEventListener('pointermove', (e) => {
    if (!panning) return;
    const dx = e.clientX - panStart.x;
    const dy = e.clientY - panStart.y;
    planViewer.scrollLeft = panStart.scrollX - dx;
    planViewer.scrollTop = panStart.scrollY - dy;
  });
  planViewer.addEventListener('pointerup', () => panning = false);
  planViewer.addEventListener('pointercancel', () => panning = false);

  /* ===========================
     SWIPE DOWN TO CLOSE
     =========================== */
  let startY = 0;
  modalSheet.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; }, { passive:true });
  modalSheet.addEventListener('touchend', (e) => {
    const endY = e.changedTouches[0].clientY;
    if (endY - startY > 86) closeModal();
  }, { passive:true });

  /* ===========================
     EVENTS
     =========================== */
  // Filters
  $('filters').addEventListener('click', (e) => {
    const b = e.target.closest('.f-btn');
    if (!b) return;

    document.querySelectorAll('.f-btn').forEach(x => {
      x.classList.remove('active');
      x.setAttribute('aria-pressed', 'false');
    });

    b.classList.add('active');
    b.setAttribute('aria-pressed', 'true');

    filt = b.dataset.f || 'all';
    render();
  });

  // Search
  $('deckSearch').addEventListener('input', (e) => { query = e.target.value || ''; render(); });

  // Click cards
  content.addEventListener('click', (e) => {
    const card = e.target.closest('[data-n]');
    if (!card) return;
    const d = byNum(Number(card.dataset.n));
    if (d) openModal(d);
  });

  // Keyboard open on focused card
  content.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const card = e.target.closest('[data-n]');
    if (!card) return;
    e.preventDefault();
    const d = byNum(Number(card.dataset.n));
    if (d) openModal(d);
  });

  // Close modal
  backdrop.addEventListener('click', closeModal);
  $('modalClose').addEventListener('click', closeModal);
  $('btnClose2').addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => {
    if (!modal.classList.contains('open')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') prevBtn.click();
    if (e.key === 'ArrowRight') nextBtn.click();
  });

  // Prev/Next deck (true glide)
  prevBtn.addEventListener('click', () => {
    const idx = currentOrderedIndex();
    if (idx <= 0) return;
    setDeck(ordered[idx - 1], 'right', { firstOpen:false });
  });
  nextBtn.addEventListener('click', () => {
    const idx = currentOrderedIndex();
    if (idx < 0 || idx >= ordered.length - 1) return;
    setDeck(ordered[idx + 1], 'left', { firstOpen:false });
  });

  // Zoom controls
  $('zoomIn').addEventListener('click', () => setZoom(zoom + 25));
  $('zoomOut').addEventListener('click', () => setZoom(zoom - 25));
  $('zoomReset').addEventListener('click', () => setZoom(100));
  zoomRange.addEventListener('input', (e) => setZoom(Number(e.target.value || 100)));

  // Chips -> highlight matching spot
  chipsRow.addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (!chip || !currentDeck || !currentDeck.spots) return;
    const text = chip.textContent.trim().toLowerCase();
    const idx = currentDeck.spots.findIndex(s => (s.t || '').toLowerCase().includes(text));
    if (idx !== -1) highlightSpot(idx);
  });

  // Legend click
  legend.addEventListener('click', (e) => {
    const item = e.target.closest('.legend-item');
    if (!item) return;
    const idx = Number(item.dataset.spotIdx);
    if (!Number.isNaN(idx)) highlightSpot(idx);
  });

  // Hotspot click
  hotspotsLayer.addEventListener('click', (e) => {
    const btn = e.target.closest('.hotspot-btn');
    if (!btn) return;
    const idx = Number(btn.dataset.spotIdx);
    if (!Number.isNaN(idx)) highlightSpot(idx);
  });

  // My Location (non-invasive placeholder)
  btnLoc.addEventListener('click', () => showToast('My Location: coming soon'));

  // Drawer
  function openDrawer() {
    drawerBackdrop.classList.add('open');
    drawerBackdrop.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    safeFocus(closeDrawerBtn);
  }
  function closeDrawer() {
    drawerBackdrop.classList.remove('open');
    drawerBackdrop.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    safeFocus(menuBtn);
  }
  menuBtn.addEventListener('click', openDrawer);
  closeDrawerBtn.addEventListener('click', closeDrawer);
  drawerBackdrop.addEventListener('click', (e) => { if (e.target === drawerBackdrop) closeDrawer(); });

  // Back to top
  window.addEventListener('scroll', () => {
    backToTop.classList.toggle('show', window.scrollY > 400);
  });
  backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: reducedMotion ? 'auto' : 'smooth' }));

  // Keyboard shortcut '/'
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== $('deckSearch')) {
      e.preventDefault();
      $('deckSearch').focus();
    }
  });

  /* ===========================
     RAIL EVENTS
     =========================== */
  // Track pointer
  railTrack.addEventListener('pointerdown', railPointerDown);
  railTrack.addEventListener('pointermove', railPointerMove);
  railTrack.addEventListener('pointerup', railPointerUp);
  railTrack.addEventListener('pointercancel', railPointerUp);

  // Touch support (iOS sometimes prefers touch events on nested)
  railTrack.addEventListener('touchstart', (e) => {
    railDragging = true;
    railThumb.classList.add('dragging');
    railPointerMove(e);
    e.preventDefault();
  }, { passive:false });
  railTrack.addEventListener('touchmove', (e) => { railPointerMove(e); e.preventDefault(); }, { passive:false });
  railTrack.addEventListener('touchend', () => railPointerUp(), { passive:true });

  // Up/Down buttons
  railUp.addEventListener('click', () => {
    if (!currentDeck) return;
    const idx = railDecks().findIndex(d => d.n === currentDeck.n);
    setDeckByRailIndex(Math.max(0, idx - 1));
  });
  railDown.addEventListener('click', () => {
    if (!currentDeck) return;
    const idx = railDecks().findIndex(d => d.n === currentDeck.n);
    setDeckByRailIndex(Math.min(railDecks().length - 1, idx + 1));
  });

  /* ===========================
     OCEAN BACKGROUND (polished)
     =========================== */
  const oceanCanvas = $('ocean');
  if (oceanCanvas) {
    const ctx = oceanCanvas.getContext('2d', { alpha:true });
    const waves = [
      { amp: 22, len: 0.010, speed: 0.010, y: 0.46, alpha: 0.11 },
      { amp: 30, len: 0.008, speed: 0.013, y: 0.54, alpha: 0.09 },
      { amp: 38, len: 0.006, speed: 0.016, y: 0.62, alpha: 0.07 },
    ];
    let t = 0;

    function resize() {
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      oceanCanvas.width = Math.floor(window.innerWidth * dpr);
      oceanCanvas.height = Math.floor(window.innerHeight * dpr);
      oceanCanvas.style.width = window.innerWidth + 'px';
      oceanCanvas.style.height = window.innerHeight + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    resize();
    window.addEventListener('resize', resize);

    function draw() {
      // Pause when tab hidden
      if (document.hidden) { requestAnimationFrame(draw); return; }

      const w = window.innerWidth;
      const h = window.innerHeight;
      ctx.clearRect(0, 0, w, h);

      // Deep base
      ctx.fillStyle = '#071a2c';
      ctx.fillRect(0, 0, w, h);

      // Waves
      waves.forEach((wa, i) => {
        const baseY = h * wa.y;
        ctx.beginPath();
        ctx.moveTo(0, baseY);
        for (let x = 0; x <= w; x += 8) {
          ctx.lineTo(x, baseY + Math.sin(x * wa.len + t * (0.8 + i*0.15)) * wa.amp);
        }
        ctx.lineTo(w, h);
        ctx.lineTo(0, h);
        ctx.closePath();
        ctx.fillStyle = `rgba(0,180,230,${wa.alpha})`;
        ctx.fill();
      });

      t += reducedMotion ? 0.004 : 0.012;
      requestAnimationFrame(draw);
    }
    draw();
  }

  /* ===========================
     INIT
     =========================== */
  render();

  // If you want a default “featured” deck on load, uncomment:
  // openModal(byNum(5));

})();
</script>

</body>
</html>