<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0">
<title>Deck Navigator · Adventure of the Seas</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ── Reset & Base ─────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --navy:    #0a2e4a;
  --navy2:   #083452;
  --blue:    #0f4f76;
  --accent:  #00b4e6;
  --gold:    #ffd740;
  --gold2:   #c6a15b;
  --white:   #ffffff;
  --bg:      #f0f6fb;
  --bg2:     #e4eff8;
  --card-bg: #ffffff;
  --text:    #0d2236;
  --muted:   #5a7a93;
  --radius:  22px;
  --shadow:  0 8px 32px rgba(10,46,74,.13);
  --shadow-lg: 0 20px 60px rgba(10,46,74,.22);

  /* SVG viewer */
  --stage-bg-1: #071e33;
  --stage-bg-2: #103a60;
  --glow: rgba(0,180,230,.55);
  --glow2: rgba(255,215,64,.35);
  --canvas-pad: 18px;
  --min-zoom: .65;
  --max-zoom: 6;
}

html { scroll-behavior: smooth; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ── Header ───────────────────────────────────── */
.site-header {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
  padding: 0 1.5rem;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 20px rgba(0,0,0,.3);
}

.header-inner {
  max-width: 1200px;
  margin: auto;
  height: 62px;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.header-brand {
  display: flex;
  align-items: center;
  gap: .6rem;
  text-decoration: none;
  color: var(--white);
}

.header-brand i {
  color: var(--gold);
  font-size: 1.2rem;
}

.header-brand-text { line-height: 1.2; }

.header-brand-title {
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-weight: 800;
  font-size: .95rem;
  color: var(--white);
  display: block;
}

.header-brand-sub {
  font-size: .7rem;
  color: rgba(255,255,255,.55);
  display: block;
}

.header-spacer { flex: 1; }

.header-badge {
  background: rgba(255,215,64,.15);
  border: 1px solid rgba(255,215,64,.3);
  color: var(--gold);
  font-size: .72rem;
  font-weight: 700;
  padding: .3rem .75rem;
  border-radius: 999px;
  white-space: nowrap;
}

/* ── Hero ─────────────────────────────────────── */
.hero {
  background: linear-gradient(160deg, var(--navy) 0%, #0d3f60 60%, #0f5580 100%);
  padding: 3.5rem 1.5rem 3rem;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 70% 0%, rgba(0,180,230,.18) 0%, transparent 60%),
              radial-gradient(ellipse at 20% 100%, rgba(255,215,64,.1) 0%, transparent 50%);
  pointer-events: none;
}

.hero-badge {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  background: rgba(255,255,255,.1);
  border: 1px solid rgba(255,255,255,.2);
  color: rgba(255,255,255,.9);
  font-size: .78rem;
  font-weight: 600;
  padding: .4rem 1rem;
  border-radius: 999px;
  margin-bottom: 1.25rem;
}

.hero-badge i { color: var(--gold); }

.hero h1 {
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-weight: 900;
  font-size: clamp(2rem, 5vw, 3rem);
  color: var(--white);
  margin-bottom: .75rem;
  line-height: 1.1;
}

.hero h1 em {
  color: var(--accent);
  font-style: normal;
}

.hero-sub {
  color: rgba(255,255,255,.65);
  font-size: .95rem;
  max-width: 480px;
  margin: 0 auto 2rem;
  line-height: 1.6;
}

/* ── Search ───────────────────────────────────── */
.search-wrap {
  display: flex;
  align-items: center;
  max-width: 420px;
  margin: 0 auto;
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.22);
  border-radius: 999px;
  padding: .2rem .2rem .2rem 1.1rem;
  backdrop-filter: blur(8px);
  transition: .2s;
}

.search-wrap:focus-within {
  background: rgba(255,255,255,.18);
  border-color: rgba(0,180,230,.7);
  box-shadow: 0 0 0 3px rgba(0,180,230,.2);
}

.search-wrap i {
  color: rgba(255,255,255,.55);
  font-size: .85rem;
  margin-right: .5rem;
  flex-shrink: 0;
}

.search-wrap input {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--white);
  font-size: .92rem;
  font-family: inherit;
  min-width: 0;
}

.search-wrap input::placeholder { color: rgba(255,255,255,.45); }

.search-wrap button {
  background: rgba(255,255,255,.15);
  border: none;
  color: var(--white);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  cursor: pointer;
  flex-shrink: 0;
  transition: .2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: .8rem;
}

.search-wrap button:hover { background: rgba(255,255,255,.28); }

/* ── Grid Section ─────────────────────────────── */
.grid-section {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2.5rem 1.25rem 5rem;
}

.grid-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.25rem;
}

.grid-meta h2 {
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-weight: 800;
  font-size: 1.15rem;
  color: var(--navy);
}

.grid-count {
  font-size: .8rem;
  color: var(--muted);
  font-weight: 600;
  background: var(--bg2);
  padding: .3rem .8rem;
  border-radius: 999px;
}

.deck-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1.1rem;
}

/* ── Deck Card ─────────────────────────────────── */
.deck-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 1.5rem 1.25rem 1.25rem;
  cursor: pointer;
  box-shadow: var(--shadow);
  border: 1.5px solid transparent;
  transition: transform .22s ease, box-shadow .22s ease, border-color .22s ease;
  position: relative;
  overflow: hidden;
  user-select: none;
}

.deck-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  opacity: 0;
  transition: opacity .22s;
}

.deck-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-lg);
  border-color: rgba(0,180,230,.25);
}

.deck-card:hover::before { opacity: 1; }

.deck-card:active { transform: translateY(-2px) scale(.99); }

.card-num {
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-weight: 900;
  font-size: 2.2rem;
  color: var(--accent);
  line-height: 1;
  margin-bottom: .3rem;
}

.card-name {
  font-weight: 700;
  font-size: .95rem;
  color: var(--navy);
  margin-bottom: .35rem;
}

.card-hint {
  font-size: .75rem;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: .35rem;
}

.card-hint i { font-size: .65rem; }

.card-arrow {
  position: absolute;
  right: 1.1rem;
  bottom: 1.1rem;
  width: 30px;
  height: 30px;
  background: var(--bg);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--accent);
  font-size: .7rem;
  transition: .2s;
}

.deck-card:hover .card-arrow {
  background: var(--accent);
  color: var(--white);
}

/* ── Empty State ────────────────────────────────── */
.empty-state {
  text-align: center;
  padding: 4rem 1rem;
  color: var(--muted);
  grid-column: 1 / -1;
}

.empty-state i { font-size: 2.5rem; margin-bottom: 1rem; opacity: .4; display: block; }

/* ── Modal Backdrop ─────────────────────────────── */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(5,18,35,.88);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: env(safe-area-inset-top, 1rem) 1rem env(safe-area-inset-bottom, 1rem);
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
}

.modal-backdrop.is-open {
  opacity: 1;
  pointer-events: auto;
}

/* ── Modal ──────────────────────────────────────── */
.modal {
  background: #fff;
  border-radius: 28px;
  width: min(98%, 1100px);
  max-height: calc(100vh - 2rem);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 30px 80px rgba(0,0,0,.45);
  transform: scale(.96) translateY(12px);
  transition: transform .28s cubic-bezier(.22,.61,.36,1);
}

.modal-backdrop.is-open .modal {
  transform: scale(1) translateY(0);
}

/* ── Modal Header ───────────────────────────────── */
.modal-header {
  background: linear-gradient(135deg, var(--navy) 0%, var(--blue) 100%);
  padding: 1.25rem 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-shrink: 0;
}

.modal-header-info { flex: 1; min-width: 0; }

.modal-deck-num {
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-weight: 900;
  font-size: 1.9rem;
  color: var(--accent);
  line-height: 1;
}

.modal-deck-name {
  font-size: .85rem;
  color: rgba(255,255,255,.7);
  margin-top: .1rem;
}

.modal-nav {
  display: flex;
  gap: .5rem;
}

.modal-nav-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1.5px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,.1);
  color: var(--white);
  cursor: pointer;
  transition: .2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: .85rem;
}

.modal-nav-btn:hover { background: rgba(255,255,255,.25); }
.modal-nav-btn:disabled { opacity: .3; cursor: default; }

.modal-close {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1.5px solid rgba(255,255,255,.25);
  background: rgba(255,255,255,.1);
  color: var(--white);
  cursor: pointer;
  transition: .2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: .9rem;
  flex-shrink: 0;
}

.modal-close:hover { background: rgba(220,60,60,.5); border-color: rgba(220,60,60,.6); }

/* ── Plan Viewer (Upgraded SVG experience) ───────────────── */
.plan-viewer {
  flex: 1;
  overflow: hidden;
  position: relative;
  background: radial-gradient(circle at center, var(--stage-bg-2), var(--stage-bg-1));
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 320px;
}

/* Ocean ambient motion */
.plan-viewer::before,
.plan-viewer::after{
  content:'';
  position:absolute;
  inset:-40%;
  pointer-events:none;
  opacity:.55;
  background:
    radial-gradient(circle at 30% 20%, rgba(0,180,230,.16) 0%, transparent 48%),
    radial-gradient(circle at 70% 30%, rgba(255,215,64,.10) 0%, transparent 52%),
    radial-gradient(circle at 50% 70%, rgba(0,180,230,.10) 0%, transparent 55%);
  filter: blur(16px);
  transform: translate3d(0,0,0);
  animation: driftA 18s ease-in-out infinite;
}
.plan-viewer::after{
  opacity:.35;
  filter: blur(22px);
  animation: driftB 26s ease-in-out infinite reverse;
}
@keyframes driftA{
  0%{transform: translate3d(-1.5%, -1.5%, 0) scale(1.02) rotate(0.4deg);}
  50%{transform: translate3d(1.8%, 1.2%, 0) scale(1.06) rotate(-0.3deg);}
  100%{transform: translate3d(-1.5%, -1.5%, 0) scale(1.02) rotate(0.4deg);}
}
@keyframes driftB{
  0%{transform: translate3d(1.2%, -1.4%, 0) scale(1.08) rotate(-0.5deg);}
  50%{transform: translate3d(-1.6%, 1.3%, 0) scale(1.02) rotate(0.35deg);}
  100%{transform: translate3d(1.2%, -1.4%, 0) scale(1.08) rotate(-0.5deg);}
}

/* Stage */
.plan-stage {
  position: relative;
  width: 100%;
  height: 100%;
  cursor: grab;
  touch-action: none;
  user-select: none;
  overflow: hidden;
  padding: var(--canvas-pad);
  z-index: 1;
}
.plan-stage:active { cursor: grabbing; }

.plan-frame {
  position: absolute;
  inset: var(--canvas-pad);
  border-radius: 14px;
  pointer-events: none;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.08) inset,
    0 0 0 1px rgba(0,0,0,.22),
    0 18px 60px rgba(0,0,0,.35);
}

/* Glow edge lighting */
.plan-frame::before{
  content:'';
  position:absolute;
  inset:-2px;
  border-radius: 16px;
  background: linear-gradient(135deg, var(--glow), var(--glow2));
  opacity:.28;
  filter: blur(10px);
}

/* Canvas and content transform */
.plan-canvas {
  position: absolute;
  inset: var(--canvas-pad);
  display: grid;
  place-items: center;
  transform: translate3d(0,0,0);
  will-change: transform;
}

.plan-content {
  transform-origin: 0 0;
  will-change: transform;
  filter: drop-shadow(0 18px 26px rgba(0,0,0,.25));
}

/* Make injected SVG behave */
.plan-content svg {
  display: block;
  width: auto;
  height: auto;
  max-width: none;
  max-height: none;
}

.plan-content svg * { shape-rendering: geometricPrecision; }

.plan-loader {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  color: rgba(255,255,255,.75);
  font-size: .9rem;
  z-index: 3;
}

.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid rgba(255,255,255,.15);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.plan-error {
  position: absolute;
  inset: 0;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: .75rem;
  color: rgba(255,255,255,.65);
  text-align: center;
  padding: 2rem;
  z-index: 3;
}

.plan-error i { font-size: 2.5rem; opacity: .5; }
.plan-error p { font-size: .85rem; line-height: 1.6; }

.viewer-hint {
  position: absolute;
  left: 14px;
  bottom: 14px;
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  padding: .55rem .75rem;
  border-radius: 999px;
  background: rgba(5,18,35,.45);
  border: 1px solid rgba(255,255,255,.14);
  color: rgba(255,255,255,.85);
  font-size: .78rem;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 2;
  opacity: .95;
}
.viewer-hint i { color: var(--gold); }
.viewer-hint kbd{
  font: inherit;
  font-weight: 800;
  padding: .12rem .4rem;
  border-radius: 7px;
  background: rgba(255,255,255,.12);
  border: 1px solid rgba(255,255,255,.18);
}

/* ── Zoom Bar ───────────────────────────────────── */
.zoom-bar {
  background: #f0f6fb;
  border-top: 1px solid rgba(0,0,0,.07);
  padding: .75rem 1.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .6rem;
  flex-shrink: 0;
}

.zoom-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 1.5px solid rgba(0,0,0,.1);
  background: var(--white);
  color: var(--navy);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: .8rem;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
  transition: .18s;
}

.zoom-btn:hover { background: var(--accent); color: var(--white); border-color: var(--accent); }

.zoom-label {
  font-size: .82rem;
  font-weight: 800;
  color: var(--navy);
  min-width: 64px;
  text-align: center;
}

.zoom-divider {
  width: 1px;
  height: 20px;
  background: rgba(0,0,0,.1);
  margin: 0 .2rem;
}

@media (max-width: 600px) {
  .hero { padding: 2.5rem 1rem 2rem; }
  .modal { border-radius: 20px 20px 0 0; width: 100%; max-height: 92vh; margin-top: auto; }
  .modal-backdrop { align-items: flex-end; padding: 0; }
  .deck-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: .75rem; }
  .card-num { font-size: 1.8rem; }
  .modal-header { padding: 1rem 1.1rem; }
  .modal-deck-num { font-size: 1.5rem; }
  .viewer-hint { left: 10px; bottom: 10px; font-size: .74rem; }
}

@media (prefers-reduced-motion: reduce) {
  .plan-viewer::before,
  .plan-viewer::after { animation: none !important; }
  .modal { transition: none !important; }
}
</style>
</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <a href="#" class="header-brand">
      <i class="fas fa-crown"></i>
      <div class="header-brand-text">
        <span class="header-brand-title">Royal Caribbean</span>
        <span class="header-brand-sub">Adventure of the Seas</span>
      </div>
    </a>
    <div class="header-spacer"></div>
    <span class="header-badge"><i class="fas fa-calendar-alt" style="margin-right:.4rem"></i>Feb 14–20, 2026</span>
  </div>
</header>

<section class="hero">
  <div class="hero-badge">
    <i class="fas fa-ship"></i>
    Adventure of the Seas · 13 Decks
  </div>
  <h1>Explore Every <em>Deck</em></h1>
  <p class="hero-sub">Find staterooms, restaurants, pools, and amenities across every level of the ship.</p>

  <div class="search-wrap">
    <i class="fas fa-search"></i>
    <input id="searchInput" type="search" placeholder="Search decks…" autocomplete="off" aria-label="Search decks">
    <button id="searchClear" hidden aria-label="Clear search"><i class="fas fa-times"></i></button>
  </div>
</section>

<section class="grid-section">
  <div class="grid-meta">
    <h2>Deck Plans</h2>
    <span id="gridCount" class="grid-count">0 of 0</span>
  </div>
  <div id="deckGrid" class="deck-grid"></div>
</section>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalDeckName">
  <div class="modal">

    <header class="modal-header">
      <div class="modal-header-info">
        <div id="modalDeckNum" class="modal-deck-num"></div>
        <div id="modalDeckName" class="modal-deck-name"></div>
      </div>
      <div class="modal-nav">
        <button id="btnPrev" class="modal-nav-btn" aria-label="Previous deck"><i class="fas fa-chevron-left"></i></button>
        <button id="btnNext" class="modal-nav-btn" aria-label="Next deck"><i class="fas fa-chevron-right"></i></button>
      </div>
      <button id="btnClose" class="modal-close" aria-label="Close"><i class="fas fa-times"></i></button>
    </header>

    <div class="plan-viewer">
      <div id="planLoader" class="plan-loader" aria-live="polite">
        <div class="spinner"></div>
        <span>Loading deck plan…</span>
      </div>

      <div id="planError" class="plan-error" aria-live="polite">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Deck plan unavailable.<br>The SVG file may not be uploaded yet.</p>
      </div>

      <div id="planStage" class="plan-stage" aria-label="Deck plan viewer">
        <div class="plan-frame" aria-hidden="true"></div>
        <div id="planCanvas" class="plan-canvas" aria-hidden="true">
          <div id="planContent" class="plan-content"></div>
        </div>
        <div class="viewer-hint" aria-hidden="true">
          <i class="fas fa-hand-pointer"></i>
          Drag to pan · Pinch/Scroll to zoom · Double-tap to zoom
        </div>
      </div>
    </div>

    <div class="zoom-bar">
      <button id="zoomOut" class="zoom-btn" aria-label="Zoom out"><i class="fas fa-minus"></i></button>
      <span id="zoomLabel" class="zoom-label">100%</span>
      <button id="zoomIn" class="zoom-btn" aria-label="Zoom in"><i class="fas fa-plus"></i></button>
      <div class="zoom-divider" aria-hidden="true"></div>
      <button id="zoomFit" class="zoom-btn" aria-label="Fit to screen"><i class="fas fa-expand"></i></button>
      <button id="zoomReset" class="zoom-btn" aria-label="Reset zoom"><i class="fas fa-compress-arrows-alt"></i></button>
    </div>

  </div>
</div>

<script>
(() => {
  'use strict';

  const DECKS = [
    {n:15, name: "Deck 15", hint: "Sports Deck"},
    {n:14, name: "Deck 14", hint: "Pool & Solarium"},
    {n:13, name: "Deck 13", hint: "Lido"},
    {n:12, name: "Deck 12", hint: "Cabins"},
    {n:11, name: "Deck 11", hint: "Cabins"},
    {n:10, name: "Deck 10", hint: "Cabins"},
    {n:9,  name: "Deck 9",  hint: "Cabins"},
    {n:8,  name: "Deck 8",  hint: "Cabins"},
    {n:7,  name: "Deck 7",  hint: "Cabins"},
    {n:6,  name: "Deck 6",  hint: "Promenade"},
    {n:5,  name: "Deck 5",  hint: "Dining"},
    {n:4,  name: "Deck 4",  hint: "Entertainment"},
    {n:3,  name: "Deck 3",  hint: "Lobby"},
    {n:2,  name: "Deck 2",  hint: "Medical"}
  ];

  const CFG = {
    minZoom: Number(getComputedStyle(document.documentElement).getPropertyValue('--min-zoom').trim()) || 0.65,
    maxZoom: Number(getComputedStyle(document.documentElement).getPropertyValue('--max-zoom').trim()) || 6,
    zoomStep: 0.18,
    zoomDbl: 1.65,
    inertiaFriction: 0.92,
    inertiaStop: 0.18,
  };

function svgPath(n) {
  const pad = String(n).padStart(2, '0');
  return new URL(`decks/deck-${pad}-final.min.svg`, window.location.href).href;
}

  let filtered = [...DECKS];
  let currentIdx = 0;

  let scale = 1;
  let tx = 0;
  let ty = 0;

  let contentW = 0;
  let contentH = 0;

  const pointers = new Map();
  let isPanning = false;
  let lastPan = { x: 0, y: 0, t: 0 };
  let velocity = { x: 0, y: 0 };
  let inertiaRaf = 0;

  let pinchInit = null;
  let lastTap = { t: 0, x: 0, y: 0 };

  const grid         = document.getElementById('deckGrid');
  const gridCount    = document.getElementById('gridCount');
  const searchInput  = document.getElementById('searchInput');
  const searchClear  = document.getElementById('searchClear');

  const backdrop     = document.getElementById('modalBackdrop');
  const modalNum     = document.getElementById('modalDeckNum');
  const modalName    = document.getElementById('modalDeckName');

  const planStage    = document.getElementById('planStage');
  const planCanvas   = document.getElementById('planCanvas');
  const planContent  = document.getElementById('planContent');

  const planLoader   = document.getElementById('planLoader');
  const planError    = document.getElementById('planError');

  const btnClose     = document.getElementById('btnClose');
  const btnPrev      = document.getElementById('btnPrev');
  const btnNext      = document.getElementById('btnNext');

  const zoomInBtn    = document.getElementById('zoomIn');
  const zoomOutBtn   = document.getElementById('zoomOut');
  const zoomFitBtn   = document.getElementById('zoomFit');
  const zoomResetBtn = document.getElementById('zoomReset');
  const zoomLabel    = document.getElementById('zoomLabel');

  if (!grid || !gridCount || !searchInput || !searchClear || !backdrop || !planStage || !planContent) {
    console.error('[DeckNavigator] Missing required DOM elements.');
    return;
  }

  function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
  function nowMs() { return performance.now(); }
  function stageRect() { return planCanvas.getBoundingClientRect(); }

  function setLoader(loading) {
    planLoader.style.display = loading ? 'flex' : 'none';
    planError.style.display = 'none';
  }
  function setError() {
    planLoader.style.display = 'none';
    planError.style.display = 'flex';
  }
  function setZoomLabel() {
    zoomLabel.textContent = `${Math.round(scale * 100)}%`;
  }
  function stopInertia() {
    if (inertiaRaf) cancelAnimationFrame(inertiaRaf);
    inertiaRaf = 0;
  }
  function applyTransform() {
    planContent.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(${scale})`;
    setZoomLabel();
  }

  function computeFitTransform() {
    const r = stageRect();
    const vw = Math.max(1, r.width);
    const vh = Math.max(1, r.height);
    const cw = Math.max(1, contentW);
    const ch = Math.max(1, contentH);

    const s = clamp(Math.min(vw / cw, vh / ch), CFG.minZoom, CFG.maxZoom);
    const cx = (vw - cw * s) / 2;
    const cy = (vh - ch * s) / 2;
    return { s, x: cx, y: cy };
  }

  function clampToBounds() {
    const r = stageRect();
    const vw = Math.max(1, r.width);
    const vh = Math.max(1, r.height);

    const cw = Math.max(1, contentW * scale);
    const ch = Math.max(1, contentH * scale);

    const margin = Math.min(110, Math.max(28, Math.round(Math.min(vw, vh) * 0.08)));

    if (cw <= vw) tx = (vw - cw) / 2;
    else {
      const minX = vw - cw - margin;
      const maxX = margin;
      tx = clamp(tx, minX, maxX);
    }

    if (ch <= vh) ty = (vh - ch) / 2;
    else {
      const minY = vh - ch - margin;
      const maxY = margin;
      ty = clamp(ty, minY, maxY);
    }
  }

  function zoomAboutScreenPoint(screenX, screenY, newScale) {
    const r = stageRect();
    const px = screenX - r.left;
    const py = screenY - r.top;

    const wx = (px - tx) / scale;
    const wy = (py - ty) / scale;

    scale = newScale;
    tx = px - wx * scale;
    ty = py - wy * scale;

    clampToBounds();
    applyTransform();
  }

  function zoomBy(deltaSteps, screenX, screenY) {
    const factor = Math.pow(1 + CFG.zoomStep, deltaSteps);
    const newScale = clamp(scale * factor, CFG.minZoom, CFG.maxZoom);
    zoomAboutScreenPoint(screenX, screenY, newScale);
  }

  function fitToScreen() {
    const fit = computeFitTransform();
    scale = fit.s;
    tx = fit.x;
    ty = fit.y;
    stopInertia();
    applyTransform();
  }

  function resetView() {
    fitToScreen();
    if (scale > 1.15) {
      const r = stageRect();
      zoomAboutScreenPoint(r.left + r.width / 2, r.top + r.height / 2, 1);
    }
  }

  function renderGrid(list) {
    filtered = list;
    grid.innerHTML = '';
    gridCount.textContent = `${list.length} of ${DECKS.length}`;

    if (!list.length) {
      grid.innerHTML = `<div class="empty-state">
        <i class="fas fa-search"></i>
        <p>No decks match your search.</p>
      </div>`;
      return;
    }

    list.forEach((deck, i) => {
      const card = document.createElement('div');
      card.className = 'deck-card';
      card.setAttribute('role', 'button');
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', `Open ${deck.name}`);
      card.innerHTML = `
        <div class="card-num">${deck.n}</div>
        <div class="card-name">${deck.name}</div>
        <div class="card-hint"><i class="fas fa-map-pin"></i>${deck.hint}</div>
        <div class="card-arrow"><i class="fas fa-arrow-right"></i></div>
      `;
      card.addEventListener('click', () => openModal(i));
      card.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModal(i); }
      });
      grid.appendChild(card);
    });
  }

  function openModal(idx) {
    currentIdx = idx;
    backdrop.classList.add('is-open');
    document.body.style.overflow = 'hidden';
    loadDeck();
  }

  function closeModal() {
    backdrop.classList.remove('is-open');
    document.body.style.overflow = '';
    stopInertia();
    pointers.clear();
    isPanning = false;
    pinchInit = null;
    planContent.innerHTML = '';
    planContent.style.transform = '';
    contentW = 0; contentH = 0;
  }

  function updateNavButtons() {
    btnPrev.disabled = currentIdx === 0;
    btnNext.disabled = currentIdx === filtered.length - 1;
  }

  async function loadDeck() {
    const deck = filtered[currentIdx];
    modalNum.textContent  = `Deck ${deck.n}`;
    modalName.textContent = deck.hint;
    updateNavButtons();

    planContent.innerHTML = '';
    planError.style.display  = 'none';
    setLoader(true);

    stopInertia();
    pointers.clear();
    isPanning = false;
    pinchInit = null;

    try {
      const res = await fetch(svgPath(deck.n), { cache: 'force-cache' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const svgText = await res.text();

      const doc = new DOMParser().parseFromString(svgText, 'image/svg+xml');
      const svg = doc.querySelector('svg');
      if (!svg) throw new Error('No <svg> root found');

      if (!svg.getAttribute('viewBox')) {
        const wAttr = svg.getAttribute('width');
        const hAttr = svg.getAttribute('height');
        const w = wAttr ? parseFloat(String(wAttr).replace(/[a-z%]+/ig,'')) : NaN;
        const h = hAttr ? parseFloat(String(hAttr).replace(/[a-z%]+/ig,'')) : NaN;
        if (Number.isFinite(w) && Number.isFinite(h) && w > 0 && h > 0) {
          svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
        }
      }

      svg.removeAttribute('width');
      svg.removeAttribute('height');
      svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
      svg.setAttribute('aria-label', deck.name);
      svg.setAttribute('role', 'img');

      planContent.innerHTML = '';
      planContent.appendChild(document.importNode(svg, true));

      const vb = (svg.getAttribute('viewBox') || '').split(/\s+|,/).map(Number);
      if (vb.length === 4 && vb.every(Number.isFinite)) {
        contentW = vb[2];
        contentH = vb[3];
      } else {
        await new Promise(r => requestAnimationFrame(() => r()));
        const box = planContent.getBoundingClientRect();
        contentW = box.width;
        contentH = box.height;
      }

      setLoader(false);
      await new Promise(r => requestAnimationFrame(() => r()));
      fitToScreen();
      requestAnimationFrame(() => applyTransform());

    } catch (err) {
      console.warn('[DeckNavigator] SVG load failed:', err);
      setError();
    }
  }

  function startInertia() {
    stopInertia();
    function tick(t) {
      const dt = Math.max(1, t - (tick._t || t));
      tick._t = t;

      tx += velocity.x * dt;
      ty += velocity.y * dt;

      velocity.x *= Math.pow(CFG.inertiaFriction, dt / 16);
      velocity.y *= Math.pow(CFG.inertiaFriction, dt / 16);

      clampToBounds();
      applyTransform();

      const speed = Math.hypot(velocity.x, velocity.y);
      if (speed < CFG.inertiaStop) { inertiaRaf = 0; return; }
      inertiaRaf = requestAnimationFrame(tick);
    }
    inertiaRaf = requestAnimationFrame(tick);
  }

  function onPointerDown(e) {
    if (!backdrop.classList.contains('is-open')) return;
    if (!(e.target instanceof Element)) return;

    planStage.setPointerCapture?.(e.pointerId);
    pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
    stopInertia();

    if (pointers.size === 1) {
      isPanning = true;
      lastPan = { x: e.clientX, y: e.clientY, t: nowMs() };
      velocity = { x: 0, y: 0 };
    }

    if (pointers.size === 2) {
      const pts = Array.from(pointers.values());
      const d = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      pinchInit = { dist: d, scale };
      isPanning = false;
    }
  }

  function onPointerMove(e) {
    if (!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

    if (pointers.size === 1 && isPanning) {
      const prev = lastPan;
      const t = nowMs();
      const dt = Math.max(1, t - prev.t);
      const dx = e.clientX - prev.x;
      const dy = e.clientY - prev.y;

      tx += dx;
      ty += dy;

      velocity.x = dx / dt;
      velocity.y = dy / dt;

      lastPan = { x: e.clientX, y: e.clientY, t };
      clampToBounds();
      applyTransform();
    }

    if (pointers.size === 2 && pinchInit) {
      const pts = Array.from(pointers.values());
      const d = Math.hypot(pts[0].x - pts[1].x, pts[0].y - pts[1].y);
      const mid = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 };

      const ratio = d / Math.max(1, pinchInit.dist);
      const newScale = clamp(pinchInit.scale * ratio, CFG.minZoom, CFG.maxZoom);
      zoomAboutScreenPoint(mid.x, mid.y, newScale);
    }
  }

  function onPointerUp(e) {
    if (!pointers.has(e.pointerId)) return;
    pointers.delete(e.pointerId);

    if (pointers.size === 0) {
      if (isPanning) startInertia();
      isPanning = false;
      pinchInit = null;
      planStage.releasePointerCapture?.(e.pointerId);
      return;
    }

    if (pointers.size === 1) {
      const pt = pointers.values().next().value;
      isPanning = true;
      lastPan = { x: pt.x, y: pt.y, t: nowMs() };
      pinchInit = null;
    }
  }

  function onWheel(e) {
    if (!backdrop.classList.contains('is-open')) return;
    e.preventDefault();
    const steps = clamp((-e.deltaY / 120), -3, 3);
    zoomBy(steps, e.clientX, e.clientY);
  }

  function onDblClick(e) {
    if (!backdrop.classList.contains('is-open')) return;
    zoomAboutScreenPoint(e.clientX, e.clientY, clamp(scale * CFG.zoomDbl, CFG.minZoom, CFG.maxZoom));
  }

  function onTouchTap(e) {
    if (!(e instanceof PointerEvent)) return;
    if (e.pointerType !== 'touch') return;

    const t = nowMs();
    const dt = t - lastTap.t;
    const dx = Math.abs(e.clientX - lastTap.x);
    const dy = Math.abs(e.clientY - lastTap.y);

    lastTap = { t, x: e.clientX, y: e.clientY };

    if (dt < 280 && dx < 26 && dy < 26) {
      zoomAboutScreenPoint(e.clientX, e.clientY, clamp(scale * CFG.zoomDbl, CFG.minZoom, CFG.maxZoom));
    }
  }

  searchInput.addEventListener('input', e => {
    const q = String(e.target.value || '').trim().toLowerCase();
    searchClear.hidden = !q;
    renderGrid(q
      ? DECKS.filter(d =>
          d.name.toLowerCase().includes(q) ||
          String(d.n).includes(q) ||
          (d.hint || "").toLowerCase().includes(q)
        )
      : [...DECKS]
    );
  });

  searchClear.addEventListener('click', () => {
    searchInput.value = '';
    searchClear.hidden = true;
    renderGrid([...DECKS]);
  });

  btnClose.addEventListener('click', closeModal);
  btnPrev.addEventListener('click',  () => { if (currentIdx > 0) { currentIdx--; loadDeck(); } });
  btnNext.addEventListener('click',  () => { if (currentIdx < filtered.length - 1) { currentIdx++; loadDeck(); } });

  zoomInBtn.addEventListener('click', () => {
    const r = stageRect();
    zoomAboutScreenPoint(r.left + r.width / 2, r.top + r.height / 2, clamp(scale * (1 + CFG.zoomStep), CFG.minZoom, CFG.maxZoom));
  });
  zoomOutBtn.addEventListener('click', () => {
    const r = stageRect();
    zoomAboutScreenPoint(r.left + r.width / 2, r.top + r.height / 2, clamp(scale / (1 + CFG.zoomStep), CFG.minZoom, CFG.maxZoom));
  });
  zoomFitBtn.addEventListener('click', fitToScreen);
  zoomResetBtn.addEventListener('click', resetView);

  backdrop.addEventListener('click', e => { if (e.target === backdrop) closeModal(); });

  document.addEventListener('keydown', e => {
    if (!backdrop.classList.contains('is-open')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') btnPrev.click();
    if (e.key === 'ArrowRight') btnNext.click();
    if (e.key === '+' || e.key === '=' ) zoomInBtn.click();
    if (e.key === '-' || e.key === '_' ) zoomOutBtn.click();
    if (e.key.toLowerCase() === 'f') zoomFitBtn.click();
    if (e.key.toLowerCase() === 'r') zoomResetBtn.click();
  });

  const ro = new ResizeObserver(() => {
    if (!backdrop.classList.contains('is-open')) return;
    if (!contentW || !contentH) return;
    clampToBounds();
    applyTransform();
  });
  ro.observe(planCanvas);

  planStage.addEventListener('pointerdown', (e) => { onTouchTap(e); onPointerDown(e); });
  planStage.addEventListener('pointermove', onPointerMove);
  planStage.addEventListener('pointerup', onPointerUp);
  planStage.addEventListener('pointercancel', onPointerUp);
  planStage.addEventListener('wheel', onWheel, { passive: false });
  planStage.addEventListener('dblclick', onDblClick);

  renderGrid([...DECKS]);
})();
</script>

</body>
</html>